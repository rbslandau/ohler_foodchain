---
title: "Land use changes biomass and temporal patterns of insect cross-ecosystem flows"
output:
  html_document:
    figure_caption: yes
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: '4'
  word_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80), tidy=TRUE)
```
# Load packages
```{r, message=FALSE, warning=FALSE}
library(dplyr) # Data wrangling
library(tidyr) # Data wrangling
library(plyr) # Data wrangling
library(data.table) # Data wrangling
library(reshape2) # Data wrangling
library(ggplot2) # plots
library(ggpubr) # plots
library(ggrepel) # plots
library(texreg) # export model output to html or latex
```
# Load data
You need to replace this line with a path on your computer
```{r, message=FALSE, warning=FALSE}
trait_data <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/stats_trait_data/trait_data.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = TRUE)

trait_data_diff <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/stats_trait_data/trait_data_diff.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = TRUE)

biomass_emergence_family_sample <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/stats_biomass_abundance_data/biomass_emergence_family_sample.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = TRUE)

biomass_emergence_order_sample <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/stats_biomass_abundance_data/biomass_emergence_order_sample.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = TRUE)

biomass_emergence_sample <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/stats_biomass_abundance_data/biomass_emergence_sample.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = TRUE)

data_env_1 <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/stats_land_use_related_drivers_data/data_env_1.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = TRUE)
```

# Paired t-test for trait data
## Check normality of differences
Load package
```{r, message=FALSE, warning=FALSE}
library(DAAG) # qreference
```
Generation time sensitive
```{r, message=FALSE, warning=FALSE}
trait_data_diff_wide <- dcast(trait_data_diff, stream ~ variable, value.var = c("difference_ratio"))
qreference(trait_data_diff_wide$sensitive, nrep = 8) # normality okay
```
Size
```{r, message=FALSE, warning=FALSE}
qreference(trait_data_diff_wide$small, nrep = 8) # normality okay
qreference(trait_data_diff_wide$medium, nrep = 8) # normality okay
qreference(trait_data_diff_wide$large, nrep = 8) # normality okay
```
## Conduct paired t-test
Generation time
```{r, message=FALSE, warning=FALSE}
t.test(trait_data$sensitive[trait_data$position == "vine"], trait_data$sensitive[trait_data$position == "forest"], paired = TRUE, var.equal = FALSE, conf.level = 0.95)
```
Size
```{r, message=FALSE, warning=FALSE}
t.test(trait_data$small[trait_data$position == "vine"], trait_data$small[trait_data$position == "forest"], paired = TRUE, var.equal = FALSE, conf.level = 0.95)

t.test(trait_data$medium[trait_data$position == "vine"], trait_data$medium[trait_data$position == "forest"], paired = TRUE, var.equal = FALSE, conf.level = 0.95)

t.test(trait_data$large[trait_data$position == "vine"], trait_data$large[trait_data$position == "forest"], paired = TRUE, var.equal = FALSE, conf.level = 0.95)
```      
## Calculate effect size 
* Cohen’s d for paired samples t-test 

$$ d = { \frac {mean(difference)} {sd(difference)}} $$
```{r, message=FALSE, warning=FALSE}
cohens_d <- ddply(trait_data_diff, c("variable"), summarise, 
                  mean_diff = mean(difference_ratio), 
                  sd_diff = sd(difference_ratio))

cohens_d$cohens_d <- cohens_d$mean_diff/cohens_d$sd_diff
```
T-test conventional effect sizes, proposed by Cohen, are: 0.2 (small effect), 0.5 (moderate effect) and 0.8 (large effect).

# Turn-over with ANOSIM and Jaccard index (JI)
Get data
```{r, message=FALSE, warning=FALSE}
presence_absence <- biomass_emergence_family_sample
presence_absence <- filter(presence_absence, family !="")
```
Aggregate per Site 
```{r, message=FALSE, warning=FALSE}
presence_absence <- ddply(presence_absence, c("stream", "position", "order", "family"), summarise, number_sum = sum(number_area_day))
```
Get presence-absence
1 = presence
0 = absence
```{r, message=FALSE, warning=FALSE}
presence_absence$pa <- as.numeric(presence_absence$number_sum > 0)

presence_absence <- unite(presence_absence, "site", "stream", "position", sep ="_", remove = FALSE)
presence_absence <- select(presence_absence, -c("order", "number_sum"))
presence_absence <- dcast(presence_absence, site + stream + position  ~ family, value.var = c("pa"))

env_site <- select(presence_absence, c("site", "stream", "position"))
spec_site <- select(presence_absence, -c("site", "stream", "position"))
spec_ma_site <- as.matrix(spec_site)
```
Load package 
```{r, message=FALSE, warning=FALSE}
library(vegan)
```
ANOSIM
```{r, message=FALSE, warning=FALSE}
set.seed(222)
anosim <- anosim(spec_ma_site, env_site$position, distance = "jaccard")
summary(anosim)
plot(anosim)

set.seed(222)
anosim_stream <- anosim(spec_ma_site, env_site$stream, distance = "jaccard")
summary(anosim_stream)
plot(anosim_stream)
```
  
## Plot ANOSIM results
Function to calculate relationship between dimensions and stress
```{r, message=FALSE, warning=FALSE}
scree_values <- function(x, max, dist_meas) {
  xx <- as.matrix(x)
  scree.points <- NULL
  scree.temp <- 1
  for (i in 1:max)
  {
    sol.mds <- NULL
    sol.mds <- replicate(
      10, metaMDS(xx, k = i, trymax = 30, distance = dist_meas)$stress,
      simplify = TRUE
    )
    scree.points <- append(scree.points, sol.mds)
  }
  return(scree.points)
}
```

Get and plot relationship between dimensions and stress
* red line indicates threshold for good Stress1 value
* Choose 4 dimensions

```{r, message=FALSE, warning=FALSE}
scree.res <- scree_values(spec_ma_site, max = 10, dist_meas = "jaccard")

par(cex = 1.5, las = 1)
plot_vec <- as.vector(sapply(1:(length(scree.res) / 10), function(x) rep(x, 10), simplify = "vector"))
# prerequisite for plotting replicated runs of nmds
plot(plot_vec, scree.res, ylab = "Stress1", xlab = "dimensions")
lines(1:(length(scree.res) / 10), as.vector((by(scree.res, plot_vec, mean))))
abline(h = 0.10, col = "red")
```

### Run NMDS 
with Jaccard Index
```{r, message=FALSE, warning=FALSE}
#nmds <- metaMDS(spec_ma_site, k = 4, distance = "jaccard", autotransform = FALSE)
#saveRDS(nmds, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/nmds.rds")
nmds <- readRDS(file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/ANOSIM/nmds.rds")
```

Shepard diagram
* Non-metric fit is based on stress and calculated as R^2 = sqrt(1- S^2)
* Linear R^2 = explained variation of regression of observed distances against ordination distances
* Looks okay
```{r, message=FALSE, warning=FALSE}
stressplot(nmds)
```

### Plot NMDS
Prepare data for plotting
```{r, message=FALSE, warning=FALSE}
fam_scores <- as.data.frame(nmds$species)
fam_scores$family <- rownames(fam_scores)

sample_scores <-as.data.frame(nmds$points)
sample_scores <- cbind(sample_scores, env_site)
```

Add order to families
```{r, message=FALSE, warning=FALSE}
order <- select(biomass_emergence_family_sample, c("order", "family"))
order <- distinct(order)

fam_scores <- left_join(fam_scores, order, by = "family")
```

Chose only first three letters from families
```{r, message=FALSE, warning=FALSE}
fam_scores$fam <- regmatches(fam_scores$family, regexpr("^.{0,3}", fam_scores$family))

fam_scores[c(18,21),7] <- regmatches(fam_scores[c(18,21),5], 
                                  regexpr("^.{0,4}", fam_scores[c(18,21),5])) 

fam_scores[c(16, 26),7] <- regmatches(fam_scores[c(16, 26),5], 
                                  regexpr("^.{0,7}", fam_scores[c(16, 26),5]))

fam_scores[c(10),7] <- regmatches(fam_scores[c(10),5], 
                                  regexpr("^.{0,8}", fam_scores[c(10),5]))

```

Add colour to order
```{r, message=FALSE, warning=FALSE}
fam_scores$colour <- with(fam_scores, ifelse(order == "Diptera", "brown", 
                          ifelse(order == "Ephemeroptera", "cornflowerblue",
                                 ifelse( order == "Plecoptera", "darkolivegreen3",
                                         "blueviolet"))))
```

Vine in agriculture
```{r, message=FALSE, warning=FALSE}
sample_scores$position <- gsub("vine","agriculture", sample_scores$position)
sample_scores$position <- factor(sample_scores$position, levels = c("forest", "agriculture"))
```

Plot
```{r, message=FALSE, warning=FALSE}
nmds_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", 
      plot.title = element_text(size=20), legend.text = element_text(size=15),
      axis.text = element_text(size=15), axis.title = element_text(size=15),
      strip.text = element_text(size=15)) +
  labs(title = "Families between land use types", 
       x=expression(NMDS1),
       y=expression(NMDS2),
       shape ="") +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  scale_fill_manual(values=c("darkgreen", "blue")) + 
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = sample_scores, aes(x=MDS1, y=MDS2, col = position), 
                                          show.legend = TRUE, size=5, stroke = 1.5,
                                          alpha = 0.5) +
  geom_text_repel(data = fam_scores, aes(x = MDS1, y = MDS2, label = fam),
                  size = 3, max.overlaps = 16, col = fam_scores$colour, 
                  fontface = "bold")
  
#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/nmds_plot.png", width=5, height=5, units="in", res=300)
nmds_plot
#dev.off()
```

# HGAM for seasonality of biomass and number of aquatic emergent insects
For theoretical background see: Pedersen, E. J., Miller, D. L., Simpson, G. L., & Ross, N. (2019). https://doi.org/10.7717/peerj.6876

Used to show seasonal patterns in biomass and number of emergence
## Load packages
```{r, message=FALSE, warning=FALSE}
library(mgcv)
library(gratia)
```

## Gemeral patterns in forest and vine sites without order
### Biomass
* gaussian is no suitable distribution (too many zeros)

* The Tweedie distribution is a special case of an exponential distribution. It can have a cluster of data items at zero (called a “point mass”), which is particularly useful where there is a mixture of zeros and non-negative data points. Basically, if you see a histogram with a spike at zero, it’s a possible candidate to be fitted to a Tweedie model.

* Original References: Tweedie, M. C. K. (1984). An index which distinguishes between some important exponential families. In Statistics: Applications and New Directions. Proceedings of the Indian Statistical Institute Golden Jubilee International Conference. (Eds. J. K. Ghosh and J. Roy), pp. 579-604. Calcutta: Indian Statistical Institute.

* Fitted without global smoother

* position = land use

#### Similar group-level trends (shared penalty)
```{r, message=FALSE, warning=FALSE}
#bio_position_S <- gam(biomass_area_day_mg ~ s(day, position, bs = "fs")+
#            s(stream, bs = "re"),
#          data = biomass_emergence_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")

#save(bio_position_S, file="bio_position_S.RData")
load("//Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_biomass/bio_position_S.RData")

BIC(bio_position_S)
summary(bio_position_S)

draw(bio_position_S)

par(mfrow = c(2,2))
gam.check(bio_position_S)  # looks okay
par(mfrow = c(1,1))
```

#### Different group level-trends (individual penalties)
```{r, message=FALSE, warning=FALSE}
#bio_position_I <- gam(biomass_area_day_mg ~ s(day, by = position, bs = "cc")+
#             s(position, bs = "re")+
#             s(stream, bs = "re"),
#          data = biomass_emergence_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")

#save(bio_position_I, file="bio_position_I.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_biomass/bio_position_I.RData")

BIC(bio_position_S, bio_position_I) # bio_position_S is better model than models without similar group-level trends
#summary(bio_position_I)

#draw(bio_position_I)

#par(mfrow = c(2,2))
#gam.check(bio_position_I)  # looks okay
#par(mfrow = c(1,1))
```


#### Effect size: Difference between mean fit

Use difference between mean fit of vine and forest as effect size and calculate its 95 % CI

$$ CI_{95} = (X_{vine} - X_{forest}) ± 1.959964 \sqrt {\frac {\sigma_{vine}^2} {N_{vine}} + {\frac {\sigma_{forest}^2} {N_{forest}}}}$$


$$ se = \frac {\sigma} {\sqrt N}  $$


$$ se^2 = \frac {\sigma^2} {N}  $$



$$ CI_{95} = (X_{vine} - X_{forest}) ± 1.959964 \sqrt {se_{vine}^2 + se_{forest}^2}$$

Setup prediction data frame
```{r, message=FALSE, warning=FALSE}
bio_position_S_pred <- with(biomass_emergence_sample,
                      expand.grid(day=seq(min(day), max(day), length=100), stream=levels(stream), 
                      position=levels((position))))
```
Make the prediction, add this and a column of standard errors to the prediction data.frame
```{r, message=FALSE, warning=FALSE}
bio_position_S_pred <- cbind(bio_position_S_pred,
                       predict(bio_position_S, 
                               bio_position_S_pred, 
                               se.fit=TRUE,
                               type="response",
                               exclude = "s(stream)"))
```
For every day streams at same position have same fit and se.fit. So extract information of only one stream for further processing.
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat <- filter(bio_position_S_pred, stream == "Dierbach")
```
Put table into needed format
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat_fit <- dcast(bio_position_S_stat, day + stream ~ position, value.var="fit")
names(bio_position_S_stat_fit)[3:4] <- c("fit_forest", "fit_vine")

bio_position_S_stat_se <- dcast(bio_position_S_stat, day + stream ~ position, value.var="se.fit")
names(bio_position_S_stat_se)[3:4] <- c("se_forest", "se_vine")

bio_position_S_stat <- left_join(bio_position_S_stat_fit, bio_position_S_stat_se, by = c("day", "stream"))
```
Add critical value for 95 % CI
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat$crit <- with(bio_position_S_stat, 1.959964)
```
Calculate difference between fit of vine and forest
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat$diff_v_f <- with(bio_position_S_stat, fit_vine - fit_forest)
```
Calculate sum of se.fit^2
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat$sum_v_f <- with(bio_position_S_stat, (se_vine^2) + (se_forest^2))
```
Calculate sqrt of sum_v_f
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat$sqrt_v_f <- with(bio_position_S_stat, sqrt(sum_v_f))
```
Calculate upper CI
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat$upper <- with(bio_position_S_stat, diff_v_f + crit*sqrt_v_f)
```
Calculate lower CI
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat$lower <- with(bio_position_S_stat, diff_v_f - crit*sqrt_v_f)
```
Check if CI includes 0
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat$sig <- with(bio_position_S_stat,between(0, lower, upper)) # True means 0 included in CI, so not significant
bio_position_S_stat$sig <- gsub("FALSE","significant", bio_position_S_stat$sig)
```

#### Plot biomass part of Fig. 1
Put table in needed format
```{r, message=FALSE, warning=FALSE}
bio_position_S_stat <- melt(bio_position_S_stat, id.vars = c("day", "crit", "diff_v_f", "sum_v_f", "sqrt_v_f","sig", "upper", "lower","stream"))

bio_position_S_stat <- separate(bio_position_S_stat, variable, into = c("variable", "position"))

bio_position_S_stat <- dcast(bio_position_S_stat, day + crit + diff_v_f + sum_v_f + sqrt_v_f + sig + upper + lower + stream + position ~ variable, value.var="value")

bio_position_S_stat$position <- gsub("vine","agriculture", bio_position_S_stat$position)
bio_position_S_stat$position <- factor(bio_position_S_stat$position, levels = c("forest", "agriculture"))

bio_position_S_stat_sig <- filter(bio_position_S_stat, sig == "significant")
```
Plot
```{r, message=FALSE, warning=FALSE}
bio_position_S_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size=15), axis.title = element_text(size=15)) +
    guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_ribbon(data=bio_position_S_stat, aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  geom_line(data=bio_position_S_stat, aes(x=day, y=fit, col = position)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data =bio_position_S_stat_sig, aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Total biomass", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 21, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 21, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 21, label = "autumn", size = 6)
  
bio_position_S_plot
```

#### Get values for paper
Range difference, min and max biomass per position
```{r, message=FALSE, warning=FALSE}
range(bio_position_S_stat_sig[1:18,]$diff_v_f) # 1.738935 7.255726
range(bio_position_S_stat_sig[19:26,]$diff_v_f) # 3.721289 4.305724

ddply(bio_position_S_stat, c("position"), summarise, mean_fit = mean(fit), min_fit = min(fit), max_fit = max(fit))
```
Estimate export per area in whole sampling period
```{r, message=FALSE, warning=FALSE}
export_bio <- ddply(bio_position_S_stat, c("position"), summarise, biomass_area_day_sum = sum(fit, na.rm = TRUE), biomass_area_day_mean = mean(fit, na.rm = TRUE), biomass_area_day_sd = sd(fit, na.rm = TRUE))

export_bio$N <- 100

export_bio$days <- with(bio_position_S_stat, max(bio_position_S_stat$day) - min(bio_position_S_stat$day))

export_bio$biomass_area_mg_sum <- with(export_bio, biomass_area_day_sum*days)
export_bio$biomass_area_kg_sum <- with(export_bio, round(biomass_area_mg_sum*10^-6, digits = 3))

export_bio$biomass_area_mg_mean <- with(export_bio, biomass_area_day_mean*days)

export_bio$biomass_area_mg_sd <- with(export_bio, biomass_area_day_sd*days)
```
Calculate 95 % CI of export

We need CI of sum, which is the same as CI of mean multiplied by the number of observations (N)

$ \sigma $: standard deviation

$$ CI_{95} = (mean ± 1.959964 \cdot {\sigma \over \sqrt N}) \cdot N $$
```{r, message=FALSE, warning=FALSE}
export_bio$upper_CI_mg <- with(export_bio, (biomass_area_mg_mean + 1.959964 * biomass_area_mg_sd/sqrt(N))*N)
export_bio$upper_CI_kg <- with(export_bio, round(upper_CI_mg*10^-6, digits = 3))


export_bio$lower_CI_mg <- with(export_bio, (biomass_area_mg_mean - 1.959964 * biomass_area_mg_sd/sqrt(N))*N)
export_bio$lower_CI_kg <- with(export_bio, round(lower_CI_mg*10^-6, digits = 3))
```

### Number
#### Similar group-level trends (shared penalty)
```{r, message=FALSE, warning=FALSE}
#num_position_S <- gam(number_area_day ~ s(day, position, bs = "fs")+
#            s(stream, bs = "re"),
#          data = biomass_emergence_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")

# save(num_position_S, file="num_position_S.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_abundance/num_position_S.RData")

BIC(num_position_S)

summary(num_position_S)

draw(num_position_S)

par(mfrow = c(2,2))
gam.check(num_position_S)  # looks okay
par(mfrow = c(1,1))
```
#### Different group level-trends (individual penalties)
```{r, message=FALSE, warning=FALSE}
#num_position_I <- gam(number_area_day ~ s(day, by = position, bs = "cc")+
#             s(position, bs = "re")+
#            s(stream, bs = "re"),
#          data = biomass_emergence_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")
#save(num_position_I, file="num_position_I.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_abundance/num_position_I.RData")

BIC(num_position_S, num_position_I) # num_position_S is better model than models without similar group-level trends

#summary(num_position_I)

#draw(num_position_I)

#par(mfrow = c(2,2))
#gam.check(num_position_I)  # looks okay
#par(mfrow = c(1,1))
```

#### Effect size: Difference between mean fit
Use difference between mean fit of vine and forest as effect size and calculate its 95 % CI

Setup prediction data frame
```{r, message=FALSE, warning=FALSE}
num_position_S_pred <- with(biomass_emergence_sample,
                      expand.grid(day=seq(min(day), max(day), length=100), stream=levels(stream), 
                      position=levels((position))))
```
Make the prediction, add this and a column of standard errors to the prediction data.frame
```{r, message=FALSE, warning=FALSE}
num_position_S_pred <- cbind(num_position_S_pred,
                       predict(num_position_S, 
                               num_position_S_pred, 
                               se.fit=TRUE,
                               type="response",
                               exclude = "s(stream)"))
```
For every day streams at same position have same fit and se.fit. So extract information of only one stream for further processing.
```{r, message=FALSE, warning=FALSE}
num_position_S_stat <- filter(num_position_S_pred, stream == "Dierbach")
```
Put table into needed format
```{r, message=FALSE, warning=FALSE}
num_position_S_stat_fit <- dcast(num_position_S_stat, day + stream ~ position, value.var="fit")
names(num_position_S_stat_fit)[3:4] <- c("fit_forest", "fit_vine")

num_position_S_stat_se <- dcast(num_position_S_stat, day + stream ~ position, value.var="se.fit")
names(num_position_S_stat_se)[3:4] <- c("se_forest", "se_vine")

num_position_S_stat <- left_join(num_position_S_stat_fit, num_position_S_stat_se, by = c("day", "stream"))
```
Add critical value for 95 % CI
```{r, message=FALSE, warning=FALSE}
num_position_S_stat$crit <- with(num_position_S_stat, 1.959964)
```
Calculate difference between fit of vine and forest
```{r, message=FALSE, warning=FALSE}
num_position_S_stat$diff_v_f <- with(num_position_S_stat, fit_vine - fit_forest)
```
Calculate sum of se.fit^2
```{r, message=FALSE, warning=FALSE}
num_position_S_stat$sum_v_f <- with(num_position_S_stat, (se_vine^2) + (se_forest^2))
```
Calculate sqrt of sum_v_f
```{r, message=FALSE, warning=FALSE}
num_position_S_stat$sqrt_v_f <- with(num_position_S_stat, sqrt(sum_v_f))
```
Calculate upper CI
```{r, message=FALSE, warning=FALSE}
num_position_S_stat$upper <- with(num_position_S_stat, diff_v_f + crit*sqrt_v_f)
```
Calculate lower CI
```{r, message=FALSE, warning=FALSE}
num_position_S_stat$lower <- with(num_position_S_stat, diff_v_f - crit*sqrt_v_f)
```
Check if CI includes 0
```{r, message=FALSE, warning=FALSE}
num_position_S_stat$sig <- with(num_position_S_stat,between(0, lower, upper)) # True means 0 included in CI, so not significant
num_position_S_stat$sig <- gsub("FALSE","significant", num_position_S_stat$sig)
```

#### Plot Fig. 1
Put table in needed format
```{r, message=FALSE, warning=FALSE}
num_position_S_stat <- melt(num_position_S_stat, id.vars = c("day", "crit", "diff_v_f", "sum_v_f", "sqrt_v_f","sig", "upper", "lower","stream"))

num_position_S_stat <- separate(num_position_S_stat, variable, into = c("variable", "position"))

num_position_S_stat <- dcast(num_position_S_stat, day + crit + diff_v_f + sum_v_f + sqrt_v_f + sig + upper + lower + stream + position ~ variable, value.var="value")

num_position_S_stat$position <- gsub("vine","agriculture", num_position_S_stat$position)
num_position_S_stat$position <- factor(num_position_S_stat$position, levels = c("forest", "agriculture"))

num_position_S_stat_sig <- filter(num_position_S_stat, sig == "significant")
```

Plot
```{r, message=FALSE, warning=FALSE}
num_position_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size=15), axis.title = element_text(size=15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_ribbon(data=num_position_S_stat, aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  geom_line(data=num_position_S_stat, aes(x=day, y=fit, col = position)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
geom_point(data =num_position_S_stat_sig, aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Total abundance", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 90, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 90, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 90, label = "autumn", size = 6)
  
num_position_S_plot

gam_pos_plot <- ggarrange(bio_position_S_plot, num_position_S_plot, 
                  labels = c("(a)", "(b)"),
                  font.label = list(face = "bold"),
                  ncol = 2, nrow = 1, 
                  common.legend = TRUE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_pos.png", width=10, height=5, units="in", res=300)
gam_pos_plot
#dev.off()


#ggsave(filename = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_pos_1.png", gam_pos_plot, width = 10, height = 5, device="png", dpi=300)
```

#### Plot biomass and abundance with raw date

Rename vine and change order of factor
```{r, message=FALSE, warning=FALSE}
biomass_emergence_sample$position <- gsub("vine","agriculture", biomass_emergence_sample$position)
biomass_emergence_sample$position <- factor(biomass_emergence_sample$position, levels = c("forest", "agriculture"))
```

Plot
```{r, message=FALSE, warning=FALSE}
bio_position_S_plot_forest_raw <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", 
        plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size=15), axis.title = element_text(size=15), axis.text.x = element_blank(), axis.title.x = element_blank()) +
    guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_ribbon(data=bio_position_S_stat[bio_position_S_stat$position == "forest",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen"), aes(alpha = 0.1)) +
  geom_line(data=bio_position_S_stat[bio_position_S_stat$position == "forest",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  scale_color_manual(values=c("darkgreen")) +
  geom_point(data =bio_position_S_stat_sig[bio_position_S_stat_sig$position == "forest",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_point(data =biomass_emergence_sample[biomass_emergence_sample$position == "forest",], aes(x=day, y=biomass_area_day_mg, col = position), show.legend = FALSE, alpha = 0.2, size = 1) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Total biomass forest", 
       x=expression(),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 80, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 80, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 80, label = "autumn", size = 6)
  
bio_position_S_plot_forest_raw

bio_position_S_plot_agri_raw <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", 
        plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size=15), axis.title = element_text(size=15), axis.text.x = element_blank(), axis.title.x = element_blank()) +
    guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_ribbon(data=bio_position_S_stat[bio_position_S_stat$position == "agriculture",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("blue"), aes(alpha = 0.1)) +
  geom_line(data=bio_position_S_stat[bio_position_S_stat$position == "agriculture",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  scale_color_manual(values=c("blue")) +
  geom_point(data =bio_position_S_stat_sig[bio_position_S_stat_sig$position == "agriculture",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_point(data =biomass_emergence_sample[biomass_emergence_sample$position == "agriculture",], aes(x=day, y=biomass_area_day_mg, col = position), show.legend = FALSE, alpha = 0.2, size = 1) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "  Total biomass agriculture", 
       x=expression(),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 80, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 80, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 80, label = "autumn", size = 6)
  
bio_position_S_plot_agri_raw
```

Plot
```{r, message=FALSE, warning=FALSE}
num_position_S_plot_forest_raw <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size=15), axis.title = element_text(size=15)) +
    guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_ribbon(data=num_position_S_stat[num_position_S_stat$position == "forest",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen"), aes(alpha = 0.1)) +
  geom_line(data=num_position_S_stat[num_position_S_stat$position == "forest",], aes(x=day, y=fit, col = position)) +
  scale_color_manual(values=c("darkgreen")) +
  geom_point(data =num_position_S_stat_sig[num_position_S_stat_sig$position == "forest",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_point(data =biomass_emergence_sample[biomass_emergence_sample$position == "forest",], aes(x=day, y=number_area_day, col = position), show.legend = FALSE, alpha = 0.2, size = 1) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Total abundance forest", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 500, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 500, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 500, label = "autumn", size = 6)
  
num_position_S_plot_forest_raw

num_position_S_plot_agri_raw <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size=15), axis.title = element_text(size=15)) +
    guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_ribbon(data=num_position_S_stat[num_position_S_stat$position == "agriculture",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("blue"), aes(alpha = 0.1)) +
  geom_line(data=num_position_S_stat[num_position_S_stat$position == "agriculture",], aes(x=day, y=fit, col = position)) +
  scale_color_manual(values=c("blue")) +
  geom_point(data =num_position_S_stat_sig[num_position_S_stat_sig$position == "agriculture",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_point(data =biomass_emergence_sample[biomass_emergence_sample$position == "agriculture",], aes(x=day, y=number_area_day, col = position), show.legend = FALSE, alpha = 0.2, size = 1) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "  Total abundance agriculture", 
       x=expression(day ~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 500, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 500, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 500, label = "autumn", size = 6)
  
num_position_S_plot_agri_raw

gam_pos_plot_raw <- ggarrange(bio_position_S_plot_forest_raw,
                              bio_position_S_plot_agri_raw,
                          num_position_S_plot_forest_raw, num_position_S_plot_agri_raw, 
                  labels = c("(a)", "(b)", "(c)", "(d)"),
                  font.label = list(face = "bold"), 
                  ncol = 2, nrow = 2, 
                  common.legend = FALSE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_pos_raw.png", width=10, height=10, units="in", res=300)
gam_pos_plot_raw
#dev.off()
```

#### Get values for paper
Range difference, min and max biomass per position
```{r, message=FALSE, warning=FALSE}
range(num_position_S_stat_sig[1:29,]$diff_v_f) # spring:  6.639604 35.910009
range(num_position_S_stat_sig[30:62,]$diff_v_f) # summer: 9.311044 17.202652

ddply(num_position_S_stat, c("position"), summarise, mean_fit = mean(fit), min_fit = min(fit), max_fit = max(fit))
```
Estimate export per area in whole sampling period
```{r, message=FALSE, warning=FALSE}
export_num <- ddply(num_position_S_stat, c("position"), summarise, number_area_day_sum = sum(fit, na.rm = TRUE), number_area_day_mean = mean(fit, na.rm = TRUE), number_area_day_sd = sd(fit, na.rm = TRUE))

export_num$N <- 100

export_num$days <- with(bio_position_S_stat, max(num_position_S_stat$day) - min(num_position_S_stat$day))

export_num$number_area_sum <- with(export_num, round(number_area_day_sum*days, digits = 0))

export_num$number_area_mean <- with(export_num, round(number_area_day_mean*days, digits = 0))

export_num$number_area_sd <- with(export_num, round(number_area_day_sd*days, digits = 0))
```

Calculate 95 % CI of export
```{r, message=FALSE, warning=FALSE}
export_num$upper_CI <- with(export_num, round(((number_area_mean + 1.959964 * number_area_sd/sqrt(N))*N), digit = 0))

export_num$lower_CI_mg <- with(export_num, round(((number_area_mean - 1.959964 * number_area_sd/sqrt(N))*N), digit = 0))
```


## General patterns for order in vine/forest

* Fitted without global smoother

### Biomass
#### Similar group-level trends (shared penalty)
```{r, message=FALSE, warning=FALSE}
#bio_position_order_S <- gam(biomass_area_day_mg ~ s(day, pos_ord, bs = "fs") +
#            s(stream, bs = "re"),
#          data = biomass_emergence_order_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")

#save(bio_position_order_S, file="bio_position_order_S.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_biomass/bio_position_order_S.RData")

BIC(bio_position_order_S)

summary(bio_position_order_S)

draw(bio_position_order_S)

par(mfrow = c(2,2))
gam.check(bio_position_order_S)  # looks okay
par(mfrow = c(1,1))
```
#### Different group level-trends (individual penalties)
```{r, message=FALSE, warning=FALSE}
#bio_position_order_I <- gam(biomass_area_day_mg ~ s(day, by = pos_ord, bs = "cc")+
#           s(pos_ord, bs = "re")+
#            s(stream, bs = "re"),
#          data = biomass_emergence_order_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")

#save(bio_position_order_I, file="bio_position_order_I.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_biomass/bio_position_order_I.RData")

BIC(bio_position_order_S, bio_position_order_I) # bio_position_order_S better model

#summary(bio_position_order_I)

#draw(bio_position_order_I)

#par(mfrow = c(2,2))
#gam.check(bio_position_order_I)  # looks okay
#par(mfrow = c(1,1))
```

#### Effect size: Difference between mean fit
Use difference between mean fit of vine and forest as effect size and calculate its 95 % CI
Setup prediction data frame
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_pred <- with(biomass_emergence_order_sample,
                      expand.grid(day=seq(min(day), max(day), length= 100), pos_ord=levels(pos_ord), stream=levels(stream)))
```
Make the prediction, add this and a column of standard errors to the prediction data.frame
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_pred <- cbind(bio_position_order_S_pred,
                       predict(bio_position_order_S, 
                               bio_position_order_S_pred, 
                               se.fit=TRUE, 
                               type="response",
                               exclude = "s(stream)"))
```
For every day streams at same position have same fit and se.fit. So extract information of only one stream for further processing
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat <- filter(bio_position_order_S_pred, stream == "Dierbach")

bio_position_order_S_stat <- separate(bio_position_order_S_stat, pos_ord, into= c("position", "order"))
```
Put table into needed format
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat_fit <- dcast(bio_position_order_S_stat, day + stream + order ~ position, value.var="fit")
names(bio_position_order_S_stat_fit)[4:5] <- c("fit_forest", "fit_vine")

bio_position_order_S_stat_se <- dcast(bio_position_order_S_stat, day + stream + order ~ position, value.var="se.fit")
names(bio_position_order_S_stat_se)[4:5] <- c("se_forest", "se_vine")

bio_position_order_S_stat <- left_join(bio_position_order_S_stat_fit, bio_position_order_S_stat_se, by = c("day", "stream", "order"))
```
Add critical value for 95 % CI
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat$crit <- with(bio_position_order_S_stat, 1.959964)
```
Calculate difference between fit of vine and forest
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat$diff_v_f <- with(bio_position_order_S_stat, fit_vine - fit_forest)
```
Calculate sum of se.fit^2
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat$sum_v_f <- with(bio_position_order_S_stat, (se_vine^2) + (se_forest^2))
```
Calculate sqrt of sum_v_f
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat$sqrt_v_f <- with(bio_position_order_S_stat, sqrt(sum_v_f))
```
Calculate upper CI
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat$upper <- with(bio_position_order_S_stat, diff_v_f + crit*sqrt_v_f)
```
Calculate lower CI
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat$lower <- with(bio_position_order_S_stat, diff_v_f - crit*sqrt_v_f)
```
Check if CI includes 0
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat$sig <- with(bio_position_order_S_stat,between(0, lower, upper)) # True means 0 included in CI, so not significant
bio_position_order_S_stat$sig <- gsub("FALSE","significant", bio_position_order_S_stat$sig)
```

#### Plot Fig. 2
Put table in needed format
```{r, message=FALSE, warning=FALSE}
bio_position_order_S_stat <- melt(bio_position_order_S_stat, id.vars = c("day", "crit", "diff_v_f", "sum_v_f", "sqrt_v_f","sig", "upper", "lower","stream", "order"))

bio_position_order_S_stat <- separate(bio_position_order_S_stat, variable, into = c("variable", "position"))

bio_position_order_S_stat <- dcast(bio_position_order_S_stat, day + crit + diff_v_f + sum_v_f + sqrt_v_f + sig + upper + lower + stream + position + order ~ variable, value.var="value")

bio_position_order_S_stat$position <- gsub("vine","agriculture", bio_position_order_S_stat$position)
bio_position_order_S_stat$position <- factor(bio_position_order_S_stat$position, levels = c("forest", "agriculture"))

bio_position_order_S_stat_sig <- filter(bio_position_order_S_stat, sig == "significant")
```
Plot
```{r, message=FALSE, warning=FALSE}
bio_position_Diptera_S_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text.x = element_blank(), axis.title.x = element_blank(), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Diptera",], aes(col = position, x=day, y=fit)) +
  geom_ribbon(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Diptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_order_S_stat_sig[bio_position_order_S_stat_sig$order == "Diptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Flies (Diptera)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 13, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 13, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 13, label = "autumn", size = 6) 

bio_position_Ephemeroptera_S_plot <- ggplot() +
  theme_classic() + 
     theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text.x = element_blank(), axis.title.x = element_blank(), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15)) +
  geom_line(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Ephemeroptera",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Ephemeroptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_order_S_stat_sig[bio_position_order_S_stat_sig$order == "Ephemeroptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Mayflies (Ephemeroptera)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 13, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 13, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 13, label = "autumn", size = 6) 

bio_position_Plecoptera_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size=15), axis.title = element_text(size=15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Plecoptera",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Plecoptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_order_S_stat_sig[bio_position_order_S_stat_sig$order == "Plecoptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Stoneflies (Plecoptera)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 13, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 13, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 13, label = "autumn", size = 6) 

bio_position_Trichoptera_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Trichoptera",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_order_S_stat[bio_position_order_S_stat$order == "Trichoptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_order_S_stat_sig[bio_position_order_S_stat_sig$order == "Trichoptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Caddisflies (Trichoptera)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 13, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 13, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 13, label = "autumn", size = 6) 

plot_bio <- ggarrange(bio_position_Diptera_S_plot, bio_position_Ephemeroptera_S_plot, bio_position_Plecoptera_S_plot, bio_position_Trichoptera_S_plot,
                  labels = c("(a)", "(b)", "(c)", "(d)"),
                  font.label = list(face = "bold"),
                  ncol = 2, nrow = 2, 
                  common.legend = TRUE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_bio.png", width=10, height=10, units="in", res=300)
plot_bio
#dev.off()
```

#### Get values for paper
```{r, message=FALSE, warning=FALSE}
bio_position_dip_S_stat_sig <- filter(bio_position_order_S_stat_sig, order == "Diptera") 
range(bio_position_dip_S_stat_sig[1:15,]$diff_v_f) 
range(bio_position_dip_S_stat_sig[16:33,]$diff_v_f)

range(bio_position_order_S_stat_sig[bio_position_order_S_stat_sig$order == "Ephemeroptera",]$diff_v_f) 

range(bio_position_order_S_stat_sig[bio_position_order_S_stat_sig$order == "Plecoptera",]$diff_v_f) 

range(bio_position_order_S_stat_sig[bio_position_order_S_stat_sig$order == "Trichoptera",]$diff_v_f) 

ddply(bio_position_order_S_stat, c("position", "order"), summarise, mean_fit = mean(fit), min_fit = min(fit), max_fit = max(fit))
```

### Number
#### Similar group-level trends (shared penalty)
```{r, message=FALSE, warning=FALSE}
#num_position_order_S <- gam(number_area_day ~ s(day, pos_ord, bs = "fs")+
#            s(stream, bs = "re"),
#          data = biomass_emergence_order_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")

#save(num_position_order_S, file="num_position_order_S.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_abundance/num_position_order_S.RData")

BIC(num_position_order_S)

summary(num_position_order_S)

draw(num_position_order_S)

par(mfrow = c(2,2))
gam.check(num_position_order_S)  # looks okay
par(mfrow = c(1,1))
```
#### Different group level-trends (individual penalties)
```{r, message=FALSE, warning=FALSE}
#num_position_order_I <- gam(number_area_day ~ s(day, by = pos_ord, bs = "cc")+
#             s(pos_ord, bs = "re")+
#            s(stream, bs = "re"),
#          data = biomass_emergence_order_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "REML")

#save(num_position_order_I, file="num_position_order_I.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_abundance/num_position_order_I.RData")

BIC(num_position_order_S, num_position_order_I) # num_position_order_S better model

#summary(num_position_order_I)

#draw(num_position_order_I)

#par(mfrow = c(2,2))
#gam.check(num_position_order_I)  # looks okay
#par(mfrow = c(1,1))
```

#### Effect size: Difference between mean fit
Use difference between mean fit of vine and forest as effect size and calculate its 95 % CI
Setup prediction data frame
```{r, message=FALSE, warning=FALSE}
num_position_order_S_pred <- with(biomass_emergence_order_sample,
                      expand.grid(day=seq(min(day), max(day), length= 100), pos_ord=levels(pos_ord), stream=levels(stream)))
```
Make the prediction, add this and a column of standard errors to the prediction data.frame
```{r, message=FALSE, warning=FALSE}
num_position_order_S_pred <- cbind(num_position_order_S_pred,
                       predict(num_position_order_S, 
                               num_position_order_S_pred, 
                               se.fit=TRUE, 
                               type="response",
                               exclude = "s(stream)"))
```
For every day streams at same position have same fit and se.fit. So extract information of only one stream for further processing
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat <- filter(num_position_order_S_pred, stream == "Dierbach")

num_position_order_S_stat <- separate(num_position_order_S_stat, pos_ord, into= c("position", "order"))
```
Put table into needed format
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat_fit <- dcast(num_position_order_S_stat, day + stream + order ~ position, value.var="fit")
names(num_position_order_S_stat_fit)[4:5] <- c("fit_forest", "fit_vine")

num_position_order_S_stat_se <- dcast(num_position_order_S_stat, day + stream + order ~ position, value.var="se.fit")
names(num_position_order_S_stat_se)[4:5] <- c("se_forest", "se_vine")

num_position_order_S_stat <- left_join(num_position_order_S_stat_fit, num_position_order_S_stat_se, by = c("day", "stream", "order"))
```
Add critical value for 95 % CI
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat$crit <- with(num_position_order_S_stat, 1.959964)
```
Calculate difference between fit of vine and forest
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat$diff_v_f <- with(num_position_order_S_stat, fit_vine - fit_forest)
```
Calculate sum of se.fit^2
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat$sum_v_f <- with(num_position_order_S_stat, (se_vine^2) + (se_forest^2))
```
Calculate sqrt of sum_v_f
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat$sqrt_v_f <- with(num_position_order_S_stat, sqrt(sum_v_f))
```
Calculate upper CI
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat$upper <- with(num_position_order_S_stat, diff_v_f + crit*sqrt_v_f)
```
Calculate lower CI
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat$lower <- with(num_position_order_S_stat, diff_v_f - crit*sqrt_v_f)
```
Check if CI includes 0
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat$sig <- with(num_position_order_S_stat,between(0, lower, upper)) # True means 0 included in CI, so not significant
num_position_order_S_stat$sig <- gsub("FALSE","significant", num_position_order_S_stat$sig)
```
#### Plot Fig. 3
Put table in needed format
```{r, message=FALSE, warning=FALSE}
num_position_order_S_stat <- melt(num_position_order_S_stat, id.vars = c("day", "crit", "diff_v_f", "sum_v_f", "sqrt_v_f","sig", "upper", "lower","stream", "order"))

num_position_order_S_stat <- separate(num_position_order_S_stat, variable, into = c("variable", "position"))

num_position_order_S_stat <- dcast(num_position_order_S_stat, day + crit + diff_v_f + sum_v_f + sqrt_v_f + sig + upper + lower + stream + position + order ~ variable, value.var="value")

num_position_order_S_stat$position <- gsub("vine","agriculture", num_position_order_S_stat$position)
num_position_order_S_stat$position <- factor(num_position_order_S_stat$position, levels = c("forest", "agriculture"))

num_position_order_S_stat_sig <- filter(num_position_order_S_stat, sig == "significant")
```
Plot
```{r, message=FALSE, warning=FALSE}
num_position_Diptera_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text.x = element_blank(), axis.title.x = element_blank(), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_order_S_stat[num_position_order_S_stat$order == "Diptera",], aes(col = position, x=day, y=fit)) +
  geom_ribbon(data=num_position_order_S_stat[num_position_order_S_stat$order == "Diptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_order_S_stat_sig[num_position_order_S_stat_sig$order == "Diptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Flies (Diptera)", 
       x=expression(day~ of ~ the ~ year),
             y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 82, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 82, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 82, label = "autumn", size = 6) 

num_position_Ephemeroptera_S_plot <- ggplot() +
  theme_classic() + 
    theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), axis.text.x = element_blank(), axis.title.x = element_blank(), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_order_S_stat[num_position_order_S_stat$order == "Ephemeroptera",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_order_S_stat[num_position_order_S_stat$order == "Ephemeroptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_order_S_stat_sig[num_position_order_S_stat_sig$order == "Ephemeroptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Mayflies (Ephemeroptera)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 8.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 8.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 8.2, label = "autumn", size = 6) 
  
num_position_Plecoptera_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_order_S_stat[num_position_order_S_stat$order == "Plecoptera",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_order_S_stat[num_position_order_S_stat$order == "Plecoptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_order_S_stat_sig[num_position_order_S_stat_sig$order == "Plecoptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Stoneflies (Plecoptera)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 8.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 8.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 8.2, label = "autumn", size = 6) 

num_position_Trichoptera_S_plot <- ggplot() +
  theme_classic() + 
    theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_order_S_stat[num_position_order_S_stat$order == "Trichoptera",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_order_S_stat[num_position_order_S_stat$order == "Trichoptera",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_order_S_stat_sig[num_position_order_S_stat_sig$order == "Trichoptera",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Caddisflies (Trichoptera)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 8.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 8.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 8.2, label = "autumn", size = 6) 

plot_num <- ggarrange(num_position_Diptera_S_plot, num_position_Ephemeroptera_S_plot, num_position_Plecoptera_S_plot, num_position_Trichoptera_S_plot,
                  labels = c("(a)", "(b)", "(c)", "(d)"),
                  font.label = list(face = "bold"),
                  ncol = 2, nrow = 2, 
                  common.legend = TRUE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_num.png", width=10, height=10, units="in", res=300)
plot_num
#dev.off()
```

#### Get values for paper
```{r, message=FALSE, warning=FALSE}
num_position_dip_S_stat_sig <- filter(num_position_order_S_stat_sig, order == "Diptera")
range(num_position_dip_S_stat_sig[1:29,]$diff_v_f) 
range(num_position_dip_S_stat_sig[30:66,]$diff_v_f) 

num_position_eph_S_stat_sig <- filter(num_position_order_S_stat_sig, order == "Ephemeroptera")
range(num_position_eph_S_stat_sig[1:9,]$diff_v_f)
range(num_position_eph_S_stat_sig[10:14,]$diff_v_f) 
range(num_position_eph_S_stat_sig[15:26,]$diff_v_f)

range(num_position_order_S_stat_sig[num_position_order_S_stat_sig$order == "Plecoptera",]$diff_v_f)

range(num_position_order_S_stat_sig[num_position_order_S_stat_sig$order == "Trichoptera",]$diff_v_f) 

ddply(num_position_order_S_stat, c("position", "order"), summarise, mean_fit = mean(fit), min_fit = min(fit), max_fit = max(fit))
```


## General patterns for family in vine/forest

* Fitted without global smoother

### Biomass
#### Similar group-level trends (shared penalty)
```{r, message=FALSE, warning=FALSE}
# bio_position_family_S <- bam(biomass_area_day_mg ~ s(day, pos_fam, bs = "fs") +
#            s(stream, bs = "re"),
#          data = biomass_emergence_family_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#                    method = "fREML", discrete = TRUE) #bam with method = "fREML" and #discrete = TRUE to reduce run time

#save(bio_position_family_S, file="bio_position_family_S.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_biomass/bio_position_family_S.RData")

BIC(bio_position_family_S)

summary(bio_position_family_S)

draw(bio_position_family_S)

par(mfrow = c(2,2))
gam.check(bio_position_family_S)  # looks okay
par(mfrow = c(1,1))
```
#### Different group level-trends (individual penalties)
```{r, message=FALSE, warning=FALSE}
#bio_position_family_I <- bam(biomass_area_day_mg ~ s(day, by = pos_fam, bs = "cc")+
#           s(pos_fam, bs = "re")+
#           s(stream, bs = "re"),
#          data = biomass_emergence_family_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "fREML", discrete = TRUE)

#save(bio_position_family_I, file="bio_position_family_I.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_biomass/bio_position_family_I.RData")

BIC(bio_position_family_S, bio_position_family_I) # bio_position_family_S is better model

#summary(bio_position_family_I)

#draw(bio_position_family_I)

#par(mfrow = c(2,2))
#gam.check(bio_position_family_I)  # looks okay
#par(mfrow = c(1,1))
```

#### Effect size: Difference between mean fit
Use difference between mean fit of vine and forest as effect size and calculate its 95 % CI
Setup prediction data frame
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_pred <- with(biomass_emergence_family_sample,
                      expand.grid(day=seq(min(day), max(day), length= 100), pos_fam=levels(pos_fam), stream=levels(stream)))
```
Make the prediction, add this and a column of standard errors to the prediction data.frame
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_pred <- cbind(bio_position_family_S_pred,
                       predict(bio_position_family_S, 
                               bio_position_family_S_pred, 
                               se.fit=TRUE, 
                               type="response",
                               exclude = "s(stream)"))
```
For every day streams at same position have same fit and se.fit. So extract information of only one stream for further processing
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat <- filter(bio_position_family_S_pred, stream == "Dierbach")

bio_position_family_S_stat <- separate(bio_position_family_S_stat, pos_fam, into= c("position","order", "family"))
```

Put table into needed format
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat_fit <- dcast(bio_position_family_S_stat, day + stream + order + family ~ position, value.var="fit")
names(bio_position_family_S_stat_fit)[5:6] <- c("fit_forest", "fit_vine")

bio_position_family_S_stat_se <- dcast(bio_position_family_S_stat, day + stream + order + family ~ position, value.var="se.fit")
names(bio_position_family_S_stat_se)[5:6] <- c("se_forest", "se_vine")

bio_position_family_S_stat <- left_join(bio_position_family_S_stat_fit, bio_position_family_S_stat_se, by = c("day", "stream", "order", "family"))
```
Add critical value for 95 % CI
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat$crit <- with(bio_position_family_S_stat, 1.959964)
```
Calculate difference between fit of vine and forest
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat$diff_v_f <- with(bio_position_family_S_stat, fit_vine - fit_forest)
```
Calculate (sum of se.fit)^2
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat$sum_v_f <- with(bio_position_family_S_stat, (se_vine^2) + (se_forest^2))
```
Calculate sqrt of sum_v_f
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat$sqrt_v_f <- with(bio_position_family_S_stat, sqrt(sum_v_f))
```
Calculate upper CI
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat$upper <- with(bio_position_family_S_stat, diff_v_f + crit*sqrt_v_f)
```
Calculate lower CI
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat$lower <- with(bio_position_family_S_stat, diff_v_f - crit*sqrt_v_f)
```
Check if CI includes 0
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat$sig <- with(bio_position_family_S_stat,between(0, lower, upper)) # True means 0 included in CI, so not significant
bio_position_family_S_stat$sig <- gsub("FALSE","significant", bio_position_family_S_stat$sig)
```

#### Plot Fig. families
Put table in needed format
```{r, message=FALSE, warning=FALSE}
bio_position_family_S_stat <- melt(bio_position_family_S_stat, id.vars = c("day", "crit", "diff_v_f", "sum_v_f", "sqrt_v_f","sig", "upper", "lower","stream", "order", "family"))

bio_position_family_S_stat <- separate(bio_position_family_S_stat, variable, into = c("variable", "position"))

bio_position_family_S_stat <- dcast(bio_position_family_S_stat, day + crit + diff_v_f + sum_v_f + sqrt_v_f + sig + upper + lower + stream + position + order + family ~ variable, value.var="value")

bio_position_family_S_stat$position <- gsub("vine","agriculture", bio_position_family_S_stat$position)
bio_position_family_S_stat$position <- factor(bio_position_family_S_stat$position, levels = c("forest", "agriculture"))

bio_position_family_S_stat_sig <- filter(bio_position_family_S_stat, sig == "significant")
```

##### Plot Fig. Diptera
```{r, message=FALSE, warning=FALSE}
bio_position_Cer_fam_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ceratopogonidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ceratopogonidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Ceratopogonidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Biting midges (Ceratopogonidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.12, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.12, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.12, label = "autumn", size = 6)

bio_position_Cha_fam_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Chaoboridae",], aes(x=day, y=fit,col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Chaoboridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Chaoboridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Phantom midges (Chaoboridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 1.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1.2, label = "autumn", size = 6)

bio_position_Cul_fam_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Culicidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Culicidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Culicidae",]
, aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Mosquitoes (Culicidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.12, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.12, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.12, label = "autumn", size = 6)

bio_position_Dix_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Dixidae",], aes(x=day, y=fit,col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Dixidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Dixidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Meniscus midges (Dixidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 12, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 12, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 12, label = "autumn", size = 6) 

bio_position_Emp_fam_S_plot <- ggplot() +
  theme_classic() + 
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Empididae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Empididae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Empididae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Ballon/dagger flies (Empididae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 1.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1.2, label = "autumn", size = 6) 

bio_position_Lim_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Limoniidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Limoniidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Limoniidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Limoniid crane flies (Limoniidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 1.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1.2, label = "autumn", size = 6) 

bio_position_Psy_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Psychodidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Psychodidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Psychodidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Drain flies (Psychodidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 1.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1.2, label = "autumn", size = 6) 

bio_position_Pty_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=18), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ptychopteridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ptychopteridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Ptychopteridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Phantom crane flies (Ptychopteridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 1.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1.2, label = "autumn", size = 6) 

bio_position_Sim_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Simuliidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Simuliidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Simuliidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Black flies (Simuliidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 1.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1.2, label = "autumn", size = 6) 

bio_position_Tip_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Tipulidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Tipulidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Tipulidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Crane flies (Tipulidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 1.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1.2, label = "autumn", size = 6) 

bio_position_Chiro_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Chironomidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Chironomidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Chironomidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Non biting midges (Chironomidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 12, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 12, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 12, label = "autumn", size = 6)


plot_bio_Dip <- ggarrange(bio_position_Chiro_S_plot, bio_position_Dix_fam_S_plot, bio_position_Cha_fam_S_plot, bio_position_Lim_fam_S_plot, bio_position_Psy_fam_S_plot, bio_position_Pty_fam_S_plot, bio_position_Sim_fam_S_plot, bio_position_Tip_fam_S_plot, bio_position_Emp_fam_S_plot, bio_position_Cer_fam_S_plot, bio_position_Cul_fam_S_plot,
                  labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)",
                             "(i)", "(j)", "(k)"),
                  font.label = list(face = "bold"),
                  ncol = 3, nrow = 4, 
                  common.legend = TRUE, legend = "bottom", align = "h")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_bio_Dip.png", width=15, height=20, units="in", res=300)
plot_bio_Dip
#dev.off()
```
##### Plot Fig. Ephemeroptera
```{r, message=FALSE, warning=FALSE}
bio_position_Arthropleidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Arthropleidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Arthropleidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Arthropleidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Flatheaded mayflies (Arthropleidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

bio_position_Ephemerellidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ephemerellidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ephemerellidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Ephemerellidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Spiny crawler mayflies (Ephemerellidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.08, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.08, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.08, label = "autumn", size = 6)

bio_position_Ephemeridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ephemeridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Ephemeridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Ephemeridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Burrowing mayflies (Ephemeridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

bio_position_Heptageniidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Heptageniidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Heptageniidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Heptageniidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Stream mayflies (Heptageniidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

bio_position_Siphlonuridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Siphlonuridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Siphlonuridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Siphlonuridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Primitive minnow mayflies (Siphlonuridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.08, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.08, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.08, label = "autumn", size = 6)

bio_position_Baetidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Baetidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Baetidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Baetidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Small mayflies (Baetidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 8, label = "autumn", size = 6)


plot_bio_Eph <- ggarrange(bio_position_Baetidae_S_plot, bio_position_Arthropleidae_fam_S_plot, bio_position_Ephemeridae_fam_S_plot, bio_position_Heptageniidae_fam_S_plot, bio_position_Ephemerellidae_fam_S_plot, bio_position_Siphlonuridae_fam_S_plot,   
                  labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)"),
                  font.label = list(face = "bold"),
                  ncol = 3, nrow = 2, 
                  common.legend = TRUE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_bio_Eph.png", width=15, height=10, units="in", res=300)
plot_bio_Eph
#dev.off()
```
##### Plot Fig. Plecoptera
```{r, message=FALSE, warning=FALSE}
bio_position_Chloroperlidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Chloroperlidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Chloroperlidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Chloroperlidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Green stoneflies (Chloroperlidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.02, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.02, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.02, label = "autumn", size = 6)

bio_position_Leuctridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Leuctridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Leuctridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Leuctridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Needle flies (Leuctridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

bio_position_Nemouridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Nemouridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Nemouridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Nemouridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Spring stoneflies (Nemouridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

bio_position_Taeniopterygidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Taeniopterygidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Taeniopterygidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Taeniopterygidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Willow flies (Taeniopterygidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

plot_bio_Ple <- ggarrange(bio_position_Nemouridae_fam_S_plot, bio_position_Leuctridae_fam_S_plot, bio_position_Taeniopterygidae_fam_S_plot,  bio_position_Chloroperlidae_fam_S_plot,   
                  labels = c("(a)", "(b)", "(c)", "(d)"),
                  font.label = list(face = "bold"),
                  ncol = 2, nrow = 2, 
                  common.legend = TRUE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_bio_Ple.png", width=10, height=10, units="in", res=300)
plot_bio_Ple
#dev.off()
```

##### Plot Fig. Trichoptera
```{r, message=FALSE, warning=FALSE}
bio_position_Glossosomatidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Glossosomatidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Glossosomatidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Glossosomatidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Tortoise makers (Glossosomatidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.1, label = "autumn", size = 6)

bio_position_Goeridae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Goeridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Goeridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Goeridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Weighted case maker (Goeridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1, label = "autumn", size = 6)

bio_position_Hydroptilidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Hydroptilidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Hydroptilidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Hydroptilidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Micro caddisflies (Hydroptilidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1, label = "autumn", size = 6)

bio_position_Lepidostomatidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Lepidostomatidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Lepidostomatidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Lepidostomatidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Lepidostomatid case makers (Lepidostomatidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.1, label = "autumn", size = 6)

bio_position_Leptoceridae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Leptoceridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Leptoceridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Leptoceridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Long-horned caddisflies (Leptoceridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1, label = "autumn", size = 6)

bio_position_Limnephilidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Limnephilidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Limnephilidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Limnephilidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Northern caddisflies (Limnephilidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 10, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 10, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 10, label = "autumn", size = 6)

bio_position_Philopotamidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Philopotamidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Philopotamidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Philopotamidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Finger-net caddisflies (Philopotamidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.01, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.01, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.01, label = "autumn", size = 6)

bio_position_Phryganeidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Phryganeidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Phryganeidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Phryganeidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Large caddisflies (Phryganeidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.1, label = "autumn", size = 6)

bio_position_Psychomyiidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=15), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Psychomyiidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Psychomyiidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Psychomyiidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Tube-making caddisflies (Psychomyiidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.1, label = "autumn", size = 6)

bio_position_Rhyacophilidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Rhyacophilidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Rhyacophilidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Rhyacophilidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Primitive caddisflies (Rhyacophilidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1, label = "autumn", size = 6)

bio_position_Sericostomatidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Sericostomatidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Sericostomatidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Sericostomatidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Bushtailed caddisflies (Sericostomatidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 1, label = "autumn", size = 6)

bio_position_Uenoidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Uenoidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Uenoidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Uenoidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Stonecase caddisflies (Uenoidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.1, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.1, label = "autumn", size = 6)

bio_position_Hydropsychidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Hydropsychidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=bio_position_family_S_stat[bio_position_family_S_stat$family == "Hydropsychidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = bio_position_family_S_stat_sig[bio_position_family_S_stat_sig$family == "Hydropsychidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Net-spinning caddisflies (Hydropsychidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(biomass ~"("~mg~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 10, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 10, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 10, label = "autumn", size = 6)


plot_bio_Tri <- ggarrange(bio_position_Hydropsychidae_S_plot, bio_position_Limnephilidae_S_plot, bio_position_Hydroptilidae_S_plot, bio_position_Leptoceridae_S_plot, bio_position_Rhyacophilidae_S_plot, bio_position_Sericostomatidae_S_plot, bio_position_Glossosomatidae_S_plot, bio_position_Goeridae_S_plot, bio_position_Lepidostomatidae_S_plot, bio_position_Phryganeidae_S_plot, bio_position_Psychomyiidae_S_plot, bio_position_Uenoidae_S_plot, bio_position_Philopotamidae_S_plot,
   labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)", "(i)", "(j)",
              "(k)", "(l)", "(m)"),
   font.label = list(face = "bold"),
                  ncol = 3, nrow = 5,
                  common.legend = TRUE, legend = "bottom", align = "h")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_bio_Tri.png", width=15, height=25, units="in", res=300)
plot_bio_Tri
#dev.off()
```
#### Get values for paper
```{r, message=FALSE, warning=FALSE}
ddply(bio_position_family_S_stat, c("position", "order", "family"), summarise, max_fam = round(max(fit, na.rm = TRUE), digits = 2))
```

### Number
#### Similar group-level trends (shared penalty)
```{r, message=FALSE, warning=FALSE}
#num_position_family_S <- bam(number_area_day ~ s(day, pos_fam, bs = "fs") +
#           s(stream, bs = "re"),
#          data = biomass_emergence_family_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "fREML", discrete = TRUE)

#save(num_position_family_S, file="num_position_family_S.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_abundance/num_position_family_S.RData")

BIC(num_position_family_S)

summary(num_position_family_S)

draw(num_position_family_S)

par(mfrow = c(2,2))
gam.check(num_position_family_S)  # looks okay
par(mfrow = c(1,1))
```
#### Different group level-trends (individual penalties)
```{r, message=FALSE, warning=FALSE}
# num_position_family_I <- bam(number_area_day ~ s(day, by = pos_fam, bs = "cc")+
#            s(pos_fam, bs = "re")+
#            s(stream, bs = "re"),
#          data = biomass_emergence_family_sample,
#          family = tw(theta = NULL, link = "log",a=1.01,b=1.99),
#          method = "fREML", discrete = TRUE)

# save(num_position_family_I, file="num_position_family_I.RData")
load("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/HGAM_abundance/num_position_family_I.RData")

BIC(num_position_family_S, num_position_family_I) # num_position_family_S is better model

#summary(num_position_family_I)

#draw(num_position_family_I)

#par(mfrow = c(2,2))
#gam.check(num_position_family_I)  # looks okay
#par(mfrow = c(1,1))
```
#### Effect size: Difference between mean fit
Use difference between mean fit of vine and forest as effect size and calculate its 95 % CI
Setup prediction data frame
```{r, message=FALSE, warning=FALSE}
num_position_family_S_pred <- with(biomass_emergence_family_sample,
                      expand.grid(day=seq(min(day), max(day), length= 100), pos_fam=levels(pos_fam), stream=levels(stream)))
```
Make the prediction, add this and a column of standard errors to the prediction data.frame
```{r, message=FALSE, warning=FALSE}
num_position_family_S_pred <- cbind(num_position_family_S_pred,
                       predict(num_position_family_S, 
                               num_position_family_S_pred, 
                               se.fit=TRUE, 
                               type="response",
                               exclude = "s(stream)"))
```
For every day streams at same position have same fit and se.fit. So extract information of only one stream for further processing
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat <- filter(num_position_family_S_pred, stream == "Dierbach")

num_position_family_S_stat <- separate(num_position_family_S_stat, pos_fam, into= c("position","order", "family"))
```

```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat <- filter(num_position_family_S_pred, stream == "Dierbach")

num_position_family_S_stat <- separate(num_position_family_S_stat, pos_fam, into= c("position","order", "family"))
```
Put table into needed format
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat_fit <- dcast(num_position_family_S_stat, day + stream + order + family ~ position, value.var="fit")
names(num_position_family_S_stat_fit)[5:6] <- c("fit_forest", "fit_vine")

num_position_family_S_stat_se <- dcast(num_position_family_S_stat, day + stream + order + family ~ position, value.var="se.fit")
names(num_position_family_S_stat_se)[5:6] <- c("se_forest", "se_vine")

num_position_family_S_stat <- left_join(num_position_family_S_stat_fit, num_position_family_S_stat_se, by = c("day", "stream", "order", "family"))
```
Add critical value for 95 % CI
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat$crit <- with(num_position_family_S_stat, 1.959964)
```
Calculate difference between fit of vine and forest
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat$diff_v_f <- with(num_position_family_S_stat, fit_vine - fit_forest)
```
Calculate (sum of se.fit)^2
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat$sum_v_f <- with(num_position_family_S_stat, (se_vine^2) + (se_forest^2))
```
Calculate sqrt of sum_v_f
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat$sqrt_v_f <- with(num_position_family_S_stat, sqrt(sum_v_f))
```
Calculate upper CI
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat$upper <- with(num_position_family_S_stat, diff_v_f + crit*sqrt_v_f)
```
Calculate lower CI
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat$lower <- with(num_position_family_S_stat, diff_v_f - crit*sqrt_v_f)
```
Check if CI includes 0
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat$sig <- with(num_position_family_S_stat,between(0, lower, upper)) # True means 0 included in CI, so not significant
num_position_family_S_stat$sig <- gsub("FALSE","significant", num_position_family_S_stat$sig)
```

#### Plot Fig. families
Put table in needed format
```{r, message=FALSE, warning=FALSE}
num_position_family_S_stat <- melt(num_position_family_S_stat, id.vars = c("day", "crit", "diff_v_f", "sum_v_f", "sqrt_v_f","sig", "upper", "lower","stream", "order", "family"))

num_position_family_S_stat <- separate(num_position_family_S_stat, variable, into = c("variable", "position"))

num_position_family_S_stat <- dcast(num_position_family_S_stat, day + crit + diff_v_f + sum_v_f + sqrt_v_f + sig + upper + lower + stream + position + order + family ~ variable, value.var="value")

num_position_family_S_stat$position <- gsub("vine","agriculture", num_position_family_S_stat$position)
num_position_family_S_stat$position <- factor(num_position_family_S_stat$position, levels = c("forest", "agriculture"))

num_position_family_S_stat_sig <- filter(num_position_family_S_stat, sig == "significant")
```
##### Plot Fig. Diptera
```{r, message=FALSE, warning=FALSE}
num_position_Cer_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ceratopogonidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ceratopogonidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Ceratopogonidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
 labs(title = "Biting midges (Ceratopogonidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

num_position_Cha_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Chaoboridae",], aes(x=day, y=fit,col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Chaoboridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Chaoboridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Phantom midges (Chaoboridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 8, label = "autumn", size = 6)

num_position_Cul_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Culicidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Culicidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Culicidae",]
, aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
 labs(title = "Mosquitoes (Culicidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.08, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.08, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.08, label = "autumn", size = 6)

num_position_Dix_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Dixidae",], aes(x=day, y=fit,col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Dixidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Dixidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Meniscus midges (Dixidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

num_position_Emp_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Empididae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Empididae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Empididae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Ballon/dagger flies (Empididae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

num_position_Lim_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Limoniidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Limoniidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Limoniidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Limoniid crane flies (Limoniidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

num_position_Psy_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Psychodidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Psychodidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Psychodidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Drain flies (Psychodidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

num_position_Pty_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=18), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ptychopteridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ptychopteridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Ptychopteridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Phantom crane flies (Ptychopteridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

num_position_Sim_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Simuliidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Simuliidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Simuliidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Black flies (Simuliidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 8, label = "autumn", size = 6)

num_position_Tip_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Tipulidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Tipulidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Tipulidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Crane flies (Tipulidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.8, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.8, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.8, label = "autumn", size = 6)

num_position_Chiro_S_plot <- ggplot() +
  theme_classic() + 
 theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Chironomidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Chironomidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Chironomidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Non biting midges (Chironomidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 80, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 80, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 80, label = "autumn", size = 6)

plot_num_Dip <- ggarrange(num_position_Chiro_S_plot, num_position_Dix_fam_S_plot, num_position_Cha_fam_S_plot, num_position_Lim_fam_S_plot, num_position_Psy_fam_S_plot, num_position_Pty_fam_S_plot, num_position_Sim_fam_S_plot, num_position_Tip_fam_S_plot, num_position_Emp_fam_S_plot, num_position_Cer_fam_S_plot, num_position_Cul_fam_S_plot,
                  labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)",
                             "(i)", "(j)", "(k)"),
                  font.label = list(face = "bold"),
                  ncol = 3, nrow = 4, 
                  common.legend = TRUE, legend = "bottom", align = "h")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_num_Dip.png", width=15, height=20, units="in", res=300)
plot_num_Dip
#dev.off()
```
##### Plot Fig. Ephemeroptera
```{r, message=FALSE, warning=FALSE}
num_position_Arthropleidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Arthropleidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Arthropleidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Arthropleidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Flatheaded mayflies (Arthropleidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.04, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.04, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.04, label = "autumn", size = 6)

num_position_Ephemerellidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ephemerellidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ephemerellidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Ephemerellidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Spiny crawler mayflies (Ephemerellidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.04, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.04, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.04, label = "autumn", size = 6)

num_position_Ephemeridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ephemeridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Ephemeridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Ephemeridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Burrowing mayflies (Ephemeridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) + 
  annotate(geom = "text", x = 105, y = 0.04, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.04, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.04, label = "autumn", size = 6)

num_position_Heptageniidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Heptageniidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Heptageniidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Heptageniidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Stream mayflies (Heptageniidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.4, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.4, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.4, label = "autumn", size = 6)

num_position_Siphlonuridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Siphlonuridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Siphlonuridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Siphlonuridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Primitive minnow mayflies (Siphlonuridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.04, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.04, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.04, label = "autumn", size = 6)

num_position_Baetidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Baetidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Baetidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Baetidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Small mayflies (Baetidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 4, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 4, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 4, label = "autumn", size = 6)


plot_num_Eph <- ggarrange(num_position_Baetidae_S_plot, num_position_Arthropleidae_fam_S_plot, num_position_Ephemeridae_fam_S_plot, num_position_Heptageniidae_fam_S_plot, num_position_Ephemerellidae_fam_S_plot, num_position_Siphlonuridae_fam_S_plot,    
                  labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)"),
                  font.label = list(face = "bold"),
                  ncol = 3, nrow = 2, 
                  common.legend = TRUE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_num_Eph.png", width=15, height=10, units="in", res=300)
plot_num_Eph
#dev.off()
```
##### Plot Fig. Plecoptera
```{r, message=FALSE, warning=FALSE}
num_position_Chloroperlidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=19), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Chloroperlidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Chloroperlidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Chloroperlidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Green stoneflies (Chloroperlidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.02, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.02, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.02, label = "autumn", size = 6)

num_position_Leuctridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Leuctridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Leuctridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Leuctridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Needle flies (Leuctridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

num_position_Nemouridae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Nemouridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Nemouridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Nemouridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Spring stoneflies (Nemouridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

num_position_Taeniopterygidae_fam_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Taeniopterygidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Taeniopterygidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Taeniopterygidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Willow flies (Taeniopterygidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

plot_num_Ple <- ggarrange(num_position_Nemouridae_fam_S_plot, num_position_Leuctridae_fam_S_plot, num_position_Taeniopterygidae_fam_S_plot,  num_position_Chloroperlidae_fam_S_plot,   
                  labels = c("(a)", "(b)", "(c)", "(d)"),
                  font.label = list(face = "bold"),
                  ncol = 2, nrow = 2, 
                  common.legend = TRUE, legend = "bottom")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_num_Ple.png", width=10, height=10, units="in", res=300)
plot_num_Ple
#dev.off()
```

##### Plot Fig. Trichoptera
```{r, message=FALSE, warning=FALSE}
num_position_Glossosomatidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Glossosomatidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Glossosomatidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Glossosomatidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Tortoise makers (Glossosomatidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.02, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.02, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.02, label = "autumn", size = 6)

num_position_Goeridae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Goeridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Goeridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Goeridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Weighted case maker (Goeridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.2, label = "autumn", size = 6)

num_position_Hydroptilidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Hydroptilidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Hydroptilidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Hydroptilidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Micro caddisflies (Hydroptilidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

num_position_Lepidostomatidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Lepidostomatidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Lepidostomatidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Lepidostomatidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Lepidostomatid case makers (Lepidostomatidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.02, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.02, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.02, label = "autumn", size = 6)

num_position_Leptoceridae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Leptoceridae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Leptoceridae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Leptoceridae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Long-horned caddisflies (Leptoceridae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.25, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.25, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.25, label = "autumn", size = 6)

num_position_Limnephilidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Limnephilidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Limnephilidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Limnephilidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Northern caddisflies (Limnephilidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.2, label = "autumn", size = 6)

num_position_Philopotamidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Philopotamidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Philopotamidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Philopotamidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Finger-net caddisflies (Philopotamidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.02, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.02, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.02, label = "autumn", size = 6)

num_position_Phryganeidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Phryganeidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Phryganeidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Phryganeidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Large caddisflies (Phryganeidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.02, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.02, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.02, label = "autumn", size = 6)

num_position_Psychomyiidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Psychomyiidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Psychomyiidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Psychomyiidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Tube-making caddisflies (Psychomyiidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.2, label = "autumn", size = 6)

num_position_Rhyacophilidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Rhyacophilidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Rhyacophilidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
    scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Rhyacophilidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Primitive caddisflies (Rhyacophilidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.2, label = "autumn", size = 6)

num_position_Sericostomatidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Sericostomatidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Sericostomatidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Sericostomatidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Bushtailed caddisflies (Sericostomatidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.2, label = "autumn", size = 6)

num_position_Uenoidae_S_plot <- ggplot() +
  theme_classic() + 
theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text = element_text(size = 15), axis.title = element_text(size = 15)) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Uenoidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Uenoidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Uenoidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Stonecase caddisflies (Uenoidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 0.02, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 0.02, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 0.02, label = "autumn", size = 6)

num_position_Hydropsychidae_S_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=16), legend.text = element_text(size=20), 
        axis.text.y = element_text(size = 15), axis.title.y = element_text(size = 15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 5))) +
  geom_line(data=num_position_family_S_stat[num_position_family_S_stat$family == "Hydropsychidae",], aes(x=day, y=fit, col = position)) +
  geom_ribbon(data=num_position_family_S_stat[num_position_family_S_stat$family == "Hydropsychidae",], aes(x=day, y=fit, fill = position, ymin=(fit - 2*se), ymax=(fit + 2*se)), alpha = 0.1, show.legend = FALSE) +
  scale_fill_manual(values=c("darkgreen", "blue"), aes(alpha = 0.1)) +
  scale_color_manual(values=c("darkgreen", "blue")) +
  geom_point(data = num_position_family_S_stat_sig[num_position_family_S_stat_sig$family == "Hydropsychidae",], aes(x=day, y=fit, col = position), show.legend = FALSE) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") +
  labs(title = "Net-spinning caddisflies (Hydropsychidae)", 
       x=expression(day~ of ~ the ~ year),
       y=expression(abundance ~"("~ind~ ~m^-2~d^-1~")")) +
  annotate(geom = "text", x = 105, y = 2, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 2, label = "summer", size = 6) +
  annotate(geom = "text", x = 240, y = 2, label = "autumn", size = 6)

plot_num_Tri <- ggarrange(num_position_Hydropsychidae_S_plot, num_position_Limnephilidae_S_plot, num_position_Hydroptilidae_S_plot, num_position_Leptoceridae_S_plot, num_position_Rhyacophilidae_S_plot, num_position_Sericostomatidae_S_plot, num_position_Glossosomatidae_S_plot, num_position_Goeridae_S_plot, num_position_Lepidostomatidae_S_plot, num_position_Phryganeidae_S_plot, num_position_Psychomyiidae_S_plot, num_position_Uenoidae_S_plot, num_position_Philopotamidae_S_plot,
   labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)", "(i)", "(j)",
              "(k)", "(l)", "(m)"),
   font.label = list(face = "bold"),
                  ncol = 3, nrow = 5, 
                  common.legend = TRUE, legend = "bottom", align = "h")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/gam_plot_num_Tri.png", width=15, height=25, units="in", res=300)
plot_num_Tri
#dev.off()
```
#### Get values for paper
```{r, message=FALSE, warning=FALSE}
ddply(num_position_family_S_stat, c("position", "order", "family"), summarise, max_fam = round(max(fit, na.rm = TRUE), digits = 2))
```

## Get peaks and time difference peaks between land use type
Calculate discrete analogue of the second derivative
For order and family data you need to order rows by order and family, respectively
```{r, message =FALSE, warning= FALSE}
max_bio_pos <- which(diff(sign(diff(bio_position_S_stat$fit)))==-2)+1
max_num_pos <- which(diff(sign(diff(num_position_S_stat$fit)))==-2)+1

bio_position_order_S_stat <- arrange(bio_position_order_S_stat, desc(order))
max_bio_ord <- which(diff(sign(diff(bio_position_order_S_stat$fit)))==-2)+1
num_position_order_S_stat <- arrange(num_position_order_S_stat, desc(order))
max_num_ord <- which(diff(sign(diff(num_position_order_S_stat$fit)))==-2)+1

bio_position_family_S_stat <- arrange(bio_position_family_S_stat, desc(family))
max_bio_fam <- which(diff(sign(diff(bio_position_family_S_stat$fit)))==-2)+1
num_position_family_S_stat <- arrange(num_position_family_S_stat, desc(family))
max_num_fam <- which(diff(sign(diff(num_position_family_S_stat$fit)))==-2)+1
```
Get rows with maxima 
```{r, message =FALSE, warning= FALSE}
bio_position_S_stat$row <- rownames(bio_position_S_stat)
max_bio_pos <- filter(bio_position_S_stat, row %in% max_bio_pos)
bio_position_S_stat <- select(bio_position_S_stat, -c("row"))
 
num_position_S_stat$row <- rownames(num_position_S_stat)
max_num_pos <- filter(num_position_S_stat, row %in% max_num_pos)
num_position_S_stat <- select(num_position_S_stat, -c("row")) 

bio_position_order_S_stat$row <- rownames(bio_position_order_S_stat)
max_bio_ord <- filter(bio_position_order_S_stat, row %in% max_bio_ord)
bio_position_order_S_stat <- select(bio_position_order_S_stat, -c("row"))

num_position_order_S_stat$row <- rownames(num_position_order_S_stat)
max_num_ord <- filter(num_position_order_S_stat, row %in% max_num_ord)
num_position_order_S_stat <- select(num_position_order_S_stat, -c("row"))

bio_position_family_S_stat$row <- rownames(bio_position_family_S_stat)
max_bio_fam <- filter(bio_position_family_S_stat, row %in% max_bio_fam)
bio_position_family_S_stat <- select(bio_position_family_S_stat, -c("row"))

num_position_family_S_stat$row <- rownames(num_position_family_S_stat)
max_num_fam <- filter(num_position_family_S_stat, row %in% max_num_fam)
num_position_family_S_stat <- select(num_position_family_S_stat, -c("row"))
```
Chose needed columns
```{r, message =FALSE, warning= FALSE}
max_bio_pos <- select(max_bio_pos, c("position","day","fit","se"))
max_num_pos <- select(max_num_pos, c("position","day","fit","se"))

max_bio_ord <- select(max_bio_ord, c("position", "order", "day","fit","se"))
max_num_ord <- select(max_num_ord, c("position", "order", "day","fit","se"))

max_bio_fam <- select(max_bio_fam, c("position", "order", "family", "day","fit","se"))
max_num_fam <- select(max_num_fam, c("position", "order", "family", "day","fit","se"))
```
Remove values at day 256, which were the difference between two positions, orders or families (no real maximum, only chosen as maximum, because it was higher than first value (day 81) of next position/order/family)
```{r, message =FALSE, warning= FALSE}
max_bio_pos <- filter(max_bio_pos, day != 256)
max_num_pos <- filter(max_num_pos, day != 256)

max_bio_ord <- filter(max_bio_ord, day != 256)
max_num_ord <- filter(max_num_ord, day != 256)

max_bio_fam <- filter(max_bio_fam, day != 256)
max_num_fam <- filter(max_num_fam, day != 256)
```
Remove cases in family max., where emergence is actually 0
```{r, message =FALSE, warning= FALSE}
max_bio_fam$fit <- round(max_bio_fam$fit, digits= 2)
max_num_fam$fit <- round(max_num_fam$fit, digits= 2)

max_bio_fam <- filter(max_bio_fam, fit != 0)
max_num_fam <- filter(max_num_fam, fit != 0)
```

Numerate peaks
```{r, message =FALSE, warning= FALSE}
max_bio_pos$peak_no <- c(1:2, 1:2)
max_num_pos$peak_no <- c(1:3,1:3)

max_bio_ord$peak_no <- c(1,1:2,1,1,1:2,1,1:2,1:3)
max_num_ord$peak_no <- c(1,1,1,1,1:2,1:2,1:3,1:3)

count <- count(max_bio_fam, c("position","family")) 
max_bio_fam <- merge(max_bio_fam, count, by = c("position", "family"))
max_bio_fam$freq
max_bio_fam$peak_no <- c(1, 1:3, 1:3, 1:3, 1:2, 1, 1,1:3, 1:3, 1, 1:2, 1:3, 1:2, 
                         1:2, 1:4, 1:3, 1, 1:2, 1:2, 1:2, 1, 1:2, 1, 1:3,
                         1:2, 1:3, 1, 1:2, 1, 1:2, 1:2, 1, 1, 1:2, 1, 1, 1, 1, 1, 
                         1:4, 1, 1, 1:2, 1, 1:2, 1:2, 1:3, 1:3, 1, 1, 1:2, 1)

count <- count(max_num_fam, c("position","family")) 
max_num_fam <- merge(max_num_fam, count, by = c("position", "family"))
max_num_fam$freq
max_num_fam$peak_no <- c(1:2, 1:2, 1:2, 1:3, 1, 1:2, 1, 1, 1, 1:2, 1, 1, 1:2, 1, 
                         1:2, 1:2, 1, 1, 1:2, 1, 1, 1:2, 1:2, 1, 1:2, 1:3, 1, 1, 
                         1:2, 1, 1, 1, 1:2, 1, 1, 1, 1, 1, 1:2, 1, 1, 1, 1:2, 1, 1, 
                         1:3, 1:2, 1, 1)
```
Put tables in needed form
```{r, message =FALSE, warning= FALSE}
max_bio_pos <- dcast(max_bio_pos, peak_no ~ position, value.var = c("day"))
max_num_pos <- dcast(max_num_pos, peak_no ~ position, value.var = c("day"))

max_bio_ord <- dcast(max_bio_ord, order + peak_no ~ position, value.var = c("day"))
max_num_ord <- dcast(max_num_ord, order + peak_no ~ position, value.var = c("day"))

max_bio_fam <- dcast(max_bio_fam, order + family + peak_no ~ position, value.var = c("day"))
max_num_fam <- dcast(max_num_fam, order + family + peak_no ~ position, value.var = c("day"))
```
Get time difference between peaks
```{r, message =FALSE, warning= FALSE}
max_bio_pos$forest <- round(max_bio_pos$forest, digits = 0)
max_bio_pos$agriculture <- round(max_bio_pos$agriculture, digits = 0)
max_bio_pos$diff_day <- max_bio_pos$forest - max_bio_pos$agriculture

max_num_pos$forest <- round(max_num_pos$forest, digits = 0)
max_num_pos$agriculture <- round(max_num_pos$agriculture, digits = 0)
max_num_pos$diff_day <- max_num_pos$forest - max_num_pos$agriculture

max_bio_ord$forest <- round(max_bio_ord$forest, digits = 0)
max_bio_ord$agriculture <- round(max_bio_ord$agriculture, digits = 0)
max_bio_ord$diff_day <- max_bio_ord$forest - max_bio_ord$agriculture

max_num_ord$forest <- round(max_num_ord$forest, digits = 0)
max_num_ord$agriculture <- round(max_num_ord$agriculture, digits = 0)
max_num_ord$diff_day <- max_num_ord$forest - max_num_ord$agriculture

max_bio_fam$forest <- round(max_bio_fam$forest, digits = 0)
max_bio_fam$agriculture <- round(max_bio_fam$agriculture, digits = 0)
max_bio_fam$diff_day <- max_bio_fam$forest - max_bio_fam$agriculture

max_num_fam$forest <- round(max_num_fam$forest, digits = 0)
max_num_fam$agriculture <- round(max_num_fam$agriculture, digits = 0)
max_num_fam$diff_day <- max_num_fam$forest - max_num_fam$agriculture
```
Add column with info, if peaks for number or biomass
```{r, message =FALSE, warning= FALSE}
max_bio_pos$Variable <- "Biomass"
max_num_pos$Variable <- "Abundance"

max_bio_ord$Variable <- "Biomass"
max_num_ord$Variable <- "Abundance"

max_bio_fam$Variable <- "Biomass"
max_num_fam$Variable <- "Abundance"
```
Unite biomass and abundance for position, order and family
```{r, message =FALSE, warning= FALSE}
max_pos <- rbind(max_bio_pos, max_num_pos)
max_ord <- rbind(max_bio_ord, max_num_ord)
max_fam <- rbind(max_bio_fam, max_num_fam)
```
Put columns in nice order for export
```{r, message =FALSE, warning= FALSE}
max_pos <- select(max_pos, c( "Variable", "peak_no", "forest", "agriculture", "diff_day" ))

max_ord <- select(max_ord, c( "Variable", "order", "peak_no", "forest", "agriculture", "diff_day" ))

max_fam <- select(max_fam, c( "Variable", "order", "family", "peak_no", "forest", "agriculture", "diff_day" ))
```
Use trivial name for order
```{r, message =FALSE, warning= FALSE}
max_ord$order <- gsub("Diptera", "Fly", max_ord$order)
max_ord$order <- gsub("Ephemeroptera", "Mayfly", max_ord$order)
max_ord$order <- gsub("Plecoptera", "Stonefly", max_ord$order)
max_ord$order <- gsub("Trichoptera", "Caddisfly", max_ord$order)

max_fam$order <- gsub("Diptera", "Fly", max_fam$order)
max_fam$order <- gsub("Ephemeroptera", "Mayfly", max_fam$order)
max_fam$order <- gsub("Plecoptera", "Stonefly", max_fam$order)
max_fam$order <- gsub("Trichoptera", "Caddisfly", max_fam$order)
```
Add trivial name for family
```{r, message =FALSE, warning= FALSE}
#View(max_fam)

max_fam$family <- gsub("Ceratopogonidae", 
                       "Biting midges (Ceratopogonidae)", max_fam$family)

max_fam$family <- gsub("Chaoboridae", 
                       "Phantom midges (Chaoboridae)",  max_fam$family)

max_fam$family <- gsub("Culicidae", 
                       "Mosquitoes (Culicidae)", max_fam$family)

max_fam$family <- gsub("Dixidae", 
                       "Meniscus midges (Dixidae)", max_fam$family)

max_fam$family <- gsub("Empididae", 
                       "Ballon/dagger flies (Empididae)",  max_fam$family)

max_fam$family <- gsub("Limoniidae", 
                       "Limoniid crane flies (Limoniidae)",  max_fam$family)

max_fam$family <- gsub("Psychodidae", 
                       "Drain flies (Psychodidae)",  max_fam$family)

max_fam$family <- gsub("Ptychopteridae", 
                       "Phantom crane flies (Ptychopteridae)",  max_fam$family)

max_fam$family <- gsub("Simuliidae", 
                       "Black flies (Simuliidae)",  max_fam$family)

max_fam$family <- gsub("Tipulidae", 
                       "Crane flies (Tipulidae)",  max_fam$family)

max_fam$family <- gsub("Chironomidae", 
                       "Non biting midges (Chironomidae)",  max_fam$family)

max_fam$family <- gsub("Arthropleidae", 
                       "Flatheaded mayflies (Arthropleidae)",  max_fam$family)

max_fam$family <- gsub("Ephemerellidae", 
                       "Spiny crawler mayflies (Ephemerellidae)",  max_fam$family)

max_fam$family <- gsub("Ephemeridae", 
                       "Burrowing mayflies (Ephemeridae)",  max_fam$family)

max_fam$family <- gsub("Heptageniidae", 
                       "Stream mayflies (Heptageniidae)",  max_fam$family)

max_fam$family <- gsub("Siphlonuridae", 
                       "Primitive minnow mayflies (Siphlonuridae)",  max_fam$family)

max_fam$family <- gsub("Baetidae", 
                       "Small mayflies (Baetidae)",  max_fam$family)

max_fam$family <- gsub("Chloroperlidae", 
                       "Green stoneflies (Chloroperlidae)",  max_fam$family)

max_fam$family <- gsub("Leuctridae", 
                       "Needle flies (Leuctridae)",  max_fam$family)

max_fam$family <- gsub("Nemouridae", 
                       "Spring stoneflies (Nemouridae)",  max_fam$family)

max_fam$family <- gsub("Taeniopterygidae", 
                       "Willow flies (Taeniopterygidae)", max_fam$family)

max_fam$family <- gsub("Glossosomatidae", 
                       "Tortoise makers (Glossosomatidae)",  max_fam$family)

max_fam$family <- gsub("Goeridae", 
                       "Weighted case maker (Goeridae)",  max_fam$family)

max_fam$family <- gsub("Hydroptilidae", "Micro caddisflies (Hydroptilidae)",  max_fam$family)

max_fam$family <- gsub("Lepidostomatidae", 
                       "Lepidostomatid case makers (Lepidostomatidae)",  max_fam$family)

max_fam$family <- gsub("Leptoceridae", 
                       "Long-horned caddisflies (Leptoceridae)",  max_fam$family)
    
max_fam$family <- gsub("Limnephilidae", 
                       "Northern caddisflies (Limnephilidae)",  max_fam$family)
    
max_fam$family <- gsub("Philopotamidae", 
                       "Finger-net caddisflies (Philopotamidae)",  max_fam$family)
  
max_fam$family <- gsub("Phryganeidae", 
                       "Large caddisflies (Phryganeidae)",  max_fam$family)

max_fam$family <- gsub("Psychomyiidae", 
                       "Tube-making caddisflies (Psychomyiidae)",  max_fam$family)

max_fam$family <- gsub("Rhyacophilidae", 
                       "Primitive caddisflies (Rhyacophilidae)",  max_fam$family)
    
max_fam$family <- gsub("Sericostomatidae", 
                       "Bushtailed caddisflies (Sericostomatidae)",  max_fam$family)

max_fam$family <- gsub("Uenoidae", 
                       "Stonecase caddisflies (Uenoidae)",  max_fam$family)
      
max_fam$family <- gsub("Hydropsychidae", 
                       "Net-spinning caddisflies (Hydropsychidae)",  max_fam$family)
```


Rename columns for export
```{r, message =FALSE, warning= FALSE}
names(max_pos)[2] <- "Peak number"
names(max_pos)[3] <- "Day forest"
names(max_pos)[4] <- "Day agriculture"
names(max_pos)[5] <- "Difference day forest and agriculture"

names(max_ord)[2] <- "Order"
names(max_ord)[3] <- "Peak number"
names(max_ord)[4] <- "Day forest"
names(max_ord)[5] <- "Day agriculture"
names(max_ord)[6] <- "Difference day forest and agriculture"

names(max_fam)[2] <- "Order"
names(max_fam)[3] <- "Family"
names(max_fam)[4] <- "Peak number"
names(max_fam)[5] <- "Day forest"
names(max_fam)[6] <- "Day agriculture"
names(max_fam)[7] <- "Difference day forest and agriculture"
```
Export data
```{r, message =FALSE, warning= FALSE}
#write.csv(max_pos, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/max_pos.csv", row.names = FALSE)
#write.csv(max_ord, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/max_ord.csv", row.names = FALSE)
#write.csv(max_fam, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/max_fam.csv", row.names = FALSE)
```

## Export HGAM output 
```{r, message =FALSE, warning= FALSE}
#htmlreg(list(bio_position_S, bio_position_order_S, bio_position_family_S, num_position_S, num_position_order_S, num_position_family_S), digits = 4, stars = numeric(0), caption.above = TRUE, caption = "HGAM biomass", float.pos = "h!", label = "tab:3", custom.model.names = c("S HGAM biomass land use", "S HGAM biomass land use and order", "S HGAM biomass land use and family", "S HGAM abundance land use", "S HGAM abundance land use and order", "S HGAM abundance land use and family"), file = "HGAM_S.doc")

#htmlreg(list(bio_position_I, bio_position_order_I, bio_position_family_I, num_position_I, num_position_order_I, num_position_family_I), digits = 4, stars = numeric(0), caption.above = TRUE, caption = "HGAM abundance", float.pos = "h!", label = "tab:3", custom.model.names = c("I HGAM biomass land use", "I HGAM biomass land use and order", "I HGAM biomass land use and family", "I HGAM abundance land use", "I HGAM abundance land use and order", "I HGAM abundance land use and family"), file = "HGAM_I.doc")
```

# (G)LMM
## Check for collinearity 
```{r, message =FALSE, warning= FALSE}
cor <- data_env_1[, c(2,4, 27:34)]

cor$stream <- as.numeric(cor$stream)
cor$season <- as.numeric(cor$season) 

cor_r <- round(cor(cor, use = "complete.obs"), 1)

panel.cor <- function(x, y, digits=2, prefix="", cex.cor)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y, use="complete.obs"))
    txt <- format(c(r, 0.123456789), digits=digits)[1]
    txt <- paste(prefix, txt, sep="")
    if(missing(cex.cor)) cex <- 0.8/strwidth(txt)
    
    test <- cor.test(x,y)
    # borrowed from printCoefmat
    Signif <- symnum(test$p.value, corr = FALSE, na = FALSE,
                  cutpoints = c(0, 0.05, 0.1, 1),
                  symbols = c("*", ".", " "))
    
    text(0.5, 0.5, txt, cex = cex * r)
    text(.8, .8, Signif, cex=cex, col=2)
}
pairs(cor, 
      lower.panel = panel.smooth, upper.panel = panel.cor)
```
*no problem with collinearity

### Standardise (scale) explanatory variables
```{r, message =FALSE, warning= FALSE}
data_env_scale <- select(data_env_1, c("Site", "stream", "position", "season","biomass_site_mean", "number_site_mean", "biomass_Diptera", "number_Diptera", "biomass_Ephemeroptera", "number_Ephemeroptera", "biomass_Trichoptera", "number_Trichoptera", "biomass_Plecoptera", "number_Plecoptera", "number_EPT", "number_fam", "max_sumTU_ms_pyr", "NO3", "PO4", "water_temp", "pools", "conductivity", "shading", "o2_perc"))

data_env_scale[,(17:24)] <- scale(data_env_scale[,(17:24)])  
```

## Check distribution of biomass data
### Load packages
```{r, message =FALSE, warning= FALSE}
library(car) # qqp
library(MASS) # fitdistr
```

### Log transform biomass and number data 

```{r, message =FALSE, warning= FALSE}
data_env_scale$log_biomass_site_mean <- log(data_env_scale$biomass_site_mean 
                                            + min(data_env_scale$biomass_site_mean))
data_env_scale$log_biomass_Diptera <- log(data_env_scale$biomass_Diptera 
                                          + min(data_env_scale$biomass_Diptera))
data_env_scale$log_biomass_Ephemeroptera <- log(data_env_scale$biomass_Ephemeroptera
                                            + 0.006134615)
data_env_scale$log_biomass_Plecoptera <- log(data_env_scale$biomass_Plecoptera
                                             + 0.003825455)
data_env_scale$log_biomass_Trichoptera <- log(data_env_scale$biomass_Trichoptera
                                              + 0.01883750)

data_env_scale$log_number_site_mean <- log(data_env_scale$number_site_mean
                                           + min(data_env_scale$number_site_mean))
data_env_scale$log_number_Diptera <- log(data_env_scale$number_Diptera
                                         + min(data_env_scale$number_Diptera))
data_env_scale$log_number_Ephemeroptera <- log(data_env_scale$number_Ephemeroptera
                                              + 0.03333333)
data_env_scale$log_number_Plecoptera <- log(data_env_scale$number_Plecoptera
                                            + 0.02424242)
data_env_scale$log_number_Trichoptera <- log(data_env_scale$number_Trichoptera
                                             + 0.03125000)
```

### Mean per site and season
```{r, message =FALSE, warning= FALSE}
par(mfrow = c(1,2))
qqp(data_env_scale$biomass_site_mean, "norm")
qqp(data_env_scale$log_biomass_site_mean, "norm")
```
* For mean biomass per site and season log transformation improves normality

### Mean biomass of Diptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$biomass_Diptera, "norm")
qqp(data_env_scale$log_biomass_Diptera, "norm")
```
* For mean biomass of Diptera per site and season log transformation improves normality

### Mean biomass of Ephemeroptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$biomass_Ephemeroptera, "norm")
qqp(data_env_scale$log_biomass_Ephemeroptera, "norm")
```
* For mean biomass of Ephemeroptera per site and season log transformation improves normality

### Mean biomass of Plecoptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$biomass_Plecoptera, "norm")
qqp(data_env_scale$log_biomass_Plecoptera, "norm")
```
* For mean biomass of Plecoptera per site and season log transformation improves normality

### Mean biomass of Trichoptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$biomass_Trichoptera, "norm")
qqp(data_env_scale$log_biomass_Trichoptera, "norm")
par(mfrow = c(1,1))
```

* For mean biomass of Trichoptera per site and season log transformation improves normality

## LMM Lasso for biomass

### Model specification Normal distribution

* Y is biomass or number at total and order level
* E is mean/expected value of a variable
* var is variance of a variable
* max_sumTU_ms_pyr, NO3, PO4, water_temp, pools, conductivity are fixed factors used at beginning for Lasso model selection
* stream and season are random factors (here random intercepts)

$$Y{_{ikl}} \sim N(\mu{_{ikl}}, \sigma{_{ikl}}^2)$$
$$E(Y{_{ikl}}) = \mu$$
$$var(Y{_{ikl}}) = \sigma{_{ikl}}^2$$

* Model, if all variables included:

$$\mu{_{il}} =  \beta_1 + \beta_2 \cdot max\_sumTU\_ms\_pyr{_{il}} + \beta_3 \cdot NO3{_{il}} + \beta_4 \cdot  PO4{_{il}} + \beta_5 \cdot water\_temp{_{il}} + \beta_6 \cdot  pools{_{il}} + \beta_7 \cdot conductivity{_{il}} + stream{_{l}} + season{_{i}}$$
$$stream{_{l}} \sim N(0, \sigma{_{stream}}^2)$$
$$ season{_{i}} \sim N(0, \sigma{_{season}}^2) $$


* Use Lasso, since Lasso can deal with low sample size 

### Load packages
```{r, message =FALSE, warning= FALSE}
library(glmmLasso) # Lasso for (G)LMM
```

* hiearchical data: two-level model: sites within stream
* in every stream 2 sites: one in forest and one in vine
* 10 streams: 20 sites
* sampled in three seasons
* random effect: site and season (crossed random effects -> independent from each other)

### Mean biomass per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity") 
```

#### Fit model

* Start with big lambda and use the estimates of the previous fit as starting values for the next fit

* The final re-estimation Fisher scoring is performed before values used for next fit

* Lambda must be big enough that all covariates are shrinked to zero 

* Both models: lambda starting with 1000 and 500 gives same model output

BIC used to determine the optimal tuning parameter lambda
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length: intercept + number of fixed effects + number levels of random effects Site + number levels of random effects season
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 

Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)

for(j in 1:length(lambda))
{
lmm_bio <- glmmLasso(log_biomass_site_mean~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = FALSE))  
  
 # print(colnames(lmm_bio$Deltamatrix)[2:7][lmm_bio$Deltamatrix[lmm_bio$conv.step,2:7]!=0])
  BIC_vec[j]<-lmm_bio$bic
  Delta.start<-rbind(Delta.start,lmm_bio$Deltamatrix[lmm_bio$conv.step,])
  Q.start <- rbind(Q.start,lmm_bio$Q_long[[lmm_bio$conv.step+1]])
}

opt_bio<-which.min(BIC_vec)

lmm_bio_final <- glmmLasso(log_biomass_site_mean~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity  + shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_bio],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_bio,],q_start=Q.start[(2*opt_bio+1):(2*opt_bio+2),]# 2x2 matrix for every model: number of model*2 and add one (because of q.start set at beginning) to get right Q.start
                                       , steps = 1500, overdispersion = FALSE))  
summary(lmm_bio_final)
```

#### Model diagnostic
Normality and variance
```{r, message=FALSE, warning=FALSE}
F_bio <- lmm_bio_final[["fitted.values"]]

# Residual = observed y – predicted y (function "resid" does not work here)
E_bio <-  lmm_bio_final$y - F_bio

plot(x = F_bio, y = E_bio, xlab = "Fitted values", ylab = "Pearson residuals", main = "glmmLasso") 
abline(h = 0, lty = 2) #variance okay

qreference(E_bio, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_bio_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_bio^2)/(N-p) # 0.5 = 0.5 -> okay
```
* for line in middle not that problematic, only prediction intervals and so on are not reliable

* But prediction intervals not relevant for me

#### Coefficients of determination and ICC
See for theoretical background:
Nakagawa, S., Johnson, P. C. D., & Schielzeth, H. (2017). https://doi.org/10.1098/rsif.2017.0213
Nakagawa, S., & Schielzeth, H. (2013). https://doi.org/10.1111/j.2041-210x.2012.00261.x


$$ R^2_{marginal} = { \frac {\sigma^2_{fixed}} {\sigma^2_{fixed} + \sigma^2_{stream} + \sigma^2_{season} + \sigma^2_\epsilon}} $$

$$ R^2_{conditional} = { \frac {\sigma^2_{fixed} + \sigma^2_{stream} + \sigma^2_{season}} {\sigma^2_{fixed} + \sigma^2_{stream} + \sigma^2_{season} + \sigma^2_\epsilon}} $$

* $\sigma^2_{fixed}$: variance calculated from fixed effect

* $\sigma^2_{stream}$ and $\sigma^2_{seasons}$: variance calculated from random effects stream and season

* $\sigma^2_\epsilon$: observation level variance for non normal distributed data, for normal distributed (gaussian) data residual variance

$$ ICC_{stream-adjusted} = { \frac {\sigma^2_{stream}} {\sigma^2_{stream} + \sigma^2_\epsilon}} $$

$$ ICC_{stream} = { \frac {\sigma^2_{stream}} {\sigma^2_{fixed} + \sigma^2_{stream} + \sigma^2_\epsilon}} $$

$$ ICC_{season-adjusted} = { \frac {\sigma^2_{season}} {\sigma^2_{season} + \sigma^2_\epsilon}} $$

$$ ICC_{season} = { \frac {\sigma^2_{season}} {\sigma^2_{fixed} + \sigma^2_{season} + \sigma^2_\epsilon}} $$

##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_bio <- lmm_bio_final$coefficients# estimated regression parameters
beta_bio <- beta_bio[c(1)]

X_bio <- model.matrix(~1, data = data_env_scale) # model matrix LN GLMM, first column only 1 for intercept, other columns fixed effects

var_bio_fix <- var(as.vector(X_bio %*% beta_bio))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_bio_stream <- (as.numeric(lmm_bio_final[["StdDev"]][1] ))^2
var_bio_season <- (as.numeric(lmm_bio_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance

* For Gaussian with identity link observation level variance is residual variance

```{r, message =FALSE, warning= FALSE}
var_bio_obs <- var(E_bio)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_mar <- (var_bio_fix)/(var_bio_fix + var_bio_stream + var_bio_season + var_bio_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_con <- (var_bio_fix + var_bio_stream + var_bio_season)/(var_bio_fix + var_bio_stream + var_bio_season + var_bio_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_bio_str_adj <- (var_bio_stream)/(var_bio_stream + var_bio_obs)

ICC_bio_sea_adj <- (var_bio_season)/(var_bio_season + var_bio_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_bio_str <- (var_bio_stream)/(var_bio_fix + var_bio_stream + var_bio_obs)

ICC_bio_sea <- (var_bio_season)/(var_bio_fix + var_bio_season + var_bio_obs)
```

### Mean biomass of Diptera per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```

#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2) 

for(j in 1:length(lambda))
{
lmm_bio_dip <- glmmLasso(log_biomass_Diptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = FALSE))  
  BIC_vec[j]<-lmm_bio_dip$bic
  Delta.start<-rbind(Delta.start,lmm_bio_dip$Deltamatrix[lmm_bio_dip$conv.step,])
  Q.start <- rbind(Q.start,lmm_bio_dip$Q_long[[lmm_bio_dip$conv.step+1]])
}

opt_bio_dip<-which.min(BIC_vec)

lmm_bio_dip_final <- glmmLasso(log_biomass_Diptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_bio_dip],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_bio_dip,],q_start=Q.start[(2*opt_bio_dip+1):(2*opt_bio_dip+2),], steps = 1500, overdispersion = FALSE))

summary(lmm_bio_dip_final)
```

#### Model diagnostic
Normality and variance
```{r, message=FALSE, warning=FALSE}
F_bio_dip <- lmm_bio_dip_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_bio_dip <-  lmm_bio_dip_final$y - F_bio_dip

plot(x = F_bio_dip, y = E_bio_dip, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) #variance okay

qreference(E_bio_dip, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_bio_dip_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_bio_dip^2)/(N-p) # ok
```
#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_bio_dip <- lmm_bio_dip_final$coefficients# estimated regression parameters 
beta_bio_dip <- beta_bio_dip[c(1,8)] # remove variables, which are not in final model (=0)

X_bio_dip <- model.matrix(~shading, data = data_env_scale) # model matrix LN GLMM, first column only 1 for intercept, other columns fixed effects

var_bio_dip_fix <- var(as.vector(X_bio_dip %*% beta_bio_dip))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_bio_dip_stream <- (as.numeric(lmm_bio_dip_final[["StdDev"]][1] ))^2
var_bio_dip_season <- (as.numeric(lmm_bio_dip_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance
```{r, message =FALSE, warning= FALSE}
var_bio_dip_obs <- var(E_bio_dip)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_dip_mar <- (var_bio_dip_fix)/(var_bio_dip_fix + var_bio_dip_stream + var_bio_dip_season + var_bio_dip_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_dip_con <- (var_bio_dip_fix + var_bio_dip_stream + var_bio_dip_season)/(var_bio_dip_fix + var_bio_dip_stream + var_bio_dip_season + var_bio_dip_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_bio_dip_str_adj <- (var_bio_dip_stream)/(var_bio_dip_stream + var_bio_dip_obs)

ICC_bio_dip_sea_adj <- (var_bio_dip_season)/(var_bio_dip_season + var_bio_dip_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_bio_dip_str <- (var_bio_dip_stream)/(var_bio_dip_fix + var_bio_dip_stream + var_bio_dip_obs)

ICC_bio_dip_sea <- (var_bio_dip_season)/(var_bio_dip_fix + var_bio_dip_season + var_bio_dip_obs)
```

### Mean biomass Ephemeroptera per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```

#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)

for(j in 1:length(lambda))
{
lmm_bio_eph <- glmmLasso(log_biomass_Ephemeroptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = FALSE))
BIC_vec[j]<-lmm_bio_eph$bic
  Delta.start<-rbind(Delta.start,lmm_bio_eph$Deltamatrix[lmm_bio_eph$conv.step,])
  Q.start <- rbind(Q.start,lmm_bio_eph$Q_long[[lmm_bio_eph$conv.step+1]])
}

opt_bio_eph<-which.min(BIC_vec)

lmm_bio_eph_final <- glmmLasso(log_biomass_Ephemeroptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_bio_eph],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_bio_eph,],q_start=Q.start[(2*opt_bio_eph+1):(2*opt_bio_eph+2),], steps = 1500, overdispersion = FALSE))  

summary(lmm_bio_eph_final)
```

#### Model diagnostic
Normality and variance
```{r, message=FALSE, warning=FALSE}
F_bio_eph <- lmm_bio_eph_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_bio_eph <-  lmm_bio_eph_final$y - F_bio_eph

plot(x = F_bio_eph, y = E_bio_eph, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) #variance could be better (three cluster visible)

qreference(E_bio_eph, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_bio_eph_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_bio_eph^2)/(N-p) # ok
```
#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_bio_eph <- lmm_bio_eph_final$coefficients# estimated regression parameters
beta_bio_eph <- beta_bio_eph[c(1,2,5,6,7)] # remove variables, which are not in final model (=0)

X_bio_eph <- model.matrix(~max_sumTU_ms_pyr + water_temp + pools + conductivity, data = data_env_scale) # model matrix LMM, first column only 1 for intercept, other columns fixed effects

var_bio_eph_fix <- var(as.vector(X_bio_eph %*% beta_bio_eph))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_bio_eph_stream <- (as.numeric(lmm_bio_eph_final[["StdDev"]][1] ))^2
var_bio_eph_season <- (as.numeric(lmm_bio_eph_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance 
* For Gaussian with identity link observation level variance is residual variance

```{r, message =FALSE, warning= FALSE}
var_bio_eph_obs <- var(E_bio_eph)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_eph_mar <- (var_bio_eph_fix)/(var_bio_eph_fix + var_bio_eph_stream + var_bio_eph_season + var_bio_eph_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_eph_con <- (var_bio_eph_fix + var_bio_eph_stream + var_bio_eph_season)/(var_bio_eph_fix + var_bio_eph_stream + var_bio_eph_season + var_bio_eph_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_bio_eph_str_adj <- (var_bio_eph_stream)/(var_bio_eph_stream + var_bio_eph_obs)

ICC_bio_eph_sea_adj <- (var_bio_eph_season)/(var_bio_eph_season + var_bio_eph_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_bio_eph_str <- (var_bio_eph_stream)/(var_bio_eph_fix + var_bio_eph_stream + var_bio_eph_obs)

ICC_bio_eph_sea <- (var_bio_eph_season)/(var_bio_eph_fix + var_bio_eph_season + var_bio_eph_obs)
```

### Mean biomass Plecoptera per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```

#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)  

for(j in 1:length(lambda))
{
lmm_bio_ple <- glmmLasso(log_biomass_Plecoptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = FALSE))
  BIC_vec[j]<-lmm_bio_ple$bic
  Delta.start<-rbind(Delta.start,lmm_bio_ple$Deltamatrix[lmm_bio_ple$conv.step,])
  Q.start <- rbind(Q.start,lmm_bio_ple$Q_long[[lmm_bio_ple$conv.step+1]])
}

opt_bio_ple<-which.min(BIC_vec)

lmm_bio_ple_final <- glmmLasso(log_biomass_Plecoptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_bio_ple],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_bio_ple,],q_start=Q.start[(2*opt_bio_ple+1):(2*opt_bio_ple+2),], steps = 1500, overdispersion = FALSE)) 

summary(lmm_bio_ple_final)
```

#### Model diagnostic
Normality and variance
```{r, message=FALSE, warning=FALSE}
F_bio_ple <- lmm_bio_ple_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_bio_ple <-  lmm_bio_ple_final$y - F_bio_ple

plot(x = F_bio_ple, y = E_bio_ple, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance could be better, increase visible

qreference(E_bio_ple, nrep = 8) # normality not okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_bio_ple_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_bio_ple^2)/(N-p) # ok
```
#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_bio_ple <- lmm_bio_ple_final$coefficients# estimated regression parameters LMM
beta_bio_ple <- beta_bio_ple[c(1,2,4,5,7,8)] # remove variables, which are not in final model (=0)

X_bio_ple <- model.matrix(~max_sumTU_ms_pyr + PO4 + water_temp + conductivity + shading, data = data_env_scale) # model matrix LMM, first column only 1 for intercept, other columns fixed effects

var_bio_ple_fix <- var(as.vector(X_bio_ple %*% beta_bio_ple))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_bio_ple_stream <- (as.numeric(lmm_bio_ple_final[["StdDev"]][1] ))^2
var_bio_ple_season <- (as.numeric(lmm_bio_ple_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance

```{r, message =FALSE, warning= FALSE}
var_bio_ple_obs <- var(E_bio_ple)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_ple_mar <- (var_bio_ple_fix)/(var_bio_ple_fix + var_bio_ple_stream + var_bio_ple_season + var_bio_ple_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_ple_con <- (var_bio_ple_fix + var_bio_ple_stream + var_bio_ple_season)/(var_bio_ple_fix + var_bio_ple_stream + var_bio_ple_season + var_bio_ple_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_bio_ple_str_adj <- (var_bio_ple_stream)/(var_bio_ple_stream + var_bio_ple_obs)

ICC_bio_ple_sea_adj <- (var_bio_ple_season)/(var_bio_ple_season + var_bio_ple_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_bio_ple_str <- (var_bio_ple_stream)/(var_bio_ple_fix + var_bio_ple_stream + var_bio_ple_obs)

ICC_bio_ple_sea <- (var_bio_ple_season)/(var_bio_ple_fix + var_bio_ple_season + var_bio_ple_obs)
```

### Mean biomass Trichoptera per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```
#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)  

for(j in 1:length(lambda))
{
lmm_bio_tri <- glmmLasso(log_biomass_Trichoptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = FALSE))   
BIC_vec[j]<-lmm_bio_tri$bic
  Delta.start<-rbind(Delta.start,lmm_bio_tri$Deltamatrix[lmm_bio_tri$conv.step,])
  Q.start <- rbind(Q.start,lmm_bio_tri$Q_long[[lmm_bio_tri$conv.step+1]])
}

opt_bio_tri<-which.min(BIC_vec)

lmm_bio_tri_final <- glmmLasso(log_biomass_Trichoptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_bio_tri],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_bio_tri,],q_start=Q.start[(2*opt_bio_tri+1):(2*opt_bio_tri+2),], steps = 1500, overdispersion = FALSE)) 

summary(lmm_bio_tri_final)
```

#### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_bio_tri <- lmm_bio_tri_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_bio_tri <-  lmm_bio_tri_final$y - F_bio_tri

plot(x = F_bio_tri, y = E_bio_tri, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance okay

qreference(E_bio_tri, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_bio_tri_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_bio_tri^2)/(N-p) # ok
```

#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_bio_tri <- lmm_bio_tri_final$coefficients# estimated regression parameters LMM
beta_bio_tri <- beta_bio_tri[c(1, 7)]

X_bio_tri <- model.matrix(~conductivity, data = data_env_scale) # model LMM, first column only 1 for intercept, other columns fixed effects

var_bio_tri_fix <- var(as.vector(X_bio_tri %*% beta_bio_tri))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_bio_tri_stream <- (as.numeric(lmm_bio_tri_final[["StdDev"]][1] ))^2
var_bio_tri_season <- (as.numeric(lmm_bio_tri_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance

```{r, message =FALSE, warning= FALSE}
var_bio_tri_obs <- var(E_bio_tri)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_tri_mar <- (var_bio_tri_fix)/(var_bio_tri_fix + var_bio_tri_stream + var_bio_tri_season + var_bio_tri_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_bio_tri_con <- (var_bio_tri_fix + var_bio_tri_stream + var_bio_tri_season)/(var_bio_tri_fix + var_bio_tri_stream + var_bio_tri_season + var_bio_tri_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_bio_tri_str_adj <- (var_bio_tri_stream)/(var_bio_tri_stream + var_bio_tri_obs)

ICC_bio_tri_sea_adj <- (var_bio_tri_season)/(var_bio_tri_season + var_bio_tri_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_bio_tri_str <- (var_bio_tri_stream)/(var_bio_tri_fix + var_bio_tri_stream + var_bio_tri_obs)

ICC_bio_tri_sea <- (var_bio_tri_season)/(var_bio_tri_fix + var_bio_tri_season + var_bio_tri_obs)
```


## Check distribution of number data
### Mean per site and season
```{r, message =FALSE, warning= FALSE}
par(mfrow = c(1,2))

qqp(data_env_scale$number_site_mean, "norm")
qqp(data_env_scale$log_number_site_mean, "norm")
```
* For mean number per site and season log transformation improves normality

### Mean number of Diptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$number_Diptera, "norm")
qqp(data_env_scale$log_number_Diptera, "norm")
```
* For mean number of Diptera per site and season log transformation improves normality

### Mean number of Ephemeroptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$number_Ephemeroptera, "norm")
qqp(data_env_scale$log_number_Ephemeroptera, "norm")
```
* For mean number of Ephemeroptera per site and season log transformation improves normality

### Mean number of Plecoptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$number_Plecoptera, "norm")
qqp(data_env_scale$log_number_Plecoptera, "norm")
```
* For mean number of Plecoptera per site and season log transformation improves normality

### Mean number of Trichoptera per site and season
```{r, message =FALSE, warning= FALSE}
qqp(data_env_scale$number_Trichoptera, "norm")
qqp(data_env_scale$log_number_Trichoptera, "norm")
par(mfrow = c(1,1))
```
* For mean number of Trichoptera per site and season log transformation improves normality

* Use glmmLasso with normal distribution

## LMM Lasso for number
### Mean number of organisms per site and seson
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```

#### Fit model

* for details see biomass model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
 
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2) 

for(j in 1:length(lambda))
{
lmm_num <- glmmLasso(log_number_site_mean~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = FALSE))    
  BIC_vec[j]<-lmm_num$bic
  Delta.start<-rbind(Delta.start,lmm_num$Deltamatrix[lmm_num$conv.step,])
  Q.start <- rbind(Q.start,lmm_num$Q_long[[lmm_num$conv.step+1]])
}

opt_num<-which.min(BIC_vec)

lmm_num_final <- glmmLasso(log_number_site_mean~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_num],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_num,],q_start=Q.start[(2*opt_num+1):(2*opt_num+2),], steps = 1500, overdispersion = FALSE))   
summary(lmm_num_final)
```
#### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_num <- lmm_num_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_num <-  lmm_num_final$y - F_num

plot(x = F_num, y = E_num, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance okay 

qreference(E_num, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_num_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_num^2)/(N-p) #  < 0.5 -> underdispersion
```

#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_num <- lmm_num_final$coefficients# estimated regression parameters
beta_num <- beta_num[c(1)]

X_num <- model.matrix(~1, data = data_env_scale) # model matrix LN GLMM, first column only 1 for intercept, other columns fixed effects

var_num_fix <- var(as.vector(X_num %*% beta_num))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_num_stream <- (as.numeric(lmm_num_final[["StdDev"]][1] ))^2
var_num_season <- (as.numeric(lmm_num_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance

```{r, message =FALSE, warning= FALSE}
var_num_obs <- var(E_num)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_mar <- (var_num_fix)/(var_num_fix + var_num_stream + var_num_season + var_num_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_con <- (var_num_fix + var_num_stream + var_num_season)/(var_num_fix + var_num_stream + var_num_season + var_num_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_num_str_adj <- (var_num_stream)/(var_num_stream + var_num_obs)

ICC_num_sea_adj <- (var_num_season)/(var_num_season + var_num_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_num_str <- (var_num_stream)/(var_num_fix + var_num_stream + var_num_obs)

ICC_num_sea <- (var_num_season)/(var_num_fix + var_num_season + var_num_obs)
```


### Mean number Diptera per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```
#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)  

for(j in 1:length(lambda))
{
lmm_num_dip <- glmmLasso(log_number_Diptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = TRUE))  
BIC_vec[j]<-lmm_num_dip$bic
  Delta.start<-rbind(Delta.start,lmm_num_dip$Deltamatrix[lmm_num_dip$conv.step,])
  Q.start <- rbind(Q.start,lmm_num_dip$Q_long[[lmm_num_dip$conv.step+1]])
}

opt_num_dip<-which.min(BIC_vec)

lmm_num_dip_final <- glmmLasso(log_number_Diptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_num_dip],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_num_dip,],q_start=Q.start[(2*opt_num_dip+1):(2*opt_num_dip+2),], steps = 1500, overdispersion = TRUE))
summary(lmm_num_dip_final)
```

#### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_num_dip <- lmm_num_dip_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_num_dip <-  lmm_num_dip_final$y - F_num_dip

plot(x = F_num_dip, y = E_num_dip, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance okay

qreference(E_num_dip, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_num_dip_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_num_dip^2)/(N-p) # slight underdispersion
```
#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_num_dip <- lmm_num_dip_final$coefficients# estimated regression parameters 
beta_num_dip <- beta_num_dip[c(1)]

X_num_dip <- model.matrix(~ 1, data = data_env_scale) # model matrix LN GLMM, first column only 1 for intercept, other columns fixed effects

var_num_dip_fix <- var(as.vector(X_num_dip %*% beta_num_dip))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_num_dip_stream <- (as.numeric(lmm_num_dip_final[["StdDev"]][1] ))^2
var_num_dip_season <- (as.numeric(lmm_num_dip_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance

```{r, message =FALSE, warning= FALSE}
var_num_dip_obs <- var(E_num_dip)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_dip_mar <- (var_num_dip_fix)/(var_num_dip_fix + var_num_dip_stream + var_num_dip_season + var_num_dip_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_dip_con <- (var_num_dip_fix + var_num_dip_stream + var_num_dip_season)/(var_num_dip_fix + var_num_dip_stream + var_num_dip_season + var_num_dip_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_num_dip_str_adj <- (var_num_dip_stream)/(var_num_dip_stream + var_num_dip_obs)

ICC_num_dip_sea_adj <- (var_num_dip_season)/(var_num_dip_season + var_num_dip_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_num_dip_str <- (var_num_dip_stream)/(var_num_dip_fix + var_num_dip_stream + var_num_dip_obs)

ICC_num_dip_sea <- (var_num_dip_season)/(var_num_dip_fix + var_num_dip_season + var_num_dip_obs)
```

### Mean number Ephemeroptera per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```
#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2) 

for(j in 1:length(lambda))
{
lmm_num_eph <- glmmLasso(log_number_Ephemeroptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500, overdispersion = FALSE))  
  BIC_vec[j]<-lmm_num_eph$bic
  Delta.start<-rbind(Delta.start,lmm_num_eph$Deltamatrix[lmm_num_eph$conv.step,])
  Q.start <- rbind(Q.start,lmm_num_eph$Q_long[[lmm_num_eph$conv.step+1]])
}

opt_num_ept<-which.min(BIC_vec)

lmm_num_eph_final <- glmmLasso(log_number_Ephemeroptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity+ shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_num_ept],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_num_ept,],q_start=Q.start[(2*opt_num_ept+1):(2*opt_num_ept+2),], steps = 1500, overdispersion = FALSE))

summary(lmm_num_eph_final)
```

#### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_num_eph <- lmm_num_eph_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_num_eph <-  lmm_num_eph_final$y - F_num_eph

plot(x = F_num_eph, y = E_num_eph, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance okay

qreference(E_num_eph, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_num_eph_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_num_eph^2)/(N-p) # ok
```
#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_num_eph <- lmm_num_eph_final$coefficients# estimated regression parameters LMM
beta_num_eph <- beta_num_eph[c(1)] # remove variables, which are not in final model (=0)

X_num_eph <- model.matrix(~1, data = data_env_scale) # model matrix LMM, first column only 1 for intercept, other columns fixed effects

var_num_eph_fix <- var(as.vector(X_num_eph %*% beta_num_eph))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_num_eph_stream <- (as.numeric(lmm_num_eph_final[["StdDev"]][1] ))^2
var_num_eph_season <- (as.numeric(lmm_num_eph_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance

```{r, message =FALSE, warning= FALSE}
var_num_eph_obs <- var(E_num_eph)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_eph_mar <- (var_num_eph_fix)/(var_num_eph_fix + var_num_eph_stream + var_num_eph_season + var_num_eph_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_eph_con <- (var_num_eph_fix + var_num_eph_stream + var_num_eph_season)/(var_num_eph_fix + var_num_eph_stream + var_num_eph_season + var_num_eph_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_num_eph_str_adj <- (var_num_eph_stream)/(var_num_eph_stream + var_num_eph_obs)

ICC_num_eph_sea_adj <- (var_num_eph_season)/(var_num_eph_season + var_num_eph_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_num_eph_str <- (var_num_eph_stream)/(var_num_eph_fix + var_num_eph_stream + var_num_eph_obs)

ICC_num_eph_sea <- (var_num_eph_season)/(var_num_eph_fix + var_num_eph_season + var_num_eph_obs)
```

### Mean number Plecoptera per site and season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```

#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)  

for(j in 1:length(lambda))
{
lmm_num_ple <- glmmLasso(log_number_Plecoptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500))
  BIC_vec[j]<-lmm_num_ple$bic
  Delta.start<-rbind(Delta.start,lmm_num_ple$Deltamatrix[lmm_num_ple$conv.step,])
  Q.start <- rbind(Q.start,lmm_num_ple$Q_long[[lmm_num_ple$conv.step+1]])
}

opt_num_ple<-which.min(BIC_vec)

lmm_num_ple_final <- glmmLasso(log_number_Plecoptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_num_ple],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_num_ple,],q_start=Q.start[(2*opt_num_ple+1):(2*opt_num_ple+2),], steps = 1500)) 

summary(lmm_num_ple_final)
```

#### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_num_ple <- lmm_num_ple_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_num_ple <-  lmm_num_ple_final$y - F_num_ple

plot(x = F_num_ple, y = E_num_ple, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance not okay

qreference(E_num_ple, nrep = 8) # normality not okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_num_ple_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_num_ple^2)/(N-p) # okay
```

#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_num_ple <- lmm_num_ple_final$coefficients# estimated regression parameters LMM
beta_num_ple <- beta_num_ple[c(1,2)] # remove variables, which are not in final model (=0)

X_num_ple <- model.matrix(~max_sumTU_ms_pyr, data = data_env_scale) # model matrix LMM, first column only 1 for intercept, other columns fixed effects

var_num_ple_fix <- var(as.vector(X_num_ple %*% beta_num_ple))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_num_ple_stream <- (as.numeric(lmm_num_ple_final[["StdDev"]][1] ))^2
var_num_ple_season <- (as.numeric(lmm_num_ple_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance
```{r, message =FALSE, warning= FALSE}
var_num_ple_obs <- var(E_num_ple)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_ple_mar <- (var_num_ple_fix)/(var_num_ple_fix + var_num_ple_stream + var_num_ple_season + var_num_ple_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_ple_con <- (var_num_ple_fix + var_num_ple_stream + var_num_ple_season)/(var_num_ple_fix + var_num_ple_stream + var_num_ple_season + var_num_ple_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_num_ple_str_adj <- (var_num_ple_stream)/(var_num_ple_stream + var_num_ple_obs)

ICC_num_ple_sea_adj <- (var_num_ple_season)/(var_num_ple_season + var_num_ple_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_num_ple_str <- (var_num_ple_stream)/(var_num_ple_fix + var_num_ple_stream + var_num_ple_obs)

ICC_num_ple_sea <- (var_num_ple_season)/(var_num_ple_fix + var_num_ple_season + var_num_ple_obs)
```

### Mean Number Trichoptera per site an season
Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = gaussian(link = "identity")
```

#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 
Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)  

for(j in 1:length(lambda))
{
lmm_num_tri <- glmmLasso(log_number_Trichoptera~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500))   
BIC_vec[j]<-lmm_num_tri$bic
  Delta.start<-rbind(Delta.start,lmm_num_tri$Deltamatrix[lmm_num_tri$conv.step,])
  Q.start <- rbind(Q.start,lmm_num_tri$Q_long[[lmm_num_tri$conv.step+1]])
}

opt_num_tri<-which.min(BIC_vec)

lmm_num_tri_final <- glmmLasso(log_number_Trichoptera~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_num_tri],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_num_tri,],q_start=Q.start[(2*opt_num_tri+1):(2*opt_num_tri+2),], steps = 1500)) 

summary(lmm_num_tri_final)
```

#### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_num_tri <- lmm_num_tri_final[["fitted.values"]]
# Residual = observed y – predicted y (function "resid" does not work here)
E_num_tri <-  lmm_num_tri_final$y - F_num_tri

plot(x = F_num_tri, y = E_num_tri, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance could be better

qreference(E_num_tri, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- lmm_num_tri_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_num_tri^2)/(N-p) # okay
```

#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_num_tri<- lmm_num_tri_final$coefficients# estimated regression parameters lognormal GLMM
beta_num_tri <- beta_num_tri[c(1,7)] # remove variables, which are not in final model (=0)

X_num_tri <- model.matrix(~ conductivity, data = data_env_scale) # model matrix LN GLMM, first column only 1 for intercept, other columns fixed effects

var_num_tri_fix <- var(as.vector(X_num_tri %*% beta_num_tri))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_num_tri_stream <- (as.numeric(lmm_num_tri_final[["StdDev"]][1] ))^2
var_num_tri_season <- (as.numeric(lmm_num_tri_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance
```{r, message =FALSE, warning= FALSE}
var_num_tri_obs <- var(E_num_tri)
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_tri_mar <- (var_num_tri_fix)/(var_num_tri_fix + var_num_tri_stream + var_num_tri_season + var_num_tri_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_num_tri_con <- (var_num_tri_fix + var_num_tri_stream + var_num_tri_season)/(var_num_tri_fix + var_num_tri_stream + var_num_tri_season + var_num_tri_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_num_tri_str_adj <- (var_num_tri_stream)/(var_num_tri_stream + var_num_tri_obs)

ICC_num_tri_sea_adj <- (var_num_tri_season)/(var_num_tri_season + var_num_tri_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_num_tri_str <- (var_num_tri_stream)/(var_num_tri_fix + var_num_tri_stream + var_num_tri_obs)

ICC_num_tri_sea <- (var_num_tri_season)/(var_num_tri_fix + var_num_tri_season + var_num_tri_obs)
```

## GLMM for number of EPT families
Check if normal distribution is okay
```{r, message =FALSE, warning= FALSE}
par(mfrow = c(2,2))

qqp(data_env_1$number_EPT, "norm")

poisson <- fitdistr(data_env_1$number_EPT, "Poisson")

qqp(data_env_1$number_EPT, "pois", lambda = poisson$estimate)

gamma <- fitdistr(data_env_1$number_EPT, "gamma")
qqp(data_env_1$number_EPT, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

par(mfrow = c(1,1))
```
poisson looks okay

### Model specification Poisson distribution

* Y is number of EPT families
* E is mean/expected value of a variable
* var is variance of a variable
* max_sumTU_ms_pyr, NO3, PO4, water_temp, pools, conductivity are fixed factors used at beginning for Lasso model selection
* stream and season are random factors (here random intercepts)

$$ Y{_{ikl}} \sim Poisson(\mu{_{ikl}}) $$
$$ E(Y{_{ikl}}) = \lambda $$
$$ var(Y{_{ikl}}) = \lambda $$
* Model, if all variables included:

$$ log(\mu{_{il}}) =  \beta_1 + \beta_2 \cdot max\_sumTU\_ms\_pyr{_{il}} + \beta_3 \cdot NO3{_{il}} + \beta_4 \cdot  PO4{_{il}} + \beta_5 \cdot water\_temp{_{il}} + \beta_6 \cdot  pools{_{il}} + \beta_7 \cdot conductivity{_{il}} + stream{_{l}} + season{_{i}} $$
$$ stream{_{l}} \sim N(0, \sigma{_{stream}}^2) $$


$$ season{_{i}} \sim N(0, \sigma{_{season}}^2) $$

Set lambdas to test (500-0, changing in steps of 5)
```{r, message =FALSE, warning= FALSE}
lambda <- seq(500,0,by=-5) 
```
Define family
```{r, message =FALSE, warning= FALSE}
family = poisson(link = "log")
```

#### Fit model
```{r, message=FALSE, warning=FALSE}
BIC_vec<-rep(Inf,length(lambda))
```
Starting values for first fit must be specified: IMPORTANT that Delta.start has suitable length
```{r, message=FALSE, warning=FALSE}
Delta.start<-as.matrix(t(rep(0,1+8+20+3))) 

Q.start <- matrix(c(0.1, 0, 0, 0.1), byrow = FALSE, nrow = 2)

for(j in 1:length(lambda))
{
glmm_ept <- glmmLasso(number_EPT~1 + max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc,  
                    rnd = list(stream = ~ 1, season = ~ 1),
                    family = family, data = data_env_scale, 
                    lambda=lambda[j], switch.NR=F,final.re=TRUE,
                    control = list(start=Delta.start[j,], 
                              q_start = Q.start[(j+(j-1)):(2*j),],   
                              steps = 1500))  
 BIC_vec[j]<-glmm_ept$bic
  Delta.start<-rbind(Delta.start,glmm_ept$Deltamatrix[glmm_ept$conv.step,])
  Q.start <- rbind(Q.start,glmm_ept$Q_long[[glmm_ept$conv.step+1]])
}

opt_ept<-which.min(BIC_vec)

glmm_ept_final <- glmmLasso(number_EPT~max_sumTU_ms_pyr + NO3 + PO4 + water_temp + pools + conductivity + shading + o2_perc, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_ept],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_ept,],q_start=Q.start[(2*opt_ept+1):(2*opt_ept+2),]# 2x2 matrix for every model: number of model*2 and add one (because of q.start set at beginning) to get right Q.start
                                       , steps = 1500))  

summary(glmm_ept_final)
```

#### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_ept <- fitted(glmm_ept_final)
# Residual = observed y – predicted y (function "resid" does not work here)
E_ept <-  glmm_ept_final$y - F_ept

plot(x = F_ept, y = E_ept, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance okay

qreference(E_ept, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size
p <- glmm_ept_final$fixerror
p <- p[!is.na(p)]
p <- length(p) # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_ept^2)/(N-p) # okay
```

#### Coefficients of determination and ICC
##### Estimante variance form fixed effects
```{r, message=FALSE, warning=FALSE}
beta_ept <- glmm_ept_final$coefficients# estimated regression parameters Poisson GLMM
beta_ept <- beta_ept[c(1,2,4)]

X_ept <- model.matrix(~ max_sumTU_ms_pyr + PO4, data = data_env_scale) # model matrix LN GLMM, first column only 1 for intercept, other columns fixed effects

var_ept_fix <- var(as.vector(X_ept %*% beta_ept))
```

##### Get variance from random effects
```{r, message=FALSE, warning=FALSE}
var_ept_stream <- (as.numeric(glmm_ept_final[["StdDev"]][1] ))^2
var_ept_season <- (as.numeric(glmm_ept_final[["StdDev"]][2] ))^2
```

##### Estimate observation level variance

$$\sigma^2_\epsilon = \frac {1} {\lambda} $$

* First estimate $\lambda$

$$E(\lambda) = exp(\beta_0 + 0.5 \sigma^2_\tau) $$

* E = expected value (mean) on observed scale

* $\beta_0$ mean value on latent scale, i.e. $\beta_0$ from intercept only model

* $\sigma^2_\tau$ total variance on latent scale

```{r, message =FALSE, warning= FALSE}
# Fit null model without fixed effects (but including all random effects)
glmm_ept_0 <- glmmLasso(number_EPT~ pools, rnd = list(stream = ~ 1, season = ~ 1),  
                        family = family, data = data_env_scale, lambda=lambda[opt_ept],
                        switch.NR=F,final.re=TRUE,
                        control = list(start=Delta.start[opt_ept,],q_start=Q.start[(2*opt_ept+1):(2*opt_ept+2),], steps = 1500))

summary(glmm_ept_0) # NO3, conductivity, pools result in same model (same intercept and rnd. effects), so use this as null model

beta_ept_0 <- glmm_ept_0$coefficients[1]

lambda <- as.numeric(exp(beta_ept_0 + 0.5 * ((as.numeric(glmm_ept_0[["StdDev"]][1]))^2) + (as.numeric((glmm_ept_0[["StdDev"]][1]))^2)))

# getting the observation-level variance Null model
var_ept_obs <- 1/lambda
```

##### Marginal coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_ept_mar <- (var_ept_fix)/(var_ept_fix + var_ept_stream + var_ept_season + var_ept_obs)
```

##### Conditional coefficient of determination
```{r, message =FALSE, warning= FALSE}
R_ept_con <- (var_ept_fix + var_ept_stream + var_ept_season)/(var_ept_fix + var_ept_stream + var_ept_season + var_ept_obs)
```

##### ICC adjusted
```{r, message =FALSE, warning= FALSE}
ICC_ept_str_adj <- (var_ept_stream)/(var_ept_stream + var_ept_obs)

ICC_ept_sea_adj <- (var_ept_season)/(var_ept_season + var_ept_obs)
```

##### ICC
```{r, message =FALSE, warning= FALSE}
ICC_ept_str <- (var_ept_stream)/(var_ept_fix + var_ept_stream + var_ept_obs)

ICC_ept_sea <- (var_ept_season)/(var_ept_fix + var_ept_season + var_ept_obs)
```

## Export (G)LMM output
R^2 and ICC
```{r, message =FALSE, warning= FALSE}
model <- c("lmm_bio", "lmm_bio_dip", "lmm_bio_eph", "lmm_bio_ple", "lmm_bio_tri", "lmm_num", "lmm_num_dip", "lmm_num_eph", "lmm_num_ple", "lmm_num_tri","glmm_ept")

R_mar <- c(R_bio_mar, R_bio_dip_mar, R_bio_eph_mar, R_bio_ple_mar, R_bio_tri_mar, R_num_mar, R_num_dip_mar, R_num_eph_mar, R_num_ple_mar, R_num_tri_mar, R_ept_mar)

R_con <- c(R_bio_con, R_bio_dip_con, R_bio_eph_con, R_bio_ple_con, R_bio_tri_con, R_num_con, R_num_dip_con, R_num_eph_con, R_num_ple_con, R_num_tri_con, R_ept_con)

ICC_str_adj <- c(ICC_bio_str_adj, ICC_bio_dip_str_adj, ICC_bio_eph_str_adj, ICC_bio_ple_str_adj, ICC_bio_tri_str_adj, ICC_num_str_adj, ICC_num_dip_str_adj, ICC_num_eph_str_adj, ICC_num_tri_str_adj, ICC_num_ple_str_adj, ICC_ept_str_adj)

ICC_sea_adj <- c(ICC_bio_sea_adj, ICC_bio_dip_sea_adj, ICC_bio_eph_sea_adj, ICC_bio_ple_sea_adj, ICC_bio_tri_sea_adj, ICC_num_sea_adj, ICC_num_dip_sea_adj, ICC_num_eph_sea_adj, ICC_num_tri_sea_adj, ICC_num_ple_sea_adj, ICC_ept_sea_adj)

ICC_str <- c(ICC_bio_str, ICC_bio_dip_str, ICC_bio_eph_str, ICC_bio_ple_str, ICC_bio_tri_str, ICC_num_str, ICC_num_dip_str, ICC_num_eph_str, ICC_num_tri_str, ICC_num_ple_str, ICC_ept_str)

ICC_sea <- c(ICC_bio_sea, ICC_bio_dip_sea, ICC_bio_eph_sea, ICC_bio_ple_sea, ICC_bio_tri_sea, ICC_num_sea, ICC_num_dip_sea, ICC_num_eph_sea, ICC_num_tri_sea, ICC_num_ple_sea, ICC_ept_sea)

R_ICC <- as.data.frame(cbind(model, R_mar, R_con, ICC_str, ICC_str_adj, ICC_sea, ICC_sea_adj))
```
Coefficients
```{r, message =FALSE, warning= FALSE}
coef_bio <- lmm_bio_final[["coefficients"]]
coef_bio_dip <- lmm_bio_dip_final[["coefficients"]]
coef_bio_eph <- lmm_bio_eph_final[["coefficients"]]
coef_bio_ple <- lmm_bio_ple_final[["coefficients"]]
coef_bio_tri <- lmm_bio_tri_final[["coefficients"]]

coef_num <- lmm_num_final[["coefficients"]]
coef_num_dip <- lmm_num_dip_final[["coefficients"]]
coef_num_eph <- lmm_num_eph_final[["coefficients"]]
coef_num_ple <- lmm_num_ple_final[["coefficients"]]
coef_num_tri <- lmm_num_tri_final[["coefficients"]]

coef_ept <- glmm_ept_final[["coefficients"]]
```
Standard errors
```{r, message =FALSE, warning= FALSE}
se_bio <- lmm_bio_final[["fixerror"]]
se_bio_dip <- lmm_bio_dip_final[["fixerror"]]
se_bio_eph <- lmm_bio_eph_final[["fixerror"]]
se_bio_ple <- lmm_bio_ple_final[["fixerror"]]
se_bio_tri <- lmm_bio_tri_final[["fixerror"]]

se_num <- lmm_num_final[["fixerror"]]
se_num_dip <- lmm_num_dip_final[["fixerror"]]
se_num_eph <- lmm_num_eph_final[["fixerror"]]
se_num_ple <- lmm_num_ple_final[["fixerror"]]
se_num_tri <- lmm_num_tri_final[["fixerror"]]

se_ept <- glmm_ept_final[["fixerror"]]
```
Create dataframe
```{r, message =FALSE, warning= FALSE}
model_summary <- as.data.frame(rbind(coef_bio, coef_bio_dip, coef_bio_eph, coef_bio_ple, coef_bio_tri, coef_num, coef_num_dip, coef_num_eph, coef_num_ple, coef_num_tri, coef_ept))
model_summary <- model_summary[,-c(3,9)]
model_summary$model <- model
names(model_summary)[1] <- c("intercept")
model_summary <-  melt(model_summary, id.vars = c("model"))
model_summary <- filter(model_summary, value != 0)

se <- as.data.frame(rbind(se_bio, se_bio_dip, se_bio_eph, se_bio_ple, se_bio_tri, se_num, se_num_dip, se_num_eph, se_num_ple, se_num_tri, se_ept))
se <- se[,-c(3,9)]
se$model <- model
names(se)[1] <- c("intercept")
se <-  melt(se, id.vars = c("model"))
names(se)[3] <- c("se")
se <- filter(se, !is.na(se))

model_summary <- left_join(model_summary, se, by=c("model", "variable"))
```
Data for plotting
```{r, message =FALSE, warning= FALSE}
plot_glmm_data <- model_summary

plot_glmm_data$CI_up <- plot_glmm_data$value + 1.959964*plot_glmm_data$se
plot_glmm_data$CI_down <- plot_glmm_data$value - 1.959964*plot_glmm_data$se

plot_glmm_data$variable <- gsub("water_temp" , "water temperature" , plot_glmm_data$variable)

plot_glmm_data$variable <- gsub("max_sumTU_ms_pyr" , "toxicity" , plot_glmm_data$variable)

plot_glmm_data$variable <- gsub("PO4" , "phosphate" , plot_glmm_data$variable)

plot_glmm_data$variable <- factor(plot_glmm_data$variable, levels = c("intercept", "toxicity", "phosphate",  "water temperature", "conductivity", "shading", "pools"))
```
## Export data
```{r, message =FALSE, warning= FALSE}
sd_stream <- c(lmm_bio_final[["StdDev"]][[1]], lmm_bio_dip_final[["StdDev"]][[1]], lmm_bio_eph_final[["StdDev"]][[1]], lmm_bio_ple_final[["StdDev"]][[1]], lmm_bio_tri_final[["StdDev"]][[1]], lmm_num_final[["StdDev"]][[1]], lmm_num_dip_final[["StdDev"]][[1]], lmm_num_eph_final[["StdDev"]][[1]], lmm_num_ple_final[["StdDev"]][[1]], lmm_num_tri_final[["StdDev"]][[1]], glmm_ept_final[["StdDev"]][[1]])

sd_season <- c(lmm_bio_final[["StdDev"]][[2]], lmm_bio_dip_final[["StdDev"]][[2]], lmm_bio_eph_final[["StdDev"]][[2]], lmm_bio_ple_final[["StdDev"]][[2]], lmm_bio_tri_final[["StdDev"]][[2]], lmm_num_final[["StdDev"]][[2]], lmm_num_dip_final[["StdDev"]][[2]], lmm_num_eph_final[["StdDev"]][[2]], lmm_num_ple_final[["StdDev"]][[2]], lmm_num_tri_final[["StdDev"]][[2]], glmm_ept_final[["StdDev"]][[2]])

R_ICC$sd_stream <- sd_stream
R_ICC$sd_season <- sd_season

model_summary <- left_join(model_summary, R_ICC, by = "model")

#write.csv(model_summary, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/model_summary.csv")
```
## Plots
```{r, message =FALSE, warning= FALSE}
lmm_bio_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Total biomass", x="", y="") +
  xlim(-6,6) 

lmm_bio_dip_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_dip",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_dip",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable))+
labs(title = "Flies (Diptera) biomass", x="", y="") +
  xlim(-6,6) 

lmm_bio_eph_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_eph",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_eph",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable))+
labs(title = "Mayflies (Ephemeroptera) biomass", x="", y="") +
  xlim(-6,6) 

lmm_bio_ple_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_ple",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_ple",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Stoneflies (Plecoptera) biomass", x="", y="")  +
 xlim(-6,6) 
 
lmm_bio_tri_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_tri",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_bio_tri",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Caddisflies (Trichoptera) biomass", x="", y="") +
  xlim(-6,6) 

lmm_num_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_num",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_num",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Total abundance", x="", y="") +
  xlim(-6,6) 

lmm_num_dip_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_dip",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_dip",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Flies (Diptera) abundance", x="", y="") +
  xlim(-6,6) 

lmm_num_eph_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_eph",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_eph",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Mayflies (Ephemeroptera) abundance", x="", y="") +
  xlim(-6,6)

lmm_num_ple_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_ple",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_ple",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Stoneflies (Plecoptera) abundance", x="", y="") +
  xlim(-6,6) 
  
lmm_num_tri_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_tri",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "lmm_num_tri",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Caddisflies (Trichoptera) abundance", x="", y="") +
  xlim(-6,6) 

glmm_ept_plot <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=plot_glmm_data[plot_glmm_data$model == "glmm_ept",], aes(x = value, y = variable)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=plot_glmm_data[plot_glmm_data$model == "glmm_ept",], aes(xmin=CI_down, xmax=CI_up, x=value, y=variable)) +
labs(title = "Number EPT families", x="", y="") +
  xlim(-6,6) 

lmm_plot <- ggarrange(lmm_bio_plot, lmm_bio_dip_plot, lmm_bio_eph_plot, 
                      lmm_bio_ple_plot, lmm_bio_tri_plot, 
                      lmm_num_plot, lmm_num_dip_plot, lmm_num_eph_plot, 
                      lmm_num_ple_plot, lmm_num_tri_plot,
                  glmm_ept_plot,
                  labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K"),
                  ncol = 5, nrow = 3, align = "hv")

lmm_plot
```

# Check if number of families differs between forest and agriculture

## Number all families (Diptera, EPT)
Check if normal distribution is okay
```{r, message =FALSE, warning= FALSE}
par(mfrow = c(2,2))

qqp(data_env_scale$number_fam, "norm")

poisson <- fitdistr(data_env_scale$number_fam, "Poisson")

qqp(data_env_scale$number_fam, "pois", lambda = poisson$estimate)

gamma <- fitdistr(data_env_scale$number_fam, "gamma")
qqp(data_env_scale$number_fam, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

par(mfrow = c(1,1))
```
poisson looks okay

```{r, message =FALSE, warning= FALSE}
library(glmmTMB)
```
Define family
```{r, message =FALSE, warning= FALSE}
family = poisson(link = "log")
```

### Fit model
```{r, message=FALSE, warning=FALSE}
num_fam <-glmmTMB(number_fam ~ position + (1 | stream) + (1|season), family = family, data = data_env_scale)

summary(num_fam)
```

### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_fam_num <- fitted(num_fam)
E_fam_num <- resid(num_fam)

plot(x = F_fam_num, y = E_fam_num, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance okay

qreference(E_fam_num, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size

p <- 2 # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_fam_num^2)/(N-p) # okay
```

### CI to check if significant
```{r, message=FALSE, warning=FALSE}
confint(num_fam, c(2), level = 0.95) # includes 0 -> not significant
```

## Number of EPT families

Poisson okay, same data as in GLMM to identify driver for number EPT families

Define family
```{r, message =FALSE, warning= FALSE}
family = poisson(link = "log")
```

### Fit model
```{r, message=FALSE, warning=FALSE}
num_ept <-glmmTMB(number_EPT ~ position + (1 | stream) + (1|season), family = family, data = data_env_scale)

summary(num_ept)
```

### Model diagnostic
Distribution and variance
```{r, message=FALSE, warning=FALSE}
F_num_ept <- fitted(num_ept)
E_num_ept <- resid(num_ept)

plot(x = F_num_ept, y = E_num_ept, xlab = "Fitted values", ylab = "Pearson residuals")
abline(h = 0, lty = 2) # variance okay

qreference(E_num_ept, nrep = 8) # normality okay
```
Dispersion
```{r, message=FALSE, warning=FALSE}
N <- nrow(data_env_scale) # sample size

p <- 2 # number of parameters (here fixed factors and intercept, in literature discussion, if random factors included or not)
sum(E_num_ept^2)/(N-p) # okay
```

### CI to check if significant
```{r, message=FALSE, warning=FALSE}
confint(num_ept, c(2), level = 0.95) # includes 0 -> not significant
```

## Export output
Coefficients, standard errors, z-values
```{r, message =FALSE, warning= FALSE}
summary_num_fam <- summary(num_fam)
coef_num_fam <- summary_num_fam[["coefficients"]]$cond
coef_num_fam <- as.data.frame(coef_num_fam)
coef_num_fam$Parameter <- c("Intercept", "Land use")
coef_num_fam <- coef_num_fam[,-c(4)]
coef_num_fam$Model <- c("Number all families")

summary_num_ept <- summary(num_ept)
coef_num_ept <- summary_num_ept[["coefficients"]]$cond
coef_num_ept <- as.data.frame(coef_num_ept)
coef_num_ept$Parameter <- c("Intercept", "Land use")
coef_num_ept <- coef_num_ept[,-c(4)]
coef_num_ept$Model <- c("Number EPT families")

coef_num_fam_ept <- rbind(coef_num_fam, coef_num_ept)
```
Add sd from random effects
```{r, message =FALSE, warning= FALSE}
sd_rnd_num_fam <- summary_num_fam[["varcor"]]
sd_rnd_num_fam <- sd_rnd_num_fam[["cond"]]
sd_rnd_num_fam <- as.data.frame(sd_rnd_num_fam) # extracts variance
sd_rnd_num_fam$`X.Intercept.` <- sqrt(sd_rnd_num_fam$`X.Intercept.`) # get sd
sd_rnd_num_fam$`X.Intercept..1` <- sqrt(sd_rnd_num_fam$`X.Intercept..1`) # get sd
names(sd_rnd_num_fam)[1] <- c("sd_stream") 
names(sd_rnd_num_fam)[2] <- c("sd_season") 
sd_rnd_num_fam$Model <- c("Number all families")

sd_rnd_num_ept <- summary_num_ept[["varcor"]]
sd_rnd_num_ept <- sd_rnd_num_ept[["cond"]]
sd_rnd_num_ept <- as.data.frame(sd_rnd_num_ept) # extracts variance
sd_rnd_num_ept$`X.Intercept.` <- sqrt(sd_rnd_num_ept$`X.Intercept.`) # get sd
sd_rnd_num_ept$`X.Intercept..1` <- sqrt(sd_rnd_num_ept$`X.Intercept..1`) # get sd
names(sd_rnd_num_ept)[1] <- c("sd_stream") 
names(sd_rnd_num_ept)[2] <- c("sd_season") 
sd_rnd_num_ept$Model <- c("Number EPT families")

sd_rnd_num_fam_ept <- rbind(sd_rnd_num_fam, sd_rnd_num_ept)
```
CI 
```{r, message =FALSE, warning= FALSE}
CI_num_fam <- as.data.frame(confint(num_fam, c(1,2),level = 0.95))
CI_num_fam$Model <- c("Number all families")

CI_num_ept <- as.data.frame(confint(num_ept, c(1,2),level = 0.95))
CI_num_ept$Model <- c("Number EPT families")

CI_num_fam_ept <- rbind(CI_num_fam, CI_num_ept)
```
Bind outputs and rename columns
```{r, message =FALSE, warning= FALSE}
model_summary_num <- merge(coef_num_fam_ept, CI_num_fam_ept, by = c("Model","Estimate"))

model_summary_num <- merge(model_summary_num, sd_rnd_num_fam_ept, by = c("Model"))

names(model_summary_num)[3] <- c("Standard error")
names(model_summary_num)[4] <- c("z-value")
names(model_summary_num)[6] <- c("lower_CI")
names(model_summary_num)[7] <- c("upper_CI")
```
Export data
```{r, message =FALSE, warning= FALSE}
#write.csv(model_summary_num, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/statistics_biomass_emergence/model_summary_num.csv")
```
## Plots
```{r, message =FALSE, warning= FALSE}
plot_num_fam <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=model_summary_num[model_summary_num$Model == "Number all families",], aes(x = Estimate, y = Parameter)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=model_summary_num[model_summary_num$Model == "Number all families",], aes(xmin=lower_CI, xmax=upper_CI, x=Estimate, y=Parameter)) +
labs(title = "Number all families", x="", y="") +
  xlim(-2.4,2.4) 

plot_num_ept <- ggplot() +
  theme_classic() + 
  theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=10)) +
  geom_point(data=model_summary_num[model_summary_num$Model == "Number EPT families",], aes(x = Estimate, y = Parameter)) +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  geom_linerange(data=model_summary_num[model_summary_num$Model == "Number EPT families",], aes(xmin=lower_CI, xmax=upper_CI, x=Estimate, y=Parameter)) +
labs(title = "Number EPT families", x="", y="") +
  xlim(-2.4,2.4) 

plot_num_fam_ept <- ggarrange(plot_num_fam, plot_num_ept,
                  labels = c("A", "B"),
                  ncol = 2, nrow = 1, align = "hv")

plot_num_fam_ept
```
