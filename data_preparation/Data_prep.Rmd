---
title: "Land use changes biomass and temporal patterns of insect cross-ecosystem flows: data preparation"
output:
  html_document:
    figure_caption: yes
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: '4'
  word_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80), tidy=TRUE)
```
# Required packages for data wrangling and plots
```{r, message=FALSE, warning=FALSE}
library(dplyr) # Data wrangling
library(tidyr) # Data wrangling
library(plyr) # Data wrangling
library(data.table) # Data wrangling
library(reshape) # Look at data
library(ggplot2) # plots
library(ggpubr) # plots
```
# Load abundance data
You need to replace this line with a path on your computer
```{r, message=FALSE, warning=FALSE}
emergence <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_abundance_data/emergence_identification_92.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
#View(emergence)

emergence_NA_zero <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_abundance_data/emergence_NA_0_92.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
#View(emergence_NA_zero)
```
Up in forest and down in vine
```{r, message=FALSE, warning=FALSE}
emergence$position[emergence$position=="up"]  <- "forest"
emergence$position[emergence$position=="down"]  <- "vine"

emergence_NA_zero$position[emergence_NA_zero$position=="up"]  <- "forest"
emergence_NA_zero$position[emergence_NA_zero$position=="down"]  <- "vine"
```
Adjust column trap in table emergence:
At some sites much emergence was collected, so that it did not fit in one Eppi and the sample was split into several Eppis (usually 2) -> labelled as 1.1 and 1.2 or 2.1 and 2.2 and similar ways. Put these all into 1 or 2
```{r, message=FALSE, warning=FALSE}
unique(emergence$trap)
emergence$trap[emergence$trap == "2.1"] <- "2"
emergence$trap[emergence$trap == "2.2"] <- "2"
emergence$trap[emergence$trap == "11"] <- "1"
emergence$trap[emergence$trap == "1.2"] <- "1"
emergence$trap[emergence$trap == "1.1"] <- "1"
emergence$trap[emergence$trap == "T2"] <- "2"
emergence$trap[emergence$trap == "A"] <- "2"
unique(emergence$trap)
```
Convert trap into integer, because in emergence_NA_zero it also is integer and it must be same format to merge these tables later
```{r, message=FALSE, warning=FALSE}
emergence$trap <- as.integer(emergence$trap)
```
Correct wrong time in table
* 2018-06-30 Dierbach vine trap 2: right date is 2018-07-30, since no emergence was collected on the 30th of June and on the 30th of July Dierbach vine trap 2 is missing and at this date there was emergence collected (NOT ermegence = 0 or NA)
```{r, message=FALSE, warning=FALSE}
emergence$time[emergence$time == "2018-06-30"] <- "2018-07-30"
```
Convert date into data format
```{r, message=FALSE, warning=FALSE}
emergence_NA_zero$date <- as.Date(emergence_NA_zero$date, "%d/%m/%y")
emergence$time <- as.Date(emergence$time,format="%Y-%m-%d")
```
Convert number of organisms to numeric in emergence table
```{r, message=FALSE, warning=FALSE}
emergence$number <- as.numeric(emergence$number)
```
NAs, in terrestrial samples, so no problem:
184	Hainbach    up	  1	2018-04-16	Sonstige						NA	Collembola
217	Hainbach	  down	2	2018-04-19	Coleoptera					
362	Kaiserbach	down	1	2018-04-19	Sonstige						NA	thysanoptera

Correct spelling error "BaEtis" 
```{r, message=FALSE, warning=FALSE}
unique(emergence$genus)
emergence$genus <- gsub("BaEtis" , "Baetis" , emergence$genus)

emergence$family <- gsub("Psychomyidae", "Psychomyiidae", emergence$family)

emergence$family <- gsub("Glossomatidae", "Glossosomatidae", emergence$family)
```

## How many samples collected and specimes identified
How many samples collected?
```{r, message=FALSE, warning=FALSE}
emergence <- unite(emergence, "no_samples", "stream", "position", "trap", "time", remove = FALSE)
length(unique(emergence$no_samples)) # 1848 samples (one NA) -> without NA: 1847
length(unique(emergence[emergence$position == "forest",2])) # 944 samples (one NA) -> without NA: 943
length(unique(emergence[emergence$position == "vine",2])) # 905 samples (one NA) -> without NA: 904

round(100/943*904, digit = 0) # vine 4 % less samples

emergence <- select(emergence, -c("no_samples"))
```
How many specimens identified?
```{r, message=FALSE, warning=FALSE}
sum(emergence$number, na.rm = TRUE) # 45831
```

## Get samples where emergence = 0 
Get samples from emergence, with emergence = 0
```{r, message=FALSE, warning=FALSE}
emergence$order[emergence$order == "keine Emergenz nur Dreck"] <- "no emergence"

emergence$order[emergence$order == "keine Emergenz nur dreck"] <- "no emergence"

emergence_zero <- filter(emergence, order =="no emergence")
emergence_zero <- select(emergence_zero, c("stream", "position", "trap", "time"))
```
Hainbach	down	2	2018-05-07	Nichts drin: wrongly labelled, because at Hainbach down 2 on the same date there was emergence in the sample
```{r, message=FALSE, warning=FALSE}
emergence <- filter(emergence, order != "Nichts drin")
emergence <- filter(emergence, order != "no emergence")
```
Get samples (sites and dates), where emergence = 0 from table emergence_NA_zero
```{r, message=FALSE, warning=FALSE}
#unique(emergence_NA_zero$comment_1)
emergence_NA_zero <- arrange(emergence_NA_zero, desc(comment_1))
emergence_NA_zero <- emergence_NA_zero[1:227,] # rows containing comments
emergence_zero_1 <- filter(emergence_NA_zero, comment_1 =="no emergence")
```
Rename columns in emergence_zero, so that the names are the same as in emergence
```{r, message=FALSE, warning=FALSE}
names(emergence_zero_1)[4] <- c("time")
names(emergence_zero_1)[6] <- c("comment")
names(emergence_zero_1)[5] <- c("label.on.Eppi..y.n.")
names(emergence_zero_1)[7] <- c("same.as.in.table")
names(emergence_zero_1)[8] <- c("X")
```
Add number = 0 and order in table emergence_zero
```{r, message=FALSE, warning=FALSE}
emergence_zero <- bind_rows(emergence_zero_1, emergence_zero)

emergence_zero$Diptera <- with(emergence_zero, 0)
emergence_zero$Ephemeroptera <- with(emergence_zero, 0)
emergence_zero$Plecoptera <- with(emergence_zero, 0)
emergence_zero$Trichoptera <- with(emergence_zero, 0)
emergence_zero <- gather(emergence_zero, key = "order", value = "number", 12:15)
```
Add ID in table emergence_zero
```{r, message=FALSE, warning=FALSE}
emergence_zero$ID <- with(emergence_zero, c(6308:6479))
```
Put table in same format as table emergence
```{r, message=FALSE, warning=FALSE}
emergence_zero <- select(emergence_zero, -c("number.samples", "noch.zu.bestimmen", "X..bestimmt"))
```
Add column aquatic (y/n)
```{r, message=FALSE, warning=FALSE}
emergence$aquatic <- with(emergence, ifelse(family %in% c("Empididae","Ceratopogonidae","Chaoboridae","Chironomidae","Culicidae","Dixidae","Limoniidae","Psychodidae","Ptychopteridae","Simuliidae","Tipulidae")  |  order %in% c("Ephemeroptera","Odonata","Plecoptera","Trichoptera","no emergence"),"y","n"))

emergence_zero$aquatic <- with(emergence_zero, "y")
```
Merge emergence and emergence_zero table
```{r, message=FALSE, warning=FALSE}
emergence <- bind_rows(emergence,emergence_zero) 
#View(is.na(emergence$number)) # NAs in number not for aquatic emergent insects, just Coleoptera and sonstige
```
Add season
* 22 March - 16 May 2018 as spring
* 17 May - 26 July 2018 as summer
* 27 July - 13 2018 September as autumn
```{r, message=FALSE, warning=FALSE}
emergence$season <-with(emergence, ifelse(time > "2018-03-21" & time <= "2018-05-16","spring",ifelse(time > "2018-05-16" & time <= "2018-07-26","summer","autumn")))
emergence$season <- as.factor(emergence$season)
```
# Biomass and number data
```{r, message=FALSE, warning=FALSE}
biomass_emergence <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_abundance_data/biomass_emergence_93.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)

trap_days <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_abundance_data/no_trap_days.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
```
## Forest and vine

* up in forest

* down in vine
```{r, message=FALSE, warning=FALSE}
biomass_emergence$position[biomass_emergence$position=="up"]  <- "forest"
biomass_emergence$position[biomass_emergence$position=="down"]  <- "vine"

trap_days$Position[trap_days$Position=="up"]  <- "forest"
trap_days$Position[trap_days$Position=="down"]  <- "vine"
```

## Get collection days per sample
Convert data table into right form
```{r, message=FALSE, warning=FALSE}
colnames_trap_days <- c(colnames(trap_days))
colnames_trap_days <- (gsub('X', '', colnames_trap_days))
names(trap_days) <- colnames_trap_days
trap_days <- gather(trap_days, key = "Date", value = "collection_days", 4:182)
trap_days <- unite(trap_days,"site","Stream","Position",remove=FALSE)

trap_days_NA <- trap_days
```
Remove not needed rows 
```{r, message=FALSE, warning=FALSE}
trap_days <- filter(trap_days, collection_days != "y",  collection_days != "y*", collection_days != "n")
```
Convert date into data format
```{r, message=FALSE, warning=FALSE}
trap_days$Date <- as.Date(trap_days$Date, "%d.%m.%Y")
```
Convert collection_days from character into numberic
```{r, message=FALSE, warning=FALSE}
trap_days$collection_days <- as.numeric(trap_days$collection_days)
```
Add area of traps in m^2
```{r, message=FALSE, warning=FALSE}
trap_days$area_trap <- with(trap_days, 0.25) 
```

##  Prepare biomass data
Rename column dry.mass..mg.
```{r, message=FALSE, warning=FALSE}
names(biomass_emergence)[12] <- c("dry_mass_emergence_mg")
```
Put correct weight into column "dry_mass_emergence_mg" where two samples had the same ID

ID 3887 must be	Hainbach	up	2	2018-05-07	Diptera	Nematocera	Simuliidae, in one sample were 14 Simuliidae, in the other one Plecoptera, thus the right weight for this site and ID is 6.8743
```{r, message=FALSE, warning=FALSE}
biomass_emergence$dry_mass_emergence_mg[biomass_emergence$ID == "3887"] <- "6.8743"  
```
ID 5631	must be Klingbach	down	2	2018-07-05	Ephemeroptera		Baetidae		Baetis, in one sample was 1 Baetis, in the other something small not definable anymore, thus the right weight for this site and ID is 0.4181
```{r, message=FALSE, warning=FALSE}
biomass_emergence$dry_mass_emergence_mg[biomass_emergence$ID == "5631"] <- "0.4181"
```
Correct dry_mass_emergence_mg for:
5446	Triefenbach	up	1	2018-07-05	Trichoptera		Hydropsychidae		Hydropsyche		12..7297		
```{r, message=FALSE, warning=FALSE}
biomass_emergence$dry_mass_emergence_mg[biomass_emergence$ID == "5446"] <- "12.7297"
```
Dry weight to numeric
```{r, message=FALSE, warning=FALSE}
biomass_emergence$dry_mass_emergence_mg <- as.numeric(biomass_emergence$dry_mass_emergence_mg)
```
Remove not needed columns from biomass_emergence table
```{r, message=FALSE, warning=FALSE}
biomass_emergence <- select(biomass_emergence, ID, dry_mass_emergence_mg)
```
Add samples where emergence = 0 and thus also biomass = 0
```{r, message=FALSE, warning=FALSE}
emergence_zero_biomass <- select(emergence_zero, ID)

emergence_zero_biomass_1 <- filter(emergence, order == c("no emergence"))
emergence_zero_biomass_1 <- select(emergence_zero_biomass_1, ID)

emergence_zero_biomass <- bind_rows(emergence_zero_biomass, emergence_zero_biomass_1)

emergence_zero_biomass$dry_mass_emergence_mg <- with(emergence_zero_biomass, 0)
```
Merge biomass_emergence and emergence_zero_biomass table
```{r, message=FALSE, warning=FALSE}
biomass_emergence <- bind_rows(biomass_emergence, emergence_zero_biomass)
```
Merge biomass_emergence table with emergence table by "ID"
```{r, message=FALSE, warning=FALSE}
biomass_emergence <- left_join(biomass_emergence, emergence, by="ID")
```
Remove stream = 3, because not known which site this is
```{r, message=FALSE, warning=FALSE}
biomass_emergence <- filter(biomass_emergence, stream != "3")
```
Chose only aquatic organisms
```{r, message=FALSE, warning=FALSE}
biomass_emergence <- filter(biomass_emergence, aquatic == "y")
```
Remove not needed columns: "comment", "label.on.Eppi..y.n.", "same.as.in.table", "X", "aquatic"
```{r, message=FALSE, warning=FALSE}
biomass_emergence <- select(biomass_emergence,-comment,-label.on.Eppi..y.n.,-same.as.in.table,-X,-aquatic)
```
Merge biomass_emergence and trap_days tables
```{r, message=FALSE, warning=FALSE}
trap_days <- unite(trap_days,"merge_ID","Stream", "Position","trap", "Date", remove = TRUE)
biomass_emergence <- unite(biomass_emergence, "merge_ID", "stream", "position", "trap", "time", remove = FALSE)
biomass_emergence <- left_join(biomass_emergence, trap_days, by="merge_ID")
```

## Calculate number of organisms and dry mass (mg) per trap area (m^2) and day (d)

* Biomass and number of organisms must be standardized, because sometimes there was only one trap in the stream and you cannot compare values sampled with one trap and with two traps

### For every sample and family (i.e. trap per sampling date and familiy)
```{r, message=FALSE, warning=FALSE}
biomass_emergence_family_sample <- ddply(biomass_emergence, c("site", "stream", "position", "trap", "time", "season","order", "family","collection_days", "area_trap"), summarise, biomass_sample = sum(dry_mass_emergence_mg, na.rm = TRUE), number_sample = sum(number, na.rm = TRUE))
```
In some samples only order could be identified, so there we have NA as value. To distinguish between NAs of different orders, order and family column are united
```{r, message=FALSE, warning=FALSE}
biomass_emergence_family_sample <- unite(biomass_emergence_family_sample, "ord_fam", "order", "family", remove = TRUE)
unique(biomass_emergence_family_sample$ord_fam)
```
Where family was not identified sometimes NA and sometimes nothing written, so we have some NAs in united column content. We remove this NA
```{r, message=FALSE, warning=FALSE}
biomass_emergence_family_sample$ord_fam <- gsub("NA", "", biomass_emergence_family_sample$ord_fam)
```
Fill with zero, because some orders not found in every sample and thus their number/weight is 0 in this sample
```{r, message=FALSE, warning=FALSE}
biomass_emergence_family_sample_num <- dcast(biomass_emergence_family_sample, site + stream + position + trap + time + season + collection_days + area_trap ~ ord_fam, value.var="number_sample", fill = 0)

biomass_emergence_family_sample_num <- melt(biomass_emergence_family_sample_num, id.vars = c("site", "stream", "position", "trap", "time", "season", "collection_days", "area_trap"))

names(biomass_emergence_family_sample_num)[9:10] <- c("ord_fam", "number_sample")

biomass_emergence_family_sample_bio <- dcast(biomass_emergence_family_sample, site + stream + position + trap + time + season + collection_days + area_trap ~ ord_fam, value.var="biomass_sample", fill = 0)

biomass_emergence_family_sample_bio <- melt(biomass_emergence_family_sample_bio, id.vars = c("site", "stream", "position", "trap", "time", "season", "collection_days", "area_trap"))

names(biomass_emergence_family_sample_bio)[9:10] <- c("ord_fam", "biomass_sample")

biomass_emergence_family_sample <- left_join(biomass_emergence_family_sample_num, biomass_emergence_family_sample_bio, by = c("site", "stream", "position", "trap", "time", "season", "collection_days", "area_trap", "ord_fam"))

biomass_emergence_family_sample <- separate(biomass_emergence_family_sample, ord_fam, into = c("order", "family"), sep = "_", remove = FALSE)
```
Get biomass and number per area and collection day
```{r, message=FALSE, warning=FALSE}
biomass_emergence_family_sample$biomass_area_day_mg <-with(biomass_emergence_family_sample, biomass_sample/(area_trap*collection_days))

biomass_emergence_family_sample$number_area_day <-with(biomass_emergence_family_sample, number_sample/(area_trap*collection_days))

biomass_emergence_family_sample$stream <- as.factor(biomass_emergence_family_sample$stream)
biomass_emergence_family_sample$position <- as.factor(biomass_emergence_family_sample$position)
biomass_emergence_family_sample$order <- as.factor(biomass_emergence_family_sample$order)

biomass_emergence_family_sample <- unite(biomass_emergence_family_sample, "pos_fam", "position", "ord_fam", remove = FALSE)
biomass_emergence_family_sample$pos_fam <- as.factor(biomass_emergence_family_sample$pos_fam)
```
Remove samples, where only order could be identified and where biomass and number = 0, because there it was possible to identify emergence to family level
```{r, message=FALSE, warning=FALSE}
#filter(biomass_emergence_family_sample, family == "" & number_area_day ==0) # 6979, these can be removed

#filter(biomass_emergence_family_sample, family == "" & biomass_area_day_mg !=0) # 12 
#filter(biomass_emergence_family_sample, family == "" & number_area_day !=0) # 13

NA_family <- filter(biomass_emergence_family_sample, family == "" & number_area_day !=0)
biomass_emergence_family_sample <- filter(biomass_emergence_family_sample, family != "")
biomass_emergence_family_sample <- rbind(biomass_emergence_family_sample, NA_family)

unique(biomass_emergence_family_sample$ord_fam)
biomass_emergence_family_sample$ord_fam <- droplevels(biomass_emergence_family_sample$ord_fam)
unique(biomass_emergence_family_sample$ord_fam)
```

### For every sample and order (i.e. trap per sampling date and order)
```{r, message=FALSE, warning=FALSE}
biomass_emergence_order_sample <- ddply(biomass_emergence, c("site", "stream", "position", "trap", "time", "season","order", "collection_days", "area_trap"), summarise, biomass_sample = sum(dry_mass_emergence_mg, na.rm = TRUE), number_sample = sum(number, na.rm = TRUE))
```
Fill with zero, because some orders not found in every sample and thus their number/weight is 0 in this sample
```{r, message=FALSE, warning=FALSE}
biomass_emergence_order_sample_num <- dcast(biomass_emergence_order_sample, site + stream + position + trap + time + season + collection_days + area_trap ~ order, value.var="number_sample", fill = 0)

biomass_emergence_order_sample_num <- melt(biomass_emergence_order_sample_num, id.vars = c("site", "stream", "position", "trap", "time", "season", "collection_days", "area_trap"))

names(biomass_emergence_order_sample_num)[9:10] <- c("order", "number_sample")

biomass_emergence_order_sample_bio <- dcast(biomass_emergence_order_sample, site + stream + position + trap + time + season + collection_days + area_trap ~ order, value.var="biomass_sample", fill = 0)

biomass_emergence_order_sample_bio <- melt(biomass_emergence_order_sample_bio, id.vars = c("site", "stream", "position", "trap", "time", "season", "collection_days", "area_trap"))

names(biomass_emergence_order_sample_bio)[9:10] <- c("order", "biomass_sample")

biomass_emergence_order_sample <- left_join(biomass_emergence_order_sample_num, biomass_emergence_order_sample_bio, by = c("site", "stream", "position", "trap", "time", "season", "collection_days", "area_trap", "order"))
```
Get biomass and number per area and collection day
```{r, message=FALSE, warning=FALSE}
biomass_emergence_order_sample$biomass_area_day_mg <-with(biomass_emergence_order_sample, biomass_sample/(area_trap*collection_days))

biomass_emergence_order_sample$number_area_day <-with(biomass_emergence_order_sample, number_sample/(area_trap*collection_days))

biomass_emergence_order_sample$stream <- as.factor(biomass_emergence_order_sample$stream)
biomass_emergence_order_sample$position <- as.factor(biomass_emergence_order_sample$position)
biomass_emergence_order_sample$order <- as.factor(biomass_emergence_order_sample$order)

biomass_emergence_order_sample <- unite(biomass_emergence_order_sample, "pos_ord", "position", "order", remove = FALSE)
biomass_emergence_order_sample$pos_ord <- as.factor(biomass_emergence_order_sample$pos_ord)
```
### For every sample (i.e. trap per sampling date)
Sum up biomass and number per sample without order
```{r, message=FALSE, warning=FALSE}
biomass_emergence_sample <- ddply(biomass_emergence, c("site", "stream", "position", "trap", "time", "season", "collection_days", "area_trap"), summarise, biomass_sample = sum(dry_mass_emergence_mg, na.rm = TRUE), number_sample = sum(number, na.rm = TRUE)) 

unique(biomass_emergence$site)

biomass_emergence_sample$biomass_area_day_mg <-with(biomass_emergence_sample, biomass_sample/(area_trap*collection_days))

biomass_emergence_sample$number_area_day <-with(biomass_emergence_sample, number_sample/(area_trap*collection_days))

biomass_emergence_sample$stream <- as.factor(biomass_emergence_sample$stream)
biomass_emergence_sample$position <- as.factor(biomass_emergence_sample$position)
```
### Mean site and order
```{r, message=FALSE, warning=FALSE}
biomass_emergence_mean_site_order <- ddply(biomass_emergence_order_sample, c("site", "stream", "position", "season","order"), summarise, biomass_site_mean = mean(biomass_area_day_mg, na.rm = TRUE), number_site_mean = mean(number_area_day, na.rm = TRUE), biomass_site_sd = sd(biomass_area_day_mg, na.rm = TRUE), number_site_sd = sd(number_area_day, na.rm = TRUE))
```
Table in neded form
```{r, message=FALSE, warning=FALSE}
mean_Diptera <- filter(biomass_emergence_mean_site_order, order == "Diptera")
names(mean_Diptera)[6] <- c("biomass_Diptera")
names(mean_Diptera)[7] <- c("number_Diptera")
names(mean_Diptera)[8] <- c("sd_biomass_Diptera")
names(mean_Diptera)[9] <- c("sd_number_Diptera")
mean_Diptera <- select(mean_Diptera, -c("order"))

mean_Ephemeroptera <- filter(biomass_emergence_mean_site_order, order == "Ephemeroptera")
names(mean_Ephemeroptera)[6] <- c("biomass_Ephemeroptera")
names(mean_Ephemeroptera)[7] <- c("number_Ephemeroptera")
names(mean_Ephemeroptera)[9] <- c("sd_biomass_Ephemeroptera")
names(mean_Ephemeroptera)[8] <- c("sd_number_Ephemeroptera")
mean_Ephemeroptera <- select(mean_Ephemeroptera, -c("order"))

mean_Plecoptera <- filter(biomass_emergence_mean_site_order, order == "Plecoptera")
names(mean_Plecoptera)[6] <- c("biomass_Plecoptera")
names(mean_Plecoptera)[7] <- c("number_Plecoptera")
names(mean_Plecoptera)[8] <- c("sd_biomass_Plecoptera")
names(mean_Plecoptera)[9] <- c("sd_number_Plecoptera")
mean_Plecoptera <- select(mean_Plecoptera, -c("order"))

mean_Trichoptera <- filter(biomass_emergence_mean_site_order, order == "Trichoptera")
names(mean_Trichoptera)[6] <- c("biomass_Trichoptera")
names(mean_Trichoptera)[7] <- c("number_Trichoptera")
names(mean_Trichoptera)[8] <- c("sd_biomass_Trichoptera")
names(mean_Trichoptera)[9] <- c("sd_number_Trichoptera")
mean_Trichoptera <- select(mean_Trichoptera, -c("order"))

biomass_emergence_mean_site_order <- left_join(mean_Diptera, mean_Ephemeroptera, by = c("site", "stream","position","season"))
biomass_emergence_mean_site_order <- left_join(biomass_emergence_mean_site_order, mean_Trichoptera, by = c("site", "stream","position","season"))
biomass_emergence_mean_site_order <- left_join(biomass_emergence_mean_site_order, mean_Plecoptera, by = c("site", "stream","position","season"))
```

### Mean site
```{r, message=FALSE, warning=FALSE}
biomass_emergence_mean_site <- ddply(biomass_emergence_sample, c("site", "stream", "position", "season"), summarise, biomass_site_mean = mean(biomass_area_day_mg, na.rm = TRUE), number_site_mean = mean(number_area_day, na.rm = TRUE), biomass_site_sd = sd(biomass_area_day_mg, na.rm = TRUE), number_site_sd = sd(number_area_day, na.rm = TRUE))
```


## Get missing samples and add mean per month and stream
Samples missing mainly because traps lost during heavy rainfall events 
```{r, message=FALSE, warning=FALSE}
emergence_NA <- filter(emergence_NA_zero, identified != "y")
emergence_NA <- emergence_NA[,1:5]
names(emergence_NA)[5] <- c("collection_days")

emergence_NA_zero <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_abundance_data/no_trap_days_NA.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
```
Adjust column names
```{r, message=FALSE, warning=FALSE}
colnames_NA <- c(colnames(emergence_NA_zero))
colnames_NA <- (gsub('X', '', colnames_NA))
names(emergence_NA_zero) <- colnames_NA
```
Put table into needed format and extract missing samles
```{r, message=FALSE, warning=FALSE}
emergence_NA_zero <- gather(emergence_NA_zero, key = "date", value = "collection_days", 4:68)
emergence_NA_zero <- filter(emergence_NA_zero, is.na(collection_days))
```
Convert date into data format
```{r, message=FALSE, warning=FALSE}
emergence_NA_zero$date <- as.Date(emergence_NA_zero$date, "%d.%m.%Y")
```
Put tables together
```{r, message=FALSE, warning=FALSE}
emergence_NA <- rbind(emergence_NA, emergence_NA_zero)
emergence_NA$collection_days <- NA

count(emergence_NA, c("position")) # 163 missing samples, 51 missing samples in forest and 112 missing samples in vine
```
Get month
```{r, message=FALSE, warning=FALSE}
emergence_NA$month <- month(emergence_NA$date)
```
Add columns needed
```{r, message=FALSE, warning=FALSE}
emergence_NA <- unite(emergence_NA, site, c("stream", "position"), remove = FALSE)

names(emergence_NA)[5] <- c("time")
emergence_NA$season <-with(emergence_NA, ifelse(time > "2018-03-21" & time <= "2018-05-16","spring",ifelse(time > "2018-05-16" & time <= "2018-07-26","summer","autumn")))

emergence_NA$area_trap <- NA
emergence_NA$biomass_sample <- NA
emergence_NA$number_sample <- NA
```
Add order
```{r, message=FALSE, warning=FALSE}
ord <- as.data.frame(matrix(data = NA, nrow = 163, ncol = 4))
names(ord) <- unique(biomass_emergence_order_sample$order)

emergence_NA_ord <- cbind(emergence_NA, ord)
emergence_NA_ord <- gather(emergence_NA_ord, key = "order", value = "NA", 12:15)
emergence_NA_ord <- select(emergence_NA_ord, -c("NA"))

emergence_NA_ord <- unite(emergence_NA_ord, pos_ord, position, order, remove = FALSE)
```
Add family
```{r, message=FALSE, warning=FALSE}
ord_fam <- as.data.frame(matrix(data = NA, nrow = 163, ncol = 37))
names(ord_fam) <- unique(biomass_emergence_family_sample$ord_fam)
ord_fam <- select(ord_fam, -c("Ephemeroptera_","Plecoptera_","Trichoptera_"))

emergence_NA_fam <- cbind(emergence_NA, ord_fam)
emergence_NA_fam <- gather(emergence_NA_fam, key = "ord_fam", value = "NA", 12:45)
emergence_NA_fam <- select(emergence_NA_fam, -c("NA"))

emergence_NA_fam <- unite(emergence_NA_fam, pos_fam, position, ord_fam, remove = FALSE)
emergence_NA_fam <- separate(emergence_NA_fam, ord_fam, into = c("order", "family"), sep = "_", remove = FALSE)                   
```
Get mean per month, site and sample for estimates in GAM
```{r, message=FALSE, warning=FALSE}
emergence_NA_sample <- biomass_emergence_sample

emergence_NA_sample$month <- month(emergence_NA_sample$time)

emergence_NA_sample_mean <- ddply(emergence_NA_sample, c("site", "stream", "position", "month"), summarise, biomass_area_day_mg = mean(biomass_area_day_mg, na.rm = TRUE), number_area_day = mean(number_area_day, na.rm = TRUE), collection_days = mean(collection_days, na.rm = TRUE))
```
Get mean per month, site and order for estimates in GAM
```{r, message=FALSE, warning=FALSE}
emergence_NA_order <- biomass_emergence_order_sample

emergence_NA_order$month <- month(emergence_NA_order$time)

emergence_NA_order_mean <- ddply(emergence_NA_order, c("site", "stream", "position", "month", "order"), summarise, biomass_area_day_mg = mean(biomass_area_day_mg, na.rm = TRUE), number_area_day = mean(number_area_day, na.rm = TRUE), collection_days = mean(collection_days, na.rm = TRUE))
```
Get mean per month, site and family for estimates in GAM
```{r, message=FALSE, warning=FALSE}
emergence_NA_family <- biomass_emergence_family_sample

emergence_NA_family$month <- month(emergence_NA_family$time)

emergence_NA_family_mean <- ddply(emergence_NA_family, c("site", "stream", "position", "pos_fam","month"), summarise, biomass_area_day_mg = mean(biomass_area_day_mg, na.rm = TRUE), number_area_day = mean(number_area_day, na.rm = TRUE), collection_days = mean(collection_days, na.rm = TRUE))
```
Add mean to NA samples and add to biomass_emergence_sample
```{r, message=FALSE, warning=FALSE}
emergence_NA <- select(emergence_NA, -c("collection_days"))
emergence_NA <- left_join(emergence_NA, emergence_NA_sample_mean, by = c("site", "stream", "position", "month"))

emergence_NA <- select(emergence_NA, -c("month"))
```
    
Add mean to NA order_samples biomass_emergence_order_sample
```{r, message=FALSE, warning=FALSE}
emergence_NA_ord <- select(emergence_NA_ord, -c("collection_days"))
emergence_NA_ord<- left_join(emergence_NA_ord, emergence_NA_order_mean, by = c("site", "stream", "position", "order","month"))

emergence_NA_ord <- select(emergence_NA_ord, -c("month"))
```
Add mean to NA family_samples biomass_emergence_family_sample
```{r, message=FALSE, warning=FALSE}
emergence_NA_fam <- select(emergence_NA_fam, -c("collection_days"))
emergence_NA_fam<- left_join(emergence_NA_fam, emergence_NA_family_mean, by = c("site", "stream", "position", "pos_fam","month"))

emergence_NA_fam <- select(emergence_NA_fam, -c("month"))
```

Merge NA estimate tables with original values
```{r, message=FALSE, warning=FALSE}
biomass_emergence_sample <- rbind(biomass_emergence_sample, emergence_NA)

biomass_emergence_order_sample <- rbind(biomass_emergence_order_sample, emergence_NA_ord)

biomass_emergence_family_sample <- rbind(biomass_emergence_family_sample, emergence_NA_fam)
```

# Number EPT families
## Per site and season
Delete rows where family could not be identified
```{r, message=FALSE, warning=FALSE}
emergence_EPT <- filter(emergence, (order == "Ephemeroptera" | order == "Trichoptera" | order == "Plecoptera"))

emergence_EPT <- filter(emergence_EPT, family != "")
```
Count number families of EPT per season and site
```{r, message=FALSE, warning=FALSE}
count_season_1 <- ddply(emergence_EPT, c("stream", "position", "season","family"), summarise, number_sum = sum(number))

count_season <- count(count_season_1, c("stream", "position","season")) 

names(count_season)[4] <- c("number_EPT")
```
Add number EPT taxa to biomass_emergence_mean_site and biomass_emergence_mean_site_order
```{r, message=FALSE, warning=FALSE}
biomass_emergence_mean_site <- left_join(biomass_emergence_mean_site, count_season, by = c("stream", "position", "season"))
```

# Number Diptera families
## Per site and season
Delete rows where family could not be identified
```{r, message=FALSE, warning=FALSE}
emergence_dip <- filter(emergence, (order == "Diptera"))

emergence_dip <- filter(emergence_dip, family != "")
```
Count number families of EPT per season and site
```{r, message=FALSE, warning=FALSE}
dip_count_season_1 <- ddply(emergence_dip, c("stream", "position", "season","family"), summarise, number_sum = sum(number))

dip_count_season <- count(dip_count_season_1, c("stream", "position","season")) 

names(dip_count_season)[4] <- c("number_dip")
```
Add number families to biomass_emergence_mean_site and biomass_emergence_mean_site_order
```{r, message=FALSE, warning=FALSE}
biomass_emergence_mean_site <- left_join(biomass_emergence_mean_site, dip_count_season, by = c("stream", "position", "season"))
```

# Number families
## Per site and season
Delete rows where family could not be identified
```{r, message=FALSE, warning=FALSE}
fam <- filter(emergence, (aquatic == "y"))

fam <- filter(fam, family != "")
fam <- filter(fam, !is.na(time)) # remove site 3, which cannot be related to any of the streams
```
Count number families of EPT per season and site
```{r, message=FALSE, warning=FALSE}
fam_count_season_1 <- ddply(fam, c("stream", "position", "season","family"), summarise, number_sum = sum(number))

fam_count_season <- count(fam_count_season_1, c("stream", "position","season")) 

names(fam_count_season)[4] <- c("number_fam")
```
Add number families to biomass_emergence_mean_site and biomass_emergence_mean_site_order
```{r, message=FALSE, warning=FALSE}
biomass_emergence_mean_site <- left_join(biomass_emergence_mean_site, fam_count_season, by = c("stream", "position", "season"))
```
## Percentage samples where we could identify order, family and genus level
NAs in samples, where emergence was 0 and thus nothing could have been identified
```{r, message=FALSE, warning=FALSE}
unique(biomass_emergence$family)
#View(is.na(biomass_emergence$family)) 
```
Get table without NAs, since we count rows
```{r, message=FALSE, warning=FALSE}
percentage_emergence <- filter(biomass_emergence, !is.na(biomass_emergence$family)) 
unique(percentage_emergence$family)
unique(percentage_emergence$genus)
```
Get percentage identified to family and genus level for all emergence organisms
```{r, message=FALSE, warning=FALSE}
100*sum(percentage_emergence$family != "")/nrow(percentage_emergence) # 99.63 %

100*sum(percentage_emergence$genus != "")/nrow(percentage_emergence) # 27.79 % low, since no genus was identified for Diptera
```
Get percentage identified until genus only for EPT
```{r, message=FALSE, warning=FALSE}
percentage_ept <- filter(percentage_emergence, order != "Diptera")

100*sum(percentage_ept$genus != "")/nrow(percentage_ept) # 87.09 % 

percentage_ept <- unite(percentage_ept, "fam_gen", "family","genus", remove = FALSE)

unique(percentage_ept$family) # 23 families

unique(percentage_ept$genus) # 20 genera

unique(percentage_ept$fam_gen) 
# bei Nemouridae: Nemurella, Protonemura, Amphinemura; 
# bei Heptageniidae: Epeorus, Ecdyonurus
# sonst gleicher oder kein genus

eph <- filter(percentage_ept, order == "Ephemeroptera")
unique(eph$family) # 6
unique(eph$genus) # 7 (Heptageniidae 2 genera)

eph_for <- filter(eph, position == "forest")
eph_vin <- filter(eph, position == "vine")
unique(eph_for$family) # 6
unique(eph_vin$family) # 4 not Siphlonuridae and Arthropleidae

ple <- filter(percentage_ept, order == "Plecoptera")
unique(ple$family) # 4
unique(ple$genus) # 7 (Nemouridae 3 genera)

ple_for <- filter(ple, position == "forest")
ple_vin <- filter(ple, position == "vine")
unique(ple_for$family) # 4
unique(ple_vin$family) # 2 not Leuctridae and Chloroperlidae

tri <- filter(percentage_ept, order == "Trichoptera")
unique(tri$family) # 13
unique(tri$genus) # 6

tri_for <- filter(tri, position == "forest")
tri_vin <- filter(tri, position == "vine")
unique(tri_for$family) # 12, not Lepidostomatidae
unique(tri_vin$family) # 8, not Uenoidae, Goeridae, Glossosomatidae, Phryganeidae, Philopotamidae
```
Get number of Diptera families
```{r, message=FALSE, warning=FALSE}
percentage_dip <- filter(percentage_emergence, order == "Diptera")
unique(percentage_dip$family) # 11

percentage_dip_for <- filter(percentage_dip, position == "forest")
percentage_dip_vin <- filter(percentage_dip, position == "vine")

unique(percentage_dip_for$family) # 11
unique(percentage_dip_vin$family) # 11
```
Number families overall
```{r, message=FALSE, warning=FALSE}
length(unique(percentage_dip_for$family)) +
  length(unique(eph_for$family)) +
  length(unique(ple_for$family)) +
  length(unique(tri_for$family))

length(unique(percentage_dip_vin$family)) +
  length(unique(eph_vin$family)) +
  length(unique(ple_vin$family)) +
  length(unique(tri_vin$family))
```

# Trait data
Load data
```{r, message=FALSE, warning=FALSE}
generation_time <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/trait_data/generation_time_spear.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = TRUE)

Trait_EU <- readRDS(file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/trait_data/Trait_DB_EU_corrected.rds")
```
## Size
### Check which trait data available 
#### Family level
Check for how many families information is available (already aggregated on family level or also just at genus or species level)
```{r, message=FALSE, warning=FALSE}
family_vec <- unique(biomass_emergence_family_sample$family) # 34 families
```
Different column names that should be retrieved
```{r, message=FALSE, warning=FALSE}
cols <- grep("family|order|size", names(Trait_EU), value = TRUE)
size_cols <- grep("size", names(Trait_EU), value = TRUE)
spec_gen_cols <- grep("species|genus|family|order|size", names(Trait_EU), value = TRUE)
```
Remove gen. sp. from family column
```{r, message=FALSE, warning=FALSE}
Trait_EU[family %like% "gen. sp.", family := sub(" gen\\. sp\\.", "", family)]
```
Generally, for 34 families information is available
```{r, message=FALSE, warning=FALSE}
exist_in_db <- Trait_EU[family %in% family_vec, ..spec_gen_cols] %>% 
  .[, family] %>% unique()
family_vec[!family_vec %in% exist_in_db]
```
Trait assignments on family-level
for 7 families data available
```{r, message=FALSE, warning=FALSE}
size_family <- Trait_EU[is.na(species) & is.na(genus), ..cols] %>% 
  .[family %in% family_vec, ] %>% 
  na.omit(.)
```
Remove duplicate rows
```{r, message=FALSE, warning=FALSE}
size_family <- distinct(size_family)
```

### Aggregation 
#### Define function to aggregate data

* Needs traits and taxonomic information (up to order)
* direct aggregation to family level
```{r, message=FALSE, warning=FALSE}
direct_agg <- function(trait_data,
                       non_trait_cols, 
                       method,
                       na.rm = TRUE) {
  # get names of trait columns
  pat <- paste0(non_trait_cols, collapse = "|")
  trait_col <- grep(pat, names(trait_data), value = TRUE, invert = TRUE)
  
  # aggregate to family-level
  # subset so that no NA values occur in data
  # (otherwise all NA entries are viewed as a group &
  # aggregated as well)
  agg_data <- trait_data[!is.na(family),
                         lapply(.SD, method, na.rm = na.rm),
                         .SDcols = trait_col,
                         by = "family"
  ]
  
  # merge information on order back
  agg_data[trait_data,
           `:=`(order = i.order),
           on = "family"
  ]
  agg_data
}
```
#### Aggregate data on family level
```{r, message=FALSE, warning=FALSE}
agg_size_family <- direct_agg(
  trait_data = Trait_EU[family %in% family_vec, ..spec_gen_cols],
  non_trait_cols = c("species", "genus", "family", "order"),
  method = median
) # Limoniidae, Simuliidae no size traits
```

### Unite size family and aggrgated site family
Use size family if also aggregated family is available, since size family includes expert judgment and is more accurate than aggregated family

Remove families from aggregated families, which are also available in size family
```{r, message=FALSE, warning=FALSE}
remove_vec <- unique(size_family$family)

"%notin%" <- Negate("%in%")

agg_size_family <- agg_size_family[family %notin% remove_vec, ] 
```
Unite family size and aggregated family
```{r, message=FALSE, warning=FALSE}
unite_size_family <- rbind(size_family, agg_size_family)
```
No families in size class size_&le; 0.25 cm_tachet and size_> 8 cm_tachet, so remove these columns
```{r, message=FALSE, warning=FALSE}
unite_size_family <- select(unite_size_family, -c("size_&le; 0.25 cm_tachet", "size_> 8 cm_tachet"))
```
Rename columns
```{r, message=FALSE, warning=FALSE}
names(unite_size_family)[3] <- "size_0.25_0.5"
names(unite_size_family)[4] <- "size_0.5_1"
names(unite_size_family)[5] <- "size_1_2"
names(unite_size_family)[6] <- "size_2_4"
names(unite_size_family)[7] <- "size_4_8"
```

### Add values for Linomiidae and Simuliidae
Size values taken from literature and distribution in size classes done with expert judgment and information from MZB samples in our streams

Size for full grown larvae Simuliidae from Nilsson_Aquatic Insects_VOLUME-2: 4 - 12 mm = 0.4 - 1.2 cm

For Mature larvae Limoniidae size from https://www.macroinvertebrates.org/taxa-characters/diptera-larva/limoniidae : 10–25 mm = 1 - 2.5 cm
-> Go to "Diagnostic Characters" then on "Expanded Character List" (bottom right)

family    |0.25-0.5 cm     |0.5-1 cm      |> 1-2 cm   |> 2-4 cm
----------|----------------|--------------|-----------|--------------------
Simuliidae|0.277           |0.446         |0.277      | 0
Limoniidae|0               |0.1           |0.7        |0.2  

Simuliidae: Similar size distribution like Chironomidae in our MZB samples
Limoniidae: Mainly medium size in our samples

```{r, message=FALSE, warning=FALSE}
unite_size_family[33:34,3:7] <- 0

unite_size_family$"size_0.25_0.5"[unite_size_family$family == "Simuliidae"] <- 0.277
unite_size_family$"size_0.5_1"[unite_size_family$family == "Simuliidae"] <- 0.446
unite_size_family$"size_1_2"[unite_size_family$family == "Simuliidae"] <- 0.277

unite_size_family$"size_0.5_1"[unite_size_family$family == "Limoniidae"] <- 0.1
unite_size_family$"size_1_2"[unite_size_family$family == "Limoniidae"] <- 0.7
unite_size_family$"size_2_4"[unite_size_family$family == "Limoniidae"] <- 0.2
```

### Calculate biomass ratios of size class per site

* Biomass usually higher in agriculture. Thus biomass per size class is also likely to be higher in agriculture than in forest.

* Here we are not interested in absolute values, but in ratio of biomass per size class in site to estimate if size structure differs between forest and agriculture

Add size class to family biomass 
```{r, message=FALSE, warning=FALSE}
bio_family <- select(biomass_emergence_family_sample, c("site", "stream", "position", "trap", "time", "season", "order", "family", "biomass_area_day_mg"))
```
Unite biomass and size of families
```{r, message=FALSE, warning=FALSE}
size_bio_family <- merge(bio_family, unite_size_family, by = c("order", "family"))
```
Get biomass per size class
```{r, message=FALSE, warning=FALSE}
size_bio_family$bio_0.25_0.5 <- with(size_bio_family, biomass_area_day_mg*size_0.25_0.5)

size_bio_family$bio_0.5_1 <- with(size_bio_family, biomass_area_day_mg*size_0.5_1)

size_bio_family$bio_1_2 <- with(size_bio_family, biomass_area_day_mg*size_1_2)

size_bio_family$bio_2_4 <- with(size_bio_family, biomass_area_day_mg*size_2_4)

size_bio_family$bio_4_8 <- with(size_bio_family, biomass_area_day_mg*size_4_8)
```
Put table in needed format
```{r, message=FALSE, warning=FALSE}
size_bio_sample <- select(size_bio_family, c("site", "stream", "position", "trap", "time", "bio_0.25_0.5", "bio_0.5_1", "bio_1_2", "bio_2_4", "bio_4_8"))

size_bio_sample <- melt(size_bio_sample, id.vars = c("site", "stream", "position", "trap", "time"))
```
Put together two smallest and two largest size classes
```{r, message=FALSE, warning=FALSE}
size_bio_sample$class <- with(size_bio_sample, 
                              ifelse(variable == "bio_0.25_0.5", "small", 
                              ifelse(variable == "bio_0.5_1", "small",
                              ifelse(variable == "bio_2_4", "large", 
                              ifelse(variable == "bio_4_8", "large", "medium")))))
```
Get biomass per sample site and size as well as total biomass 
```{r, message=FALSE, warning=FALSE}
size_bio_site <- ddply(size_bio_sample, c("site", "stream", "position", "class"), summarise, bio_size = sum(value))
```
Get total biomass per sample site
```{r, message=FALSE, warning=FALSE}
bio_size <- ddply(size_bio_sample, c("site", "stream", "position"), summarise, bio_total = sum(value))
```
Merge bio_size and size_bio_site
```{r, message=FALSE, warning=FALSE}
bio_size <- merge(bio_size, size_bio_site, by = c("site", "stream", "position"))
```
Calculate ratio 
```{r, message=FALSE, warning=FALSE}
bio_size$bio_size_ratio <- with(bio_size, bio_size/bio_total)
```
Difference between sites within same stream
```{r, message=FALSE, warning=FALSE}
size_bio_diff <- select(bio_size, c("stream", "position", "class", "bio_size", "bio_size_ratio"))
  
size_bio_diff_1 <-  dcast(size_bio_diff, stream + class ~ position, value.var="bio_size_ratio")
size_bio_diff_1$difference_ratio <- size_bio_diff_1$forest - size_bio_diff_1$vine
size_bio_diff_1 <- select(size_bio_diff_1, -c("forest", "vine"))

size_bio_diff <-  dcast(size_bio_diff, stream + class ~ position, value.var="bio_size")
size_bio_diff$difference <- size_bio_diff$forest - size_bio_diff$vine
size_bio_diff <- select(size_bio_diff, -c("forest", "vine"))

size_bio_diff <- merge(size_bio_diff, size_bio_diff_1, by = c ("stream", "class"))

size_bio_diff$class <- factor(size_bio_diff$class, levels = c("small", "medium", "large"))
```
### Plot difference size
```{r, message=FALSE, warning=FALSE}
diff_size_bio <- ggplot() +
  geom_violin(data=size_bio_diff, aes(x=class, y=difference), trim = FALSE) +
   geom_dotplot(data=size_bio_diff, aes(x=class, y=difference), binaxis="y", stackdir="center", dotsize = 1, fill = NA) +
  stat_summary(data=size_bio_diff, aes(x=class, y=difference), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=20), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_text(size=15), axis.text.x = element_text(size=15)) +
  labs(title = "Difference biomass per size class", 
       x=expression(cm),
       y=expression(Difference~biomass~ between~ forest~ and~ agriculture ~"("~mg~ ~m^-2~d^-1~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_size_bio

diff_size_rat <- ggplot() +
  geom_violin(data=size_bio_diff, aes(x=class, y=difference_ratio), trim = FALSE) +
   geom_dotplot(data=size_bio_diff, aes(x=class, y=difference_ratio), binaxis="y", stackdir="center", dotsize = 1, fill = NA) +
  stat_summary(data=size_bio_diff, aes(x=class, y=difference_ratio), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=20), axis.text.y = element_text(size=15), axis.title.y = element_text(size=20), axis.title.x = element_text(size=20), axis.text.x = element_text(size=20)) +
  labs(title = "Ratio of biomass per size class", 
       x="",
       y=expression(Difference~ ratio ~ between~ forest~ and~ agriculture)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/diff_size_rat_class.png", width=15, height=10, units="in", res=300)
diff_size_rat
#dev.off()
```

## Generation time
### Prepare generation time data
Extract needed columns from generation_time
```{r, message=FALSE, warning=FALSE}
generation_time <- select(generation_time, c("Ordnung", "Familie", "Gattung", "Taxon", "Rang", "Generationszeit"))
```
Rename columns
```{r, message=FALSE, warning=FALSE}
names(generation_time)[1] <- c("order")
names(generation_time)[2] <- c("family")
names(generation_time)[3] <- c("genus")
names(generation_time)[4] <- c("taxon")
names(generation_time)[5] <- c("rank")
names(generation_time)[6] <- c("generation_time")
```
Extract values for family level
```{r, message=FALSE, warning=FALSE}
family_generation_time <- filter(generation_time, rank == "family")
```
Extract needed families
```{r, message=FALSE, warning=FALSE}
family_generation_time <- filter(family_generation_time, family %in% family_vec)
```
Remove ranks summing up several families
```{r, message=FALSE, warning=FALSE}
"%notlike%" <- Negate("%like%")

family_generation_time <- filter(family_generation_time, genus %notlike% "incl.")
```
Which family not in generation time
```{r, message=FALSE, warning=FALSE}
check_fam <- as.data.frame(family_vec)
names(check_fam)[1] <- "family"
anti_join(check_fam, family_generation_time, by = "family")
```
Use generation time to get potential sensitivity:
* Generation time ≥ 0.5/year: potentially sensitive due to a slow recovery potential
* Generation time < 0.5/year: potentially not sensitive due to a fast recovery potential

```{r, message=FALSE, warning=FALSE}
family_generation_time$generation_sensitive <- with(family_generation_time, ifelse(generation_time < 0.5, "not_sensitive", "sensitive"))
```
Add generation time not sensitive for Culicidae
```{r, message=FALSE, warning=FALSE}
family_generation_time$family <- as.character(family_generation_time$family)
family_generation_time$genus <- as.character(family_generation_time$genus)
family_generation_time$taxon <- as.character(family_generation_time$taxon)

culicidae <- c("Diptera", "Culicidae", "Culicidae", "Culicidae Gen. sp.", "family", "NA", "not_sensitive")

family_generation_time <- rbind(family_generation_time, culicidae)

family_generation_time$family <- as.factor(family_generation_time$family)
family_generation_time$genus <- as.factor(family_generation_time$genus)
family_generation_time$taxon <- as.factor(family_generation_time$taxon)

family_generation_time$generation_time <- as.numeric(family_generation_time$generation_time)
```

### Calculate biomass ratios of sensitive and not sensitive families per site

* Here we are not interested in absolute values, but in ratio of biomass per sensitive class in site to estimate if size structure differs between forest and agriculture

Unite generation time data and biomass data
```{r, message=FALSE, warning=FALSE}
generation_bio_family <- merge(bio_family, family_generation_time, by = c("order", "family"))

generation_bio_family <- select(generation_bio_family, -c("genus", "taxon", "rank"))
```
Get biomass for generation time sensitivity as well as total biomass 
```{r, message=FALSE, warning=FALSE}
gen_bio_site <- ddply(generation_bio_family, c("site", "stream", "position", "generation_sensitive"), summarise, bio_gen = sum(biomass_area_day_mg))
```
Get total biomass per sample site
```{r, message=FALSE, warning=FALSE}
bio_gen <- ddply(generation_bio_family, c("site", "stream", "position"), summarise, bio_total = sum(biomass_area_day_mg))
```
Merge bio_gen and gen_bio_site
```{r, message=FALSE, warning=FALSE}
bio_gen <- merge(bio_gen, gen_bio_site, by = c("site", "stream", "position"))
```
Calculate ratio 
```{r, message=FALSE, warning=FALSE}
bio_gen$bio_gen_ratio <- with(bio_gen, bio_gen/bio_total)
```
Difference between sites within same stream
```{r, message=FALSE, warning=FALSE}
gen_bio_diff <- select(bio_gen, c("stream", "position", "generation_sensitive", "bio_gen","bio_gen_ratio"))
  
gen_bio_diff_1 <-  dcast(gen_bio_diff, stream + generation_sensitive ~ position, value.var="bio_gen_ratio")
gen_bio_diff_1$difference_ratio <- gen_bio_diff_1$forest - gen_bio_diff_1$vine
gen_bio_diff_1 <- select(gen_bio_diff_1, -c("forest", "vine"))

gen_bio_diff <-  dcast(gen_bio_diff, stream + generation_sensitive ~ position, value.var="bio_gen")
gen_bio_diff$difference <- gen_bio_diff$forest - gen_bio_diff$vine
gen_bio_diff <- select(gen_bio_diff, -c("forest", "vine"))

gen_bio_diff <- merge(gen_bio_diff, gen_bio_diff_1, by = c("stream", "generation_sensitive"))

gen_bio_diff$generation_sensitive <- gsub("not_sensitive", "not sensitive", gen_bio_diff$generation_sensitive)

sen_bio_diff <- filter(gen_bio_diff, generation_sensitive == "sensitive")
```
### Plot difference generation time
```{r, message=FALSE, warning=FALSE}
diff_gen_bio <- ggplot() +
  geom_violin(data=gen_bio_diff, aes(x=generation_sensitive, y=difference), trim = FALSE) +
   geom_dotplot(data=gen_bio_diff, aes(x=generation_sensitive, y=difference), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=gen_bio_diff, aes(x=generation_sensitive, y=difference), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=20), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_text(size=15), axis.text.x = element_text(size=15)) +
  labs(title = "Generation time sensitivity: Difference biomass", y = expression(difference~biomass ~"("~mg~ ~m^-2~d^-1~")"), x = "") +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_gen_bio

diff_gen_rat <- ggplot() +
  geom_violin(data=gen_bio_diff, aes(x=generation_sensitive, y=difference_ratio), trim = FALSE) +
   geom_dotplot(data=gen_bio_diff, aes(x=generation_sensitive, y=difference_ratio), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=gen_bio_diff, aes(x=generation_sensitive, y=difference_ratio), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=20), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_text(size=15), axis.text.x = element_text(size=15)) +
  labs(title = "Generation time sensitivity: Difference ratio", y = expression(difference~ratio), x = "") +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_gen_rat

diff_sen_rat <- ggplot() +
  geom_violin(data=sen_bio_diff, aes(x=generation_sensitive, y=difference_ratio), trim = FALSE) +
   geom_dotplot(data=sen_bio_diff, aes(x=generation_sensitive, y=difference_ratio), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=sen_bio_diff, aes(x=generation_sensitive, y=difference_ratio), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=20), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_text(size=15), axis.text.x = element_text(size=15)) +
  labs(title = "Ratio of biomass for sensitive \nfamilies", y = expression(Difference~ ratio ~ between~ forest~ and~ agriculture), x = "") +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/diff_gen_rat.png", width=5, height=5, units="in", res=300)
diff_sen_rat
#dev.off()
```

## Unite size and generation time table
Put data into needed format
```{r, message=FALSE, warning=FALSE}
bio_gen_wide <- dcast(bio_gen, stream + position ~ generation_sensitive, value.var = c("bio_gen_ratio"))

bio_size_wide <- dcast(bio_size, stream + position ~ class, value.var = c("bio_size_ratio"))
```
Unit tables
```{r, message=FALSE, warning=FALSE}
bio_gen_wide <- dcast(bio_gen, stream + position ~ generation_sensitive, value.var = c("bio_gen_ratio"))

bio_size_wide <- dcast(bio_size, stream + position ~ class, value.var = c("bio_size_ratio"))

trait_data <- merge(bio_gen_wide, bio_size_wide, by = c("stream", "position"))

names(gen_bio_diff)[2] <- "variable"
names(size_bio_diff)[2] <- "variable"

trait_data_diff <- rbind(gen_bio_diff, size_bio_diff)
```

# Physico-chemical (phys-chem) data
## Load data
```{r, message=FALSE, warning=FALSE}
phys_chem <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/land_use_related_drivers_data/phys_chem.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
#View(phys_chem)
```

## Correct mistakes in raw data and convert it into right form
Change site name
```{r, message=FALSE, warning=FALSE}
phys_chem $Site <- gsub(" ", "_", phys_chem $Site)
```
Correct misspelled Site names
```{r, message=FALSE, warning=FALSE}
unique(phys_chem$Site)
phys_chem$Site[phys_chem $Site == "Gr\303\274nbach"] <- "Gruenbach"
phys_chem$Site[phys_chem $Site == "Kaiserbach_up_"] <- "Kaiserbach_up"
phys_chem$Site[phys_chem $Site == "Hainbach_up_"] <- "Hainbach_up"
phys_chem$Site[phys_chem $Site == "Russbach_up_"] <- "Russbach_up"
phys_chem$Site[phys_chem $Site == "Modenbach_up_"] <- "Modenbach_up"
phys_chem$Site[phys_chem $Site == "Kaiserbach_down_"] <- "Kaiserbach_down"
phys_chem$Site[phys_chem $Site %like% "otterbach_down"] <- "Otterbach_down"
phys_chem$Site[phys_chem $Site %like% "Dierbach_Down"] <- "Dierbach_down"
#unique(phys_chem$Site)
```
Correct misspelled Variable names
```{r, message=FALSE, warning=FALSE}
phys_chem$Variable <- as.factor(phys_chem$Variable) 
levels(phys_chem$Variable)
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Cu "] <- "Cu"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Cl "] <- "Cl"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Dissolved Oxygen "] <- "Dissolved Oxygen"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="SO4 "] <- "SO4"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow 3 "] <- "Flow 3"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow 2 "] <- "Flow 2"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow 2  "] <- "Flow 2"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow 1 "] <- "Flow 1"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="conductivity "] <- "conductivity"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow UFZ "] <- "Flow UFZ"
#levels(phys_chem$Variable)
```
Rename all Flow variables in Flow for easier plausibility check
```{r, message=FALSE, warning=FALSE}
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow 1"] <- "Flow"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow 2"] <- "Flow"
levels(phys_chem$Variable)[levels(phys_chem$Variable)=="Flow 3"] <- "Flow"
#levels(phys_chem$Variable)
```
SO4 value Klingbach up 10.09.18 not put correctly in table (value into qualifier column)
```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Qualifier == "<20"] <- 20
phys_chem$Qualifier[phys_chem$Qualifier == "<20"] <- "<"
```
Cu value Klingbach down 29.05.18 not put correctly in table (qualifier in value column and "," instead of ".")
```{r, message=FALSE, warning=FALSE}
phys_chem$Qualifier[phys_chem$Value == "<0,1"] <- "<"
phys_chem$Value[phys_chem$Value == "<0,1"] <- 0.1
```
Values from factor to numeric
```{r, message=FALSE, warning=FALSE}
phys_chem$Value <- as.character(phys_chem$Value)
phys_chem$Value <- as.numeric(phys_chem$Value) 
```
NAs no problem, only in variables not of interest

## Check if Values are plausible using measuring range of methods
Possible range of variables:

* NH4: 0.1 - 2 mg/L

* NO2: 0.01 - 0.15 mg/L

* PO4: 0.2 - 5.0 mg/L

* NO3: 1.0 - 14 mg/L

* Cl: 1 - 50 mg/L

* SO4: 20 - 200 mg/L

* Cu: 0.1 - 5.0 mg/L

* pH: 0 - 14

* air temperature: -5 - 40 C

* water temperature: 0 - 30 C

* Flow: 0 - 0.7

* O2 %: 0 - 120 %

* O2 mg/L: 0 - 20 mg/L

* conductivity: 0 - 1000 uS/cm

```{r, message=FALSE, warning=FALSE}
phys_chem$check <- with(phys_chem, ifelse(Variable == "NH4" & Value < 0.1,"y",
                                   ifelse(Variable == "NH4" & Value > 2, "y", 
                                   ifelse(Variable == "NO2"& Value < 0.01, "y",
                                   ifelse(Variable == "NO2"& Value > 0.15, "y",
                                   ifelse(Variable == "PO4" & Value < 0.2, "y", 
                                   ifelse(Variable == "PO4" & Value > 5.0, "y", 
                                   ifelse(Variable == "NO3" & Value < 1.0, "y",
                                   ifelse(Variable == "NO3" & Value > 14, "y",
                                   ifelse(Variable == "Cl" & Value < 1, "y",
                                   ifelse(Variable == "Cl" & Value > 50, "y", 
                                   ifelse(Variable == "SO4" & Value < 20, "y",
                                   ifelse(Variable == "SO4" & Value > 200, "y", 
                                   ifelse(Variable == "Cu" & Value < 0.1, "y", 
                                   ifelse(Variable == "Cu" & Value > 5, "y", 
                                   ifelse(Variable == "pH" & Value < 0, "y",
                                   ifelse(Variable == "pH" & Value > 14, "y", 
                                   ifelse(Variable == "air temperature" & Value < -5, "y",
                                   ifelse(Variable == "air temperature" & Value > 40, "y",
                                   ifelse(Variable == "water temperature" & Value < 0, "y",
                                   ifelse(Variable == "water temperature" & Value > 30,"y",
                                   ifelse(Variable == "Flow" & Value < 0, "y",
                                   ifelse(Variable == "Flow" & Value > 0.8, "y",
                                   ifelse(Variable == "Flow UFZ" & Value < 0, "y",
                                   ifelse(Variable == "Flow UFZ" & Value > 0.8, "y",
                                   ifelse(Variable == "Dissolved oxygen" & Unit == "mg/L" & Value 
                                   < 0, "y", 
                                   ifelse(Variable == "Dissolved Oxygen" & Unit == "mg/L" & Value 
                                   > 20, "y",
                                   ifelse(Variable == "Dissolved Oxygen" & Unit == "%" & Value 
                                   < 0, "y",
                                   ifelse(Variable == "Dissolved Oxygen" & Unit == "%" & Value 
                                   > 120, "y",
                                   ifelse(Variable == "conductivity" & Site != "Kaiserbach_down" &
                                   Value < 0, "y", 
                                   ifelse(Variable == "conductivity" & Site != "Kaiserbach_down" &
                                   Value > 1000, "y","n")))))))))))))))))))))))))))))))

checklist <- filter(phys_chem, check == "y")
checklist[,1:6]
```

## Correct not plausible values (if possible)

* Gruenbach	20/06/2018	NO2		0.001	mg/L: 0.01 mg/L in data sheet

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Gruenbach" & phys_chem$Date == "20/06/2018" & phys_chem$Variable == "NO2"] <- 0.01
```

* Otterbach_down	20/06/2018	NO2		0.002	mg/L: 0.02 mg/L in data sheet

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Otterbach_down" & phys_chem$Date == "20/06/2018" & phys_chem$Variable == "NO2"] <- 0.02
```

* Modenbach_down	30/05/2018	NO3		18	mg/L: 1.8 mg/L in data sheet

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Modenbach_down" & phys_chem$Date == "30/05/2018" & phys_chem$Variable == "NO3"] <- 1.8
```

* Triefenbach_up	08/05/2018	Flow		15	m/sec: 0.15 m/sec in data sheet

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Triefenbach_up" & phys_chem$Date == "08/05/2018" & phys_chem$Variable == "Flow"] <- 0.15
```

* Klingbach_up	09/05/2018	NO3		26	mg/L: 2.6 mg/L in data sheet

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Klingbach_up" & phys_chem$Date == "09/05/2018" & phys_chem$Variable == "NO3"] <- 2.6
```

* Gruenbach	09/05/2018	SO4		2	mg/L: 29 mg/L in data sheet

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Gruenbach" & phys_chem$Date == "09/05/2018" & phys_chem$Variable == "SO4"] <- 29
```

* Triefenbach_down	20/03/2018	SO4		0.12	mg/L: 0.12 mg/L in data sheet: range 20-200: probably 120

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Triefenbach_down" & phys_chem$Date == "20/03/2018" & phys_chem$Variable == "SO4"] <- 120
```

* Dierbach_up	26/03/2018	pH		787: 7.87 in data sheet

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Dierbach_up" & phys_chem$Date == "26/03/2018" & phys_chem$Variable == "pH"] <- 7.87
```

* Kaiserbach_down	30/07/2018	SO4		2	mg/L: 2 mg/L in data sheet: probably 20 (lowest range as correction)

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Kaiserbach_down" & phys_chem$Date == "30/07/2018" & phys_chem$Variable == "SO4"] <- 20
```

* Russbach_down	10/09/2018	NO3	<	0.1	mg/L: < 0.1 mg/L in data sheet: lowest range 1.0 as correction

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Russbach_down" & phys_chem$Date == "10/09/2018" & phys_chem$Variable == "NO3"] <- 1.0
```

* Otterbach_down	10/09/2018	NO3	<	0.1	mg/L: < 0.1 mg/L in data sheet: lowest range 1.0 as correction

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Otterbach_down" & phys_chem$Date == "10/09/2018" & phys_chem$Variable == "NO3"] <- 1.0
```

*Hainbach_down	21/08/2018	PO4		11	mg/L: 11 mg/L in data sheet: probably 1.1 mg/L (range 0.2 - 5.0)

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Hainbach_down" & phys_chem$Date == "21/08/2018" & phys_chem$Variable == "PO4"] <- 1.1
```

* Dierbach_down	20/06/2018	Dissolved Oxygen		330	%: 330 % in data sheet: value not mean, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Dierbach_down" & phys_chem$Date == "20/06/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Dierbach_down	20/06/2018	Dissolved Oxygen		31.3	mg/L: 31.3 mg/L in data sheet: value not plausible, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Dierbach_down" & phys_chem$Date == "20/06/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Kaiserbach_up	20/06/2018	Dissolved Oxygen		204.4	%: 204.4 % in data sheet: value not plausible, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == " Kaiserbach_up" & phys_chem$Date == "20/06/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Hainbach_up	21/06/2018	Dissolved Oxygen		306	%: 306 % in data sheet: value not plausible, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Hainbach_up" & phys_chem$Date == "21/06/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Hainbach_up	21/06/2018	Dissolved Oxygen		30.1	mg/L: 30.1 mg/L in data sheet: value not plausible, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Hainbach_up" & phys_chem$Date == "21/06/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Kropsbach_down	21/06/2018	Dissolved Oxygen		124.5	%: 124.5 % in data sheet, not much higher than upper range of 120 %, keep value

* Isenach_down	21/06/2018	Dissolved Oxygen		88	mg/L: 88 mg/L in data sheet: value not plausible, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Isenach_down" & phys_chem$Date == "21/06/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Otterbach_down	29/05/2018	Dissolved Oxygen		216	%: 216 % in data sheet: value not plausible, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Otterbach_down" & phys_chem$Date == "29/05/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Otterbach_down	29/05/2018	Dissolved Oxygen		22.4	mg/L: 22.4 mg/L in data sheet, not much higher than upper range of 20 mg/L, keep value

* Klingbach_up	29/05/2018	Dissolved Oxygen		290	%: 290 % in data sheet: value not plausible, maybe wrong written on sheet or O2 probe not working properly -> do not use value

```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Klingbach_up" & phys_chem$Date == "29/05/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Hainbach_down	24/05/2018	Dissolved Oxygen		144.9	%: 144.9 % in data sheet
```{r, message=FALSE, warning=FALSE}
phys_chem$Value[phys_chem$Site == "Hainbach_down" & phys_chem$Date == "24/05/2018" & phys_chem$Variable == "Dissolved Oxygen"] <- NA
```

* Isenach_down	18/04/2018	conductivity		1023	uS/cm: 1023 uS/cm in data sheet, not much higher than upper range of 1000 uS/cm, keep value

* Isenach_down	21/08/2018	conductivity		1133	uS/cm: 1133 uS/cm in data sheet, not much higher than upper range of 1000 uS/cm, keep value

## Convert time into data format 
```{r, message=FALSE, warning=FALSE}
phys_chem $Date <- as.Date(phys_chem $Date, "%d/%m/%Y")
```
## Rename variables and remove not needed variables
Rename oxygen variables
```{r, message=FALSE, warning=FALSE}
phys_chem$Variable <- as.character(phys_chem$Variable)
phys_chem$Variable[phys_chem$Unit=="%"]  <- "o2_perc"
phys_chem$Variable[phys_chem$Variable=="Dissolved Oxygen"]  <- "o2_mgL"
```
Remove variables weather, time and Flow UFZ, because not used in analysis
```{r, message=FALSE, warning=FALSE}
phys_chem <- filter(phys_chem, Variable != "time",  Variable != "Weather", Variable != "Flow UFZ", Site!="Gruenbach")
```
Remove NA oxygen values, because temperature probe was out of order
```{r, message=FALSE, warning=FALSE}
phys_chem <- filter(phys_chem, Value !="NA")
```
Rename Sites
```{r, message=FALSE, warning=FALSE}
phys_chem$Site <- (gsub("up", "forest", phys_chem$Site))
phys_chem$Site <- (gsub("down", "vine", phys_chem$Site))
```

## Include LOQ 
```{r, message=FALSE, warning=FALSE}
# View(phys_chem[phys_chem$Qualifier=="<" , ])
# View(phys_chem[phys_chem$Qualifier==">" , ])
```

* Take 1/2 of LOQ for values below LOQ
```{r, message=FALSE, warning=FALSE}
phys_chem[phys_chem$Qualifier=="<", "Value"] <- phys_chem[phys_chem$Qualifier=="<", "Value"] /2
phys_chem[phys_chem$Qualifier=="<", "Qualifier"] <- ""
```
* Take 2 times upper LOQ for values above LOQ
```{r, message=FALSE, warning=FALSE}
phys_chem[phys_chem$Qualifier==">", "Value"] <- phys_chem[phys_chem$Qualifier==">", "Value"] *2
phys_chem[phys_chem$Qualifier==">", "Qualifier"] <- ""
```
Add season
* 22 March - 16 May 2018 as spring
* 17 May - 26 July 2018 as summer
* 27 July - 13 2018 September as autumn
```{r, message=FALSE, warning=FALSE}
names(phys_chem)[2] <- c("time")
phys_chem$season <-with(phys_chem, ifelse(time > "2018-03-21" & time <= "2018-05-16","spring",ifelse(time > "2018-05-16" & time <= "2018-07-26","summer","autumn")))
phys_chem$season <- as.factor(phys_chem$season)
```
## Get mean of values per variable
Get mean of values per variable
```{r, message=FALSE, warning=FALSE}
phys_chem_mean <- ddply(phys_chem,c("Site","Variable", "season"),summarise,value_mean=mean(Value))
```
Rows into columns
```{r, message=FALSE, warning=FALSE}
phys_chem_mean <- spread(phys_chem_mean, Variable, value_mean)
```
Rename "water temperature"
```{r, message=FALSE, warning=FALSE}
names(phys_chem_mean)[16] <- c("water_temp")
```
## Check distribution of phys_chem data
```{r, message=FALSE, warning=FALSE}
par(mfrow = c(3,3)) 
for(nam in c(colnames(phys_chem_mean[,3:16]))){ 
    y <- phys_chem_mean[ ,nam] 
    plot(density(y), main = "", xlab = nam) 
    plot(density(sqrt(y)), main= "", xlab = nam) 
    plot(density(log10(y+1)), main = "", xlab = nam)
} 

par(mfrow = c(1, 1))
```
keep all original data, because transformation does not improve distribution much

       
# Habitat parameter
```{r, message=FALSE, warning=FALSE}
habitat <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/land_use_related_drivers_data/habitat.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
```
## Correct mistakes in raw data and convert it into right form
Correct wrong date
```{r, message=FALSE, warning=FALSE}
habitat$Date[habitat$Date == "03/27/2018"] <- "27/03/2018"
habitat$Date[habitat$Date == "03/26/2018"] <- "26/03/2018"
habitat$Date[habitat$Date == "07/03/2018"] <- "03/07/2018"
habitat$Date[habitat$Date == "07/11/2018"] <- "11/07/2018"
habitat$Date[habitat$Date == "07/10/2018"] <- "10/07/2018"
```
Convert date in date format
```{r, message=FALSE, warning=FALSE}
habitat$Date <- as.Date(habitat$Date, "%d/%m/%Y")
```
Change site name
```{r, message=FALSE, warning=FALSE}
habitat $Site <- gsub(" ", "_", habitat$Site)
```
Rename width 1 - 3 variables in width for easier plausibility check
```{r, message=FALSE, warning=FALSE}
habitat$Variable <- as.factor(habitat$Variable)
levels(habitat$Variable)[levels(habitat$Variable)=="width_1"] <- "width"
levels(habitat$Variable)[levels(habitat$Variable)=="width_2"] <- "width"
levels(habitat$Variable)[levels(habitat$Variable)=="width_3"] <- "width"
#levels(habitat$Variable)
```
Rename depth 1 - 3 variables in depth for easier plausibility check
```{r, message=FALSE, warning=FALSE}
habitat$Variable <- as.factor(habitat$Variable)
levels(habitat$Variable)[levels(habitat$Variable)=="depth_1"] <- "depth"
levels(habitat$Variable)[levels(habitat$Variable)=="depth_2"] <- "depth"
levels(habitat$Variable)[levels(habitat$Variable)=="depth_3"] <- "depth"
#levels(habitat$Variable)
```
Convert  banks into numbers
```{r, message=FALSE, warning=FALSE}
#unique(habitat$Value)
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "no"] <- 1
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "rudiments"] <- 2
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "rudiment"] <- 2
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "one"] <- 3
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "eine"] <- 3
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "two"] <- 4
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "zwei"] <- 4
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "several"] <- 5
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "a lot"] <- 6
habitat$Value[habitat$Variable == "Banks" & habitat$Value == "many"] <- 6
```
Convert  Islands/Banks into numbers
```{r, message=FALSE, warning=FALSE}
habitat$Value[habitat$Variable == "Islands/Banks" & habitat$Value == "no"] <- 1
habitat$Value[habitat$Variable == "Islands/Banks" & habitat$Value == "one"] <- 2
habitat$Value[habitat$Variable == "Islands/Banks" & habitat$Value == "eine"] <- 2
habitat$Value[habitat$Variable == "Islands/Banks" & habitat$Value == "several"] <- 3
habitat$Value[habitat$Variable == "Islands/Banks" & habitat$Value == "many"] <- 4
```
Convert  Flooding of shore into numbers
```{r, message=FALSE, warning=FALSE}
habitat$Value[habitat$Variable == "Flooding of shore" & habitat$Value == "no"] <- 2
habitat$Value[habitat$Variable == "Flooding of shore" & habitat$Value == "yes"] <- 1
#unique(habitat$Value)
```
Check NA values
```{r, message=FALSE, warning=FALSE}
habitat_NA_check <- filter(habitat,is.na(habitat$Value))
# remove comments
habitat <- filter(habitat, Variable != "comments")
habitat_NA_check <- filter(habitat,is.na(habitat$Value))
```
Convert values <1 into 1
```{r, message =FALSE, warning= FALSE}
habitat$Qualifier[habitat$Value == "<1"] <- "<"
habitat$Value[habitat$Value == "<1"] <- 1
```
Convert values >1000 and NA/>1000 into 1000
```{r, message =FALSE, warning= FALSE}
habitat$Qualifier[habitat$Value == ">1000"] <- ">"
habitat$Value[habitat$Value == ">1000"] <- 1000

habitat$Qualifier[habitat$Value == "NA/>1000"] <- ">"
habitat$Value[habitat$Value == "NA/>1000"] <- 1000
```
Values to numeric
```{r, message=FALSE, warning=FALSE}
habitat$Value <- as.numeric(habitat$Value) 
```
NA no problem, since really NA

Rename Sites
```{r, message=FALSE, warning=FALSE}
habitat$Site <- (gsub("up", "forest", habitat$Site))
habitat$Site <- (gsub("down", "vine", habitat$Site))
```
Add season
* 22 March - 16 May 2018 as spring
* 17 May - 26 July 2018 as summer
* 27 July - 13 2018 September as autumn
```{r, message=FALSE, warning=FALSE}
names(habitat)[2] <- c("time")
habitat$season <-with(habitat, ifelse(time > "2018-03-21" & time <= "2018-05-16","spring",ifelse(time > "2018-05-16" & time <= "2018-07-26","summer","autumn")))
habitat$season <- as.factor(habitat$season)
```
Traps moved in summer to more shaded area in Kropsbach_vine so put right shading there
```{r, message=FALSE, warning=FALSE}

habitat$Value[habitat$Site == "Kropsbach_vine" & habitat$Variable == "Shading Elements (southwards)" & habitat$time == "2018-08-21"] <- 55

habitat$Value[habitat$Site == "Kropsbach_vine" & habitat$Variable == "Shading Elements (southwards)" & habitat$time == "2018-07-11"] <- 50
```

## Get stream characteristics
Chose only stream width and depth
```{r, message=FALSE, warning=FALSE}
stream_char <- filter(habitat, Variable == "width" | Variable == "depth")
stream_char$Variable <- droplevels(stream_char$Variable)
```
Get column for Stream and position
```{r, message=FALSE, warning=FALSE}
stream_char <- separate(stream_char, "Site", into = c("stream", "position"), sep = "_",remove = FALSE)
```
Get mean and sd of values per position 
```{r, message=FALSE, warning=FALSE}
stream_char <- ddply(stream_char,c("position","Variable"), summarise,value_mean=mean(Value, na.rm = TRUE), value_sd=sd(Value, na.rm = TRUE)) # here also per possible season 
```
cm in m
```{r, message=FALSE, warning=FALSE}
stream_char$value_mean <- round(stream_char$value_mean*(10^-2), digits = 2)
stream_char$value_sd <- round(stream_char$value_sd*(10^-2), digits = 2)
```

## Get mean of values per variable
Get mean of values per variable
```{r, message=FALSE, warning=FALSE}
habitat_mean <- ddply(habitat,c("Site","Variable", "season"),summarise,value_mean=mean(Value, na.rm = TRUE))
```
Rows into columns
```{r, message=FALSE, warning=FALSE}
habitat_mean <- spread(habitat_mean, Variable, value_mean)
```
Rename "Shading Elements (southwards)"
```{r, message=FALSE, warning=FALSE}
names(habitat_mean)[23] <- c("shading")
```
Rename pools and riffles in reach (50m)
```{r, message=FALSE, warning=FALSE}
names(habitat_mean)[21] <- c("pools")
names(habitat_mean)[22] <- c("riffles")
```
## Check distribution of habitat data
```{r, message=FALSE, warning=FALSE}
par(mfrow = c(3,3)) 
for(nam in c(colnames(habitat_mean[,3:23, 25:37]))){ 
    y <- habitat_mean[ ,nam] 
    plot(density(y, na.rm = TRUE), main = "", xlab = nam) 
    plot(density(sqrt(y), na.rm = TRUE), main= "", xlab = nam) 
    plot(density(log10(y+1), na.rm = TRUE), main = "", xlab = nam)
} 

par(mfrow = c(1, 1))
```
keep all original data, because transformation does not improve distribution much

# Pesticide data
## Requiered packages
```{r, message=FALSE, warning=FALSE}
# remotes::install_github('andschar/standartox') # package not yet on CRAN, requires manual installation
library(standartox)
library(EnvStats)
```
# Prepare PSM in water data
## Load data
* method "schoepf": grab samples
* method "eds": event driven samples
* concentration in µg/L
```{r, message=FALSE, warning=FALSE}
psm_conc <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/pesticide_data/3_ANA_ConcentrationTox.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
```
## Chose data from Rhineland Palatinate and 2018
```{r, message=FALSE, warning=FALSE}
psm_conc_RP <- filter(psm_conc, BL == "RP")
psm_conc_RP <- filter(psm_conc_RP, year == "2018")
```
Chose only needed columns
```{r, message=FALSE, warning=FALSE}
psm_conc_RP <- select(psm_conc_RP,-c("dept", "LC50", "organism", "limitation", "lc50_IUPAC_plant", "uba_rak", "tu", "tu_plant", "rak", "lc50_IUPAC_fish", "tu_fish", "concLoq", "BL", "year"))
```
Define sampleDate as date (before Factor)
* put Date into new column "Date"
* important that columns have the same name in all tables, that will be used in later analysis
```{r, message=FALSE, warning=FALSE}
psm_conc_RP$Date <- as.Date(psm_conc_RP$sampleDate,format="%Y-%m-%d")
```

## Add forest samples 
* Triefenbach, Kropsbach, Kaiserbach, Klingbach, Isenach, Modenbach not in 3_ANA table
* Sample from Dierbach in April labeled not correct in in 3_ANA. So sometimes 2 values per substance: Lower concentration belongs to Dierbach up and higher concentration to Dierbach down 

Load samples 
```{r, message=FALSE, warning=FALSE}
psm_forest <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/pesticide_data/samples_forest_2.csv", header = TRUE, sep = ",",na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
```
Long format and name columns
```{r, message=FALSE, warning=FALSE}
psm_forest <- melt(psm_forest, 
                        id.vars = c("labelShort", "siteID", "samplingID",
                                    "sampleDate", "method"))

psm_forest <- filter(psm_forest, variable != "label")

names(psm_forest)[6] <- "subKgM"
names(psm_forest)[7] <- "conc"
```
Correct PSM name
```{r, message=FALSE, warning=FALSE}
psm_forest$subKgM <- gsub("X2_4_D", "2_4_D", psm_forest$subKgM)
psm_forest$subKgM <- gsub("spinosad_D", "spinosad", psm_forest$subKgM)
psm_forest$subKgM <- gsub("spinosad_A", "spinosad", psm_forest$subKgM)
```
Define sampleDate as date 
```{r, message=FALSE, warning=FALSE}
psm_forest$Date <- as.Date(psm_forest$sampleDate,format="%Y-%m-%d")
```
Add column Pesticide.type
```{r, message=FALSE, warning=FALSE}
psm_type <- select(psm_conc, c("Pesticide.type", "subKgM"))
psm_type <- distinct(psm_type)

psm_forest <- left_join(psm_forest, psm_type, by = c("subKgM"))
```
Bind psm_conc_RP and psm_forest
```{r, message=FALSE, warning=FALSE}
psm_conc_RP <- rbind(psm_conc_RP, psm_forest)
```
## Simplify Pesticide.types
```{r}
unique(psm_conc_RP$Pesticide.type)
psm_conc_RP$Pesticide.type <- sub("([A-Za-z]+).*", "\\1",
                                  psm_conc_RP$Pesticide.type)
unique(psm_conc_RP$Pesticide.type)
# two metabolites were wrongly assigned as a herbicides, change type
psm_conc_RP$Pesticide.type <- ifelse(psm_conc_RP$subKgM == "metolachlor_ESA",
                                     "Metabolite", psm_conc_RP$Pesticide.type)
psm_conc_RP$Pesticide.type <- ifelse(psm_conc_RP$subKgM == "captan_THPAM",
                                     "Metabolite", psm_conc_RP$Pesticide.type)

# all which have "NA" as compound type are also metabolites
psm_conc_RP$Pesticide.type <- ifelse(is.na(psm_conc_RP$Pesticide.type),
                                     "Metabolite", psm_conc_RP$Pesticide.type)
unique(psm_conc_RP$Pesticide.type)
```

## Number of analysed compounds/ / pesticides per site and time-point
this needs to be done a) before removing the metabolites and b) the non-detects
number of all analysed compounds
```{r}
count_comp <- psm_conc_RP
count_comp_all <- data.frame(cast(count(count_comp, c("siteID", "subKgM", "sampleDate")), siteID + sampleDate ~  ., value = "subKgM",  length))
```
number of analysed pesticides
```{r}
# remove metabolites
count_comp_PSM <- count_comp[!count_comp$Pesticide.type == "Metabolite", ]

count_comp_allPSM <- data.frame(cast(count(count_comp_PSM, c("siteID", "subKgM", "sampleDate")), siteID + sampleDate  ~  ., value = "subKgM",  length))
```
number of analysed metabolites
```{r}
count_comp_meta <- count_comp[count_comp$Pesticide.type == "Metabolite", ]

count_comp_allmeta <- data.frame(cast(count(count_comp_meta, c("siteID", "subKgM", "sampleDate")), siteID + sampleDate ~  ., value = "subKgM",  length))
```

## Filter for pesticides, remove metabolites
```{r}
psm_conc_RP <- psm_conc_RP[!psm_conc_RP$Pesticide.type == "Metabolite", ]
```

## Remove all non-detects
```{r}
psm_conc_RP <- psm_conc_RP[!psm_conc_RP$conc == "0", ]
psm_conc_RP <- filter(psm_conc_RP, !is.na(conc))
```

## Add CAS numbers
Load in CAS information
```{r}
CAS_KgM <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/pesticide_data/0_ANA_Substances.txt", header = TRUE,sep = "\t", na.strings = c("NR", "NA")) 
```
Merge tables
```{r}
psm_conc_RP <- merge(psm_conc_RP, CAS_KgM, by="subKgM", all.x = TRUE)
```
Variables into factors
```{r, message=FALSE, warning=FALSE}
str(psm_conc_RP)
psm_conc_RP$labelShort <- as.factor(psm_conc_RP$labelShort)
psm_conc_RP$siteID <- as.factor(psm_conc_RP$siteID)
psm_conc_RP$samplingID <- as.factor(psm_conc_RP$samplingID)
psm_conc_RP$sampleDate <- as.factor(psm_conc_RP$sampleDate)
psm_conc_RP$method <- as.factor(psm_conc_RP$method)
psm_conc_RP$subKgM <- as.factor(psm_conc_RP$subKgM)
psm_conc_RP$subDeu <- as.factor(psm_conc_RP$subDeu)
psm_conc_RP$Pesticide.type <- as.factor(psm_conc_RP$Pesticide.type)
```
## Add columns
Site column
```{r, message=FALSE, warning=FALSE}
unique(psm_conc_RP$siteID)
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Kaiser"] <- "Kaiserbach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_KaiserREF"] <- "Kaiserbach_forest"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Ise"] <- "Isenach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_IseREF"] <- "Isenach_forest"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Krops"] <- "Kropsbach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_KropsREF"] <- "Kropsbach_forest"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Trief"] <- "Triefenbach_vine"   
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_TriefREF"] <- "Triefenbach_forest" 
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Moden"] <- "Modenbach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_ModREF"] <- "Modenbach_forest"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Otter"] <- "Otterbach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_OtterREF"] <- "Otterbach_forest"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Kling"] <- "Klingbach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_KlingREF"] <- "Klingbach_forest"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Hain"] <- "Hainbach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_HainREF"] <- "Hainbach_forest"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Russ"] <- "Russbach_vine"        
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_RussREF"] <- "Russbach_forest"   
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_Dier"] <- "Dierbach_vine"
psm_conc_RP$Site[psm_conc_RP$siteID == "RP_DierREF"] <- "Dierbach_forest"
unique(psm_conc_RP$Site)
```
Add stream and position column
```{r, message=FALSE, warning=FALSE}
psm_conc_RP <- separate(psm_conc_RP, Site, c("stream", "position"), sep = "_", remove = FALSE)
```
Define sampleDate as date (before Factor)
* put Date into new column "Date"
* important that columns have the same name in all tables, that will be used in later analysis
```{r, message=FALSE, warning=FALSE}
psm_conc_RP$Date <- as.Date(psm_conc_RP$sampleDate,format="%Y-%m-%d")
```

Add column with season (spring, summer, autumn)

Define seasons:
spiders sampled in:
* spring: 14 - 16 May
* summer: 16 - 19, 23 and 26 July
* autumn: 10 - 13 September

Define seasons for emergence:
* 22 March - 16 May as spring
* 17 May - 26 July as summer
* 27 July - 13 September as autumn

```{r, message=FALSE, warning=FALSE}
psm_conc_RP$season <-with(psm_conc_RP, ifelse(Date > "2018-03-21" & Date <= "2018-05-16","spring",ifelse(Date > "2018-05-16" & Date <= "2018-07-26","summer","autumn")))
psm_conc_RP$season <- as.factor(psm_conc_RP$season)
```

# Toxicity
## PSM in water
### How many samples have been taken per year?
```{r, message=FALSE, warning=FALSE}
length(unique(psm_conc_RP$samplingID)) # 130 samples -> wrong, since 4 samplingIDs used for 2 samples

no_samples <- psm_conc_RP

no_samples <- unite(no_samples, "no_samples", "samplingID", "method", remove = FALSE)
length(unique(no_samples$no_samples)) # 134 samples
length(unique(no_samples$samplingID)) # 130 samples
```
Same sampling ID with different methods
* RP_Russ_20180820_schoepf and RP_Russ_20180820_eds
* RP_Otter_20180820_schoepf and RP_Otter_20180820_eds
* RP_Kling_20180820_schoepf and RP_Kling_20180820_eds
* RP_Kaiser_20180820_schoepf and RP_Kaiser_20180820_eds

Number eds and grab samples
```{r, message=FALSE, warning=FALSE}
no_eds <- filter(psm_conc_RP, method == "eds")
length(unique(no_eds$samplingID)) # 49 eds samples

no_schoepf <- filter(psm_conc_RP, method == "schoepf")
length(unique(no_schoepf$samplingID)) # 85 grab samples
```
Give samples unique samplingID, by changing eds samples ID into ...20180822
```{r, message=FALSE, warning=FALSE}
length(unique(psm_conc_RP$samplingID)) # 130
psm_conc_RP$samplingID <- as.character(psm_conc_RP$samplingID)

psm_conc_RP$samplingID[psm_conc_RP$samplingID == "RP_Russ_20180820" & psm_conc_RP$method == "eds"] <-  "RP_Russ_20180822"

psm_conc_RP$samplingID[psm_conc_RP$samplingID == "RP_Otter_20180820" & psm_conc_RP$method == "eds"] <- "RP_Otter_20180822"

psm_conc_RP$samplingID[psm_conc_RP$samplingID == "RP_Kling_20180820" & psm_conc_RP$method == "eds"] <- "RP_Kling_20180822"
psm_conc_RP$samplingID[psm_conc_RP$samplingID == "RP_Kaiser_20180820" & psm_conc_RP$method == "eds"] <- "RP_Kaiser_20180822"

psm_conc_RP$samplingID <- as.factor(psm_conc_RP$samplingID)
length(unique(psm_conc_RP$samplingID)) # now right: 134
```

### How many compunds have been detected?
#### EDS and schoepf
count number of compounds per pesticide type
```{r, message=FALSE, warning=FALSE}
no_psm_type <- data.frame(cast(psm_conc_RP, samplingID  ~ Pesticide.type, value = "conc",  length))
```
transform in long format
```{r, message=FALSE, warning=FALSE}
no_psm_type_long <- melt(no_psm_type, id.vars=c("samplingID"))
```
violinplot for compounds - all samples
```{r, message=FALSE, warning=FALSE}
types_psm_fig <- 
ggplot(no_psm_type_long, aes(x = variable, y = value)) + 
  geom_violin(trim = FALSE) +
  geom_dotplot(binaxis="y", stackdir="center", dotsize = 0.2, fill = NA) + 
  stat_summary(fun=mean, geom="point", size=1, color="red") +
  labs(title="",x="", y = "number of pesticides in eds and grab samples") +
  theme_classic()+
    theme(axis.text.x = element_text(colour="black", size = 12), axis.ticks.x = element_blank(), 
        axis.text.y = element_text(colour="black", size = 12), 
        legend.position="none", strip.text.x = element_text(face = "bold"), 
        text = element_text(size=14), plot.title = element_text(hjust = 0.5))
types_psm_fig
```
#### EDS
```{r, message=FALSE, warning=FALSE}
no_psm_type2 <- merge(no_psm_type, unique(psm_conc_RP[, c(4,6)]), by = c("samplingID"))
no_psm_type2 <- no_psm_type2[no_psm_type2$method == "eds", ]
no_psm_type2 <- no_psm_type2[,c(1:4)]
```
transform to long
```{r, message=FALSE, warning=FALSE}
no_psm_type2_long <- melt(no_psm_type2, id.vars=c("samplingID"))
```
violinplot
```{r, message=FALSE, warning=FALSE}
ggplot(no_psm_type2_long, aes(x = variable, y = value)) +
    geom_violin(trim = FALSE) +
  geom_dotplot(binaxis="y", stackdir="center", dotsize = 0.2, fill = NA) + 
  stat_summary(fun=mean, geom="point", size=1, color="red") +
  labs(title="",x="", y = "number of pesticides in eds samples") +
  theme_classic()+
    theme(axis.text.x = element_text(colour="black", size = 12), axis.ticks.x = element_blank(),
        axis.text.y = element_text(colour="black", size = 12),
        legend.position="none", strip.text.x = element_text(face = "bold"),
        text = element_text(size=14), plot.title = element_text(hjust = 0.5))
```
#### Schoepf
```{r, message=FALSE, warning=FALSE}
no_psm_type3 <- merge(no_psm_type, unique(psm_conc_RP[, c(4,6)]), by = c("samplingID"))
no_psm_type3 <- no_psm_type3[no_psm_type3$method == "schoepf", ]
no_psm_type3 <- no_psm_type3[,c(1:4)]
```
transform to long
```{r, message=FALSE, warning=FALSE}
no_psm_type3_long <- melt(no_psm_type3, id.vars=c("samplingID"))
```
violinplot
```{r, message=FALSE, warning=FALSE}
ggplot(no_psm_type3_long, aes(x = variable, y = value)) +
    geom_violin(trim = FALSE) +
  geom_dotplot(binaxis="y", stackdir="center", dotsize = 0.2, fill = NA) + 
  stat_summary(fun=mean, geom="point", size=1, color="red") +
  labs(title="",x="", y = "number of pesticides in grab samples") +
  theme_classic()+
    theme(axis.text.x = element_text(colour="black", size = 12), axis.ticks.x = element_blank(),
        axis.text.y = element_text(colour="black", size = 12),
        legend.position="none", strip.text.x = element_text(face = "bold"),
        text = element_text(size=14), plot.title = element_text(hjust = 0.5))
```
#### Per site, method, season (Violinplot) 
```{r, message=FALSE, warning=FALSE}
no_psm <- ddply(psm_conc_RP, c("Site", "method", "samplingID", "season"), summarise, no = length(conc))
```
Set colours: eds = black, schoepf = grey, max = red
```{r, message=FALSE, warning=FALSE}
Vio_no <- no_psm
Vio_no <- separate(Vio_no, "Site", into = c("stream", "position"), sep = "_",remove = FALSE)
Vio_no <- unite(Vio_no, "pos_seas", "position", "season")

Vio_no$colorname <- ifelse(Vio_no$method == "eds", paste("black"), paste("grey75")) 
Vio_no <- Vio_no[order(Vio_no$no),]
Vio_no$shape <- ifelse(Vio_no$pos_seas == "vine_spring", "darkblue", ifelse(Vio_no$pos_seas == "vine_summer", "blue", ifelse(Vio_no$pos_seas == "vine_autumn", "lightblue",ifelse(Vio_no$pos_seas == "forest_spring", "darkgreen", ifelse(Vio_no$pos_seas == "forest_summer", "green", "lightgreen")))))



Vio_no2 <- Vio_no
Vio_no2 <- Vio_no2[order(-Vio_no2$no),]
Vio_no2$max <- !duplicated(Vio_no2$pos_seas) # get max per position and season
Vio_no2$colorname <- ifelse(Vio_no2$max == TRUE, "red", Vio_no2$colorname )
Vio_no3 <- Vio_no2[order(Vio_no2$no),]
```
Plot without max show land use and season
```{r, message=FALSE, warning=FALSE}
Vio_no_fig_wo_max_pos_seas <- 
  ggplot(Vio_no, aes(x = 1, y = no)) + 
    geom_violin(trim=FALSE) +
  ylab("N")+
  xlab("") +
  ggtitle("number detected pesticides")+
  scale_y_continuous(breaks = c(0, 10 ,20, 30, 40, 50, 60), limits = c(-11, 60))+
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, fill=Vio_no$shape,   color = NA)+
   theme_classic()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
        axis.text.y = element_text(colour="black", size = 12), 
        legend.position="none", strip.text.x = element_text(face = "bold"), 
        text = element_text(size=14), plot.title = element_text(hjust = 0.5))
Vio_no_fig_wo_max_pos_seas
```
Plot without max show eds and grab samples
```{r, message=FALSE, warning=FALSE}
Vio_no_fig_wo_max_method <- 
  ggplot(Vio_no, aes(x = 1, y = no)) + 
    geom_violin(trim=FALSE) +
  ylab("N")+
  xlab("") +
  ggtitle("number detected pesticides")+
  scale_y_continuous(breaks = c(0, 10 ,20, 30, 40, 50, 60), limits = c(-11, 60))+
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, fill=Vio_no$colorname,  color = NA)+ 
   theme_classic()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
        axis.text.y = element_text(colour="black", size = 12), 
        legend.position="none", strip.text.x = element_text(face = "bold"), 
        text = element_text(size=14), plot.title = element_text(hjust = 0.5))
Vio_no_fig_wo_max_method # black: eds, grey: grab
```
Plot with max
```{r, message=FALSE, warning=FALSE}
Vio_no_fig_max <- 
  ggplot(Vio_no3, aes(x = 1, y = no)) + 
    geom_violin(trim=FALSE) +
  ylab("N")+
  xlab("") +
  ggtitle("number detected pesticides")+
 scale_y_continuous(breaks = c(0, 10 ,20, 30, 40, 50, 60), limits = c(-11, 60))+
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, fill=Vio_no3$colorname,  color = NA)+ 
   theme_classic()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
        axis.text.y = element_text(colour="black", size = 12), 
        legend.position="none", strip.text.x = element_text(face = "bold"), 
        text = element_text(size=14), plot.title = element_text(hjust = 0.5))
Vio_no_fig_max
```
### Which pesticides detected?
#### EDS and schoepf
```{r, message=FALSE, warning=FALSE}
det_compounds <- as.data.frame(unique(psm_conc_RP$subKgM)) # 66 pesticides
```
#### Schoepf samples
```{r, message=FALSE, warning=FALSE}
psm_conc_RP_grab <- filter(psm_conc_RP, method == "schoepf")
det_compounds_grab <- as.data.frame(unique(psm_conc_RP_grab$subKgM)) # 54 pesticides
```
#### EDS samples
```{r, message=FALSE, warning=FALSE}
psm_conc_RP_eds <- filter(psm_conc_RP, method == "eds")
det_compounds_eds <- as.data.frame(unique(psm_conc_RP_eds$subKgM)) # 64 pesticides
```

## PSM bound on particles in EDS samples
### Load data
You need to replace this line with a path on your computer
```{r, message=FALSE, warning=FALSE}
sed_conc <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/pesticide_data/20191111_KgM_SPM-Extrakte_2018_final_nur_RLP.csv", header = TRUE, sep = ",", na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
# View(sed_conc)

foc <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/pesticide_data/06_Schwebstoffilter GC_LC.csv", header = TRUE, sep = ",", na.strings = c("NR", "NA"), stringsAsFactors = FALSE)
# View(foc)
```
Delete not needed rows
```{r, message=FALSE, warning=FALSE}
sed_conc <- filter(sed_conc, Sample_ID != "can_be_deleted")
foc <- filter(foc, Sample_ID %like% "RP")
```
### Add in foc table missing values

* foc needed to calculate concentration of substances in water
* At some sites values could not be estimated, because weight was too low
* Estimate values at these sites with values of equal sites
* Triefenbach: mean of Modenbach and Hainbach: 0.042+0.121 Anteil_TC_perc_TC
* Isenach: Hainbach(very high carbon content): 0.121 Anteil_TC_perc_TC
* Kropsbach: mean of Otterbach and Hainbach: 0.042+0.121 Anteil_TC_perc_TC

```{r, message=FALSE, warning=FALSE}
foc$Anteil_TC_perc_TC[foc$Sample_ID ==  "RP_Trief_20180409_eds_f_oben__eds_f_20180414_20180417b_WANA"] <- (0.042+0.121)/2

foc$Anteil_TC_perc_TC[foc$Sample_ID == "RP_Krops_20180409_eds_f_unten_oben_eds_f_20180414_20180417b_WANA"] <- (0.042+0.121)/2
  
foc$Anteil_TC_perc_TC[foc$Sample_ID == "RP_Ise_20180409_eds_f_unten_oben_eds_f_20180414_20180417b_WANA"] <- 0.121
```
Values to numeric
```{r, message=FALSE, warning=FALSE}
sed_conc$TOC_weight_mg_TOC <- as.numeric(sed_conc$TOC_weight_mg_TOC)
sed_conc$Allethrin_ng_g_Schwebstoff <- as.numeric(sed_conc$Allethrin_ng_g_Schwebstoff)
sed_conc$Prallethrin_ng_g_Schwebstoff <- as.numeric(sed_conc$Prallethrin_ng_g_Schwebstoff)
sed_conc$Acrinathrin_ng_g_Schwebstoff <- as.numeric(sed_conc$Acrinathrin_ng_g_Schwebstoff)
sed_conc$Permethrin_ng_g_Schwebstoff <- as.numeric(sed_conc$Permethrin_ng_g_Schwebstoff)
sed_conc$Etofenprox_ng_g_Schwebstoff <- as.numeric(sed_conc$Etofenprox_ng_g_Schwebstoff)

foc$Anteil_TC_perc_TC <- as.numeric(foc$Anteil_TC_perc_TC)
foc$Vial <- as.numeric(foc$Vial)
```
Add missing foc values into sed_conc table
```{r, message=FALSE, warning=FALSE}
sed_conc <- select(sed_conc, -c("Sediment_weight_g", "Anteil_TC_perc_TC", "TOC_weight_mg_TOC", "Nummer_Vial_HiWis"))

sed_conc <- left_join(sed_conc, foc, by = "Vial")
```

### Add koc

* koc values for Allethrin, Acrinathrin, Permethrin and Etofenprox taken from PPDB
* koc value for Prallethrin taken from PubChem

```{r, message=FALSE, warning=FALSE}
sed_conc$koc_PPDB_Allethrin <- with(sed_conc, 1400)

sed_conc$koc_PubChem_Prallethrin <- with(sed_conc, 1318)

sed_conc$koc_PPDB_Acrinathrin <- with(sed_conc, 48231)

sed_conc$koc_PPDB_Permethrin  <- with(sed_conc, 100000)

sed_conc$koc_PPDB_Etofenprox <- with(sed_conc, 17757)
```

### Estimate bioavailable dissolved water concentration

* Use equation from Schäfer et al. 2011: Effects of pesticides monitored with three sampling methods...:

$$ c_d = \frac{c_{tot}}{f_{oc} \cdot k_{oc}+1} $$

Variable    | Unit           | Explanation
------------|--------------- | ------------------------------------------
$c_d$       |  ng/mL         | bioavailable dissolved water concentration
$c_{tot}$   |  ng/g          | total concentration in the suspended particles
$f_{oc}$    |  NA            | fraction of organic carbon approximated with TOC
$k_{oc}$    |  mL/g          | soil organic carbon-water partitioning coefficient

```{r, message=FALSE, warning=FALSE}
sed_conc$cd_PPDB_Allethrin_ng_mL <- with(sed_conc, Allethrin_ng_g_Schwebstoff/(Anteil_TC_perc_TC*koc_PPDB_Allethrin+1))

sed_conc$cd_PubChem_Prallethrin_ng_mL <- with(sed_conc, Prallethrin_ng_g_Schwebstoff/(Anteil_TC_perc_TC*koc_PubChem_Prallethrin+1))

sed_conc$cd_PPDB_Acrinathrin_ng_mL <- with(sed_conc, Acrinathrin_ng_g_Schwebstoff/(Anteil_TC_perc_TC*koc_PPDB_Acrinathrin+1))

sed_conc$cd_PPDB_Permethrin_ng_mL <- with(sed_conc, Permethrin_ng_g_Schwebstoff/(Anteil_TC_perc_TC*koc_PPDB_Permethrin+1))

sed_conc$cd_PPDB_Etofenprox_ng_mL <- with(sed_conc, Etofenprox_ng_g_Schwebstoff/(Anteil_TC_perc_TC*koc_PPDB_Etofenprox+1))
```

* ng/mL is the same es µg/L, since 1 ng = 10^-3 µg and 1 mL = 10^-3 L

### Put sed_conc table in form needed to calculate sumTU
Chose needed Variables, use for the moment concentration for Prallethrin calcuated with koc_PubChem_1
```{r, message=FALSE, warning=FALSE}
psm_sed_conc <- select(sed_conc, -c("Vial", "Volume_Event_sample_mL", "Allethrin_ng_g_Schwebstoff", "Prallethrin_ng_g_Schwebstoff", "Acrinathrin_ng_g_Schwebstoff", "Permethrin_ng_g_Schwebstoff", "Etofenprox_ng_g_Schwebstoff", "Nummer_Vial_HiWis", "Sediment_weight_g", "Anteil_TC_perc_TC", "TOC_weight_mg_TOC", "koc_PPDB_Allethrin", "koc_PubChem_Prallethrin", "koc_PPDB_Acrinathrin", "koc_PPDB_Permethrin", "koc_PPDB_Etofenprox"))
```
Concentration and Substance in column
```{r, message=FALSE, warning=FALSE}
colnames_psm_sed_conc <- c(colnames(psm_sed_conc))

colnames_psm_sed_conc <- gsub("cd_PPDB_", "", colnames_psm_sed_conc)
colnames_psm_sed_conc <- gsub("cd_PubChem_", "", colnames_psm_sed_conc)
colnames_psm_sed_conc <- gsub("_ng_mL", "", colnames_psm_sed_conc)

names(psm_sed_conc) <- colnames_psm_sed_conc

psm_sed_conc <- gather(psm_sed_conc, key = "subKgM", value = "conc", 3:7)
```
Remove rows with NA
```{r, message=FALSE, warning=FALSE}
psm_sed_conc <- filter(psm_sed_conc, !is.na(conc))
```
Add CAS
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$CAS <- with(psm_sed_conc, ifelse(subKgM == "Allethrin", 584792, ifelse(subKgM == "Prallethrin", 23031369, ifelse(subKgM == "Acrinathrin", 101007061, ifelse(subKgM == "Permethrin", 52645531, 80844071)))))
```
Add Pesticide.type
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$Pesticide.type <- with(psm_sed_conc, "Insecticide")
```
Add subDeu
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$subDeu <- with(psm_sed_conc, subKgM)
```
Add method
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$method <- with(psm_sed_conc, "eds")
```
Add samplingID
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$samplingID <- with(psm_sed_conc, gsub("_SPM","",psm_sed_conc$Sample_ID.x))
```
Add sample date
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$sampleDate <- with(psm_sed_conc, gsub("[a-zA-Z]","",psm_sed_conc$Sample_ID.x))
psm_sed_conc$sampleDate <- gsub("_","",psm_sed_conc$sampleDate)
psm_sed_conc$sampleDate <- as.Date(psm_sed_conc$sampleDate,format="%Y%m%d")
psm_sed_conc$Date <- as.Date(psm_sed_conc$sampleDate,format="%Y%m%d")
```
Add siteID
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$siteID <- with(psm_sed_conc, gsub("_2018","",psm_sed_conc$samplingID))
psm_sed_conc$siteID <- gsub("[0-9]","",psm_sed_conc$siteID)
```
Add Site
```{r, message=FALSE, warning=FALSE}
unique(psm_sed_conc$siteID)

psm_sed_conc$Site <- with(psm_sed_conc, ifelse(siteID == "RP_Kling", "Klingbach_vine", ifelse(siteID == "RP_Russ", "Russbach_vine", ifelse(siteID == "RP_Krops", "Kropsbach_vine", ifelse(siteID == "RP_Hain", "Hainbach_vine", ifelse(siteID == "RP_Kaiser", "Kaiserbach_vine", ifelse(siteID == "RP_Moden", "Modenbach_vine", "Isenach_vine")))))))
```
Add stream and position column
```{r, message=FALSE, warning=FALSE}
psm_sed_conc <- separate(psm_sed_conc, Site, c("stream", "position"), sep = "_", remove = FALSE)
```
Remove Sample_ID.x and Sample_ID.y
```{r, message=FALSE, warning=FALSE}
psm_sed_conc <- select(psm_sed_conc, -c("Sample_ID.x", "Sample_ID.y"))
```
Add column with season (spring, summer, autumn)

Define seasons:
spiders sampled in:
* spring: 14 - 16 May
* summer: 16 - 19, 23 and 26 July
* autumn: 10 - 13 September

Define seasons for emergence:
* 22 March - 16 May as spring
* 17 May - 26 July as summer
* 27 July - 13 September as autumn

```{r, message=FALSE, warning=FALSE}
psm_sed_conc$season <-with(psm_sed_conc, ifelse(Date > "2018-03-21" & Date <= "2018-05-16","spring",ifelse(Date > "2018-05-16" & Date <= "2018-07-26","summer","autumn")))
psm_sed_conc$season <- as.factor(psm_sed_conc$season)
```

## Combine PSM water and bound on particles
Put variables in psm_sed_conc into same format as in psm_conc_RP
```{r, message=FALSE, warning=FALSE}
psm_sed_conc$siteID <- as.factor(psm_sed_conc$siteID)
psm_sed_conc$samplingID <- as.factor(psm_sed_conc$samplingID)
psm_sed_conc$sampleDate <- as.factor(psm_sed_conc$sampleDate)
psm_sed_conc$method <- as.factor(psm_sed_conc$method)
psm_sed_conc$subKgM <- as.factor(psm_sed_conc$subKgM)
psm_sed_conc$subDeu <- as.factor(psm_sed_conc$subDeu)
psm_sed_conc$Pesticide.type <- as.factor(psm_sed_conc$Pesticide.type)
psm_sed_conc$CAS <- as.integer(psm_sed_conc$CAS)

psm_conc_RP$conc <- as.numeric(psm_conc_RP$conc)
```
Remove labelShort
```{r, message=FALSE, warning=FALSE}
psm_conc_RP <- select(psm_conc_RP, -c("labelShort"))
```
Merge psm_conc_RP and sed_conc tables
```{r, message=FALSE, warning=FALSE}
psm_conc_RP_pyr <- bind_rows(psm_conc_RP, psm_sed_conc)
```

## EC50 with standartox for most sensitive freshwater invertebrate
Get list with CAS numbers to avoid multiple search for same compound
```{r, message =FALSE, warning= FALSE}
CAS_det_comp <- psm_conc_RP_pyr$CAS
CAS_det_comp <- unique(CAS_det_comp)
```
Search for tox data using Standartox 
```{r, message =FALSE, warning= FALSE}
run = FALSE # set to TRUE for the first run, otherwise set FALSE, to avoid multiple runs
if (run) {
  query_st <- stx_query(cas = CAS_det_comp,
                      endpoint = 'XX50',
                      duration = c(24, 96), #acute exposure, cut off at 96h
                      habitat = "freshwater", #avoid marine species --> different sensitivity
                      ecotox_grp = "Invertebrate",  # we concentrate on invertebrates
                      concentration_type = "active ingredient", # formulation conc are not as exact as active ingredient conc
                      concentration_unit = c("ug/l", "ppb"), # both are the same, why do we need this? Standardtox automaticly changes the units to ppb
                      exposure = c("environmental", "aquatic")) #since water is the animals environment
  saveRDS(query_st, file = "KGM_freshwater_invertebrate_XX50.rds")

} else {
  query_st = readRDS(file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/pesticide_data/KGM_freshwater_invertebrate_XX50.rds")
}

# filtered data
query_st_fil <- as.data.frame(query_st$filtered)
```
Remove tests which were identified as an outlier
```{r, message =FALSE, warning= FALSE}
query_st_wo_out <- query_st_fil[query_st_fil$outlier == FALSE,]
```
Remove taxa wrongly added to freshwater 
```{r, message =FALSE, warning= FALSE}
query_st_tax <- query_st_wo_out[!query_st_wo_out$tax_taxon == "Crassostrea virginica",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Americamysis bahia",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Palaemonetes pugio",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Crassostrea gigas",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Artemia salina",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Apis mellifera",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Callinectes sapidus",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Cnaphalocrocis medinalis",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Mytilus edulis",] 
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Mytilus galloprovincialis",]
query_st_tax <- query_st_tax[!query_st_tax$tax_taxon == "Neomysis integer",]
```
Wenn concentration = 0, entfernen
```{r, message =FALSE, warning= FALSE}
range(query_st_tax$concentration) # no concentration = 0
```
Calculate geom_mean per taxon / chemical combination,
cname is substance name for cas number
```{r, message =FALSE, warning= FALSE}
query_st_geom <- ddply(query_st_tax, c("cname", "cas", "tax_taxon"),summarise, EC50 = geoMean(concentration))
```
Select most sensetive taxon per compound 
```{r, message =FALSE, warning= FALSE}
query_st_geom <- as.data.table(query_st_geom)
query_EC50 <- query_st_geom[query_st_geom[ , .I[EC50 == min(EC50)], by = c("cname", "cas")]$V1]
query_EC50$ec50f_ma4896_src <- with(query_EC50, "epa")
```

## Calculate Toxicity
Rename column "cas" in table EC50_ms into "CAS" (needed to merge EC_50 information to psm_conc_RP)
```{r, message=FALSE, warning=FALSE}
EC50_ms<-query_EC50
names(EC50_ms)[2] <- c("CAS")
```
Remove "-" from CAS-Numbers in EC50-table, because in concentration table no "-" and put it into integer -> needed to merge tables
```{r, message=FALSE, warning=FALSE}
EC50_ms$CAS <- gsub("-", "", EC50_ms$CAS)
EC50_ms$CAS <- as.integer(EC50_ms$CAS)
```
Merge EC50 and concentration table
```{r, message=FALSE, warning=FALSE}
tox_ms <- left_join(psm_conc_RP_pyr, EC50_ms, by="CAS")
```
### Missing EC50 values
```{r, message=FALSE, warning=FALSE}
EC50_missing <- filter(tox_ms, is.na(tox_ms$EC50))
EC50_missing <- select(EC50_missing, c("subKgM", "subDeu", "CAS"))
EC50_missing <- distinct(EC50_missing)
```
Load table with EC50 values looked up manually
```{r, message=FALSE, warning=FALSE}
EC50_manually <- read.table("/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/pesticide_data/EC50_version_190326.csv", header = TRUE, sep = ",", na.strings = c("NR", "NA"), stringsAsFactors = FALSE)

EC50_manually <- select(EC50_manually, c("casnr", "subst_name", "ec50f_ma4896_fin", "ec50f_ma4896_tax", "ec50f_ma4896_n", "ec50f_ma4896_src"))

EC50_manually$casnr <- as.integer(EC50_manually$casnr)
EC50_manually$subst_name <- as.factor(EC50_manually$subst_name)

names(EC50_manually)[1] <- c("CAS")
names(EC50_manually)[3] <- c("EC50")
```
Remove non freshwater invertebrates
```{r, message=FALSE, warning=FALSE}
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Crassostrea virginica",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Americamysis bahia",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Palaemonetes pugio",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Crassostrea gigas",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Artemia salina",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Apis mellifera",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Callinectes sapidus",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Cnaphalocrocis medinalis",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Mytilus edulis",] 
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Mytilus galloprovincialis",]
EC50_manually <- EC50_manually[!EC50_manually$ec50f_ma4896_tax == "Neomysis integer",]
```
Merge missing and manual EC50 values
```{r, message=FALSE, warning=FALSE}
EC50_missing <- left_join(EC50_missing, EC50_manually, by = "CAS")

EC50_missing_2 <- filter(EC50_missing, is.na(EC50_missing$EC50))
```
No suitable values found:
* MCPA: only algae and rat found (https://gestis.dguv.de/data?name=010990)
* Metrafenon: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	> 0.92 Daphnia magna (PPDB)
* Propyzamid: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	> 5.6 Daphnia magna (PPDB)
* Diflufenican: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	> 0.24 Daphnia magna (PPDB)
* Tritosulfuron: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	> 100 Daphnia magna (PPDB)
* Quinmerac: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	> 100 Daphnia magna (PPDB)
* Topramezon: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	> 100 Daphnia magna (PPDB)

Suitable values found: 
* Propamocarb: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	106 Daphnia magna (PPDB) -> 106000 µg/L
* Foramsulfuron: Aquatic invertebrates - Acute 48 hour EC₅₀ (mg l⁻¹)	100 Daphnia magna (PPDB) -> 100000 µg/L

Add suitable values
```{r, message=FALSE, warning=FALSE}
EC50_missing$EC50[EC50_missing$subDeu == "Foramsulfuron"] <- 100000
EC50_missing$EC50[EC50_missing$subDeu == "Propamocarb"] <- 106000

EC50_missing$ec50f_ma4896_tax[EC50_missing$subDeu == "Foramsulfuron"] <- "Daphnia magna"
EC50_missing$ec50f_ma4896_tax[EC50_missing$subDeu == "Propamocarb"] <- "Daphnia magna"

EC50_missing$ec50f_ma4896_src[EC50_missing$subDeu == "Foramsulfuron"] <- "ppdb"
EC50_missing$ec50f_ma4896_src[EC50_missing$subDeu == "Propamocarb"] <- "ppdb"

names(EC50_missing)[6] <- c("tax_taxon")
names(EC50_missing)[1] <- c("cname")

EC50_missing <- select(EC50_missing, c("cname", "CAS", "EC50", "tax_taxon", "ec50f_ma4896_src"))

EC50_missing <- filter(EC50_missing, !is.na(EC50))
```
Add EC50_missing to EC50_ms
```{r, message=FALSE, warning=FALSE}
EC50_ms <- bind_rows(EC50_ms, EC50_missing)
```
Add type of pesticide (herbicide, insecticide ....)
```{r, message=FALSE, warning=FALSE}
type_psm <- select(psm_conc_RP_pyr, c("CAS", "Pesticide.type"))
type_psm <- distinct(type_psm)

EC50_SI <- left_join(EC50_ms, type_psm, by = "CAS")
```
Add source in right citation style
```{r, message=FALSE, warning=FALSE}
EC50_SI$ec50f_ma4896_src <- gsub("epa", "Scharmüller et al., 2020; US EPA, 2021", EC50_SI$ec50f_ma4896_src)

EC50_SI$ec50f_ma4896_src <- gsub("ppdb", "Lewis et al., 2016", EC50_SI$ec50f_ma4896_src)

EC50_SI$ec50f_ma4896_src <- gsub("malaj", "Malaj et al., 2014", EC50_SI$ec50f_ma4896_src)
```
Rename columns
```{r, message=FALSE, warning=FALSE}
names(EC50_SI)[1] <- c("Name")
names(EC50_SI)[3] <- c("Taxon")
names(EC50_SI)[4] <- c("EC50 (µg/L)")
names(EC50_SI)[5] <- c("Source")
names(EC50_SI)[6] <- c("Pesticide type")
```
Columns in needed order
```{r, message=FALSE, warning=FALSE}
EC50_SI <- select(EC50_SI, c("Name", "CAS", "Taxon", "EC50 (µg/L)", "Pesticide type", "Source"))
```
Round EC50 on 2 digits
```{r, message=FALSE, warning=FALSE}
EC50_SI$`EC50 (µg/L)` <- round(EC50_SI$`EC50 (µg/L)`, digits = 2)
```
Save EC50_ms as table for SI in paper 
```{r, message=FALSE, warning=FALSE}
#write.csv(EC50_SI, file = "EC50_ms.csv", row.names = FALSE)
```
Merge EC50 with psm_conc_RP_pyr
```{r, message=FALSE, warning=FALSE}
tox_ms <- left_join(psm_conc_RP_pyr, EC50_ms, by="CAS")
```
### Factor of concentration in water and EC50
```{r, message=FALSE, warning=FALSE}
tox_ms$tox_ms_fac <- with(tox_ms, conc/EC50)
```
### TU for each compound (log10 from tox_ms_fac)
```{r, message=FALSE, warning=FALSE}
tox_ms$TU_ms <- with(tox_ms, log10(tox_ms_fac))
```
### sumTU
#### max sumTU per site and season
Get sumTU per Date (meaning per sampling)
```{r, message=FALSE, warning=FALSE}
sumTU_ms_date <- ddply(tox_ms, c("Site","method", "Date"), summarise, sumTU_ms=log10(sum(tox_ms_fac, na.rm = TRUE)))
```

Add season information
```{r, message =FALSE, warning= FALSE}
Date_season <- unique(psm_conc_RP_pyr[,c(8, 14)])
sumTU_ms_date <- merge(sumTU_ms_date, Date_season, by = c("Date"))

length(unique(sumTU_ms_date$sumTU_ms))
```
Take the maximum of each season
```{r, message =FALSE, warning= FALSE}
sumTU <- ddply(sumTU_ms_date, c("Site", "season"), summarise, max_sumTU_ms_pyr = max(sumTU_ms))
```
#### Plot max sumTU
Prepare data
```{r, message =FALSE, warning= FALSE}
sumTU_date <- select(sumTU_ms_date, "Date", "sumTU_ms")
names(sumTU_date)[2] <- c("max_sumTU_ms_pyr")
max_sumTU_date <- left_join(sumTU, sumTU_date, by = "max_sumTU_ms_pyr")

max_sumTU_date <- separate(max_sumTU_date, "Site", into = c("stream", "position"), sep = "_",remove = FALSE)

max_sumTU_date$day <- yday(max_sumTU_date$Date)

max_sumTU_date$position <- gsub("vine","agriculture", max_sumTU_date$position)
max_sumTU_date$position <- factor(max_sumTU_date$position, levels = c("forest", "agriculture"))
```
Plot
```{r, message =FALSE, warning= FALSE}
toxicity_plot_max <- ggplot(max_sumTU_date, aes(x=day, y=max_sumTU_ms_pyr)) + 
  geom_point(aes(col = position)) + 
  scale_color_manual(values=c("darkgreen", "blue")) +
   theme_classic() +
  theme(legend.title = element_blank(), legend.position="bottom") +
  xlab("") +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") + 
  labs( y=expression(maximum ~ sumTU), x=expression(day~of~the~year)) +
  annotate(geom = "text", x = 120, y = 1, label = "spring") +
  annotate(geom = "text", x = 175, y = 1, label = "summer") +
  annotate(geom = "text", x = 225, y = 1, label = "autumn")


#jpeg(filename="toxicity_plot_max.jpg", width=7.5, height=7.5, units="in", res=100)
toxicity_plot_max
#dev.off()
```
### max TU
#### max TU per site and season
Get sumTU per Date (meaning per sampling)
```{r, message=FALSE, warning=FALSE}
maxTU_ms_date <- ddply(tox_ms, c("Site","method", "Date"), summarise, maxTU_ms=(max(TU_ms, na.rm = TRUE)))
```
Add season information
```{r, message =FALSE, warning= FALSE}
Date_season <- unique(psm_conc_RP_pyr[,c(8, 14)])
maxTU_ms_date <- merge(maxTU_ms_date, Date_season, by = c("Date"))

length(unique(maxTU_ms_date$maxTU_ms))
```
Take the maximum of each season
```{r, message =FALSE, warning= FALSE}
maxTU <- ddply(maxTU_ms_date, c("Site", "season"), summarise, max_TU_ms_pyr = max(maxTU_ms))
```
#### Plot max TU
Prepare data
```{r, message =FALSE, warning= FALSE}
maxTU_date <- select(maxTU_ms_date, "Date", "maxTU_ms")
names(maxTU_date)[2] <- c("max_TU_ms_pyr")
maxTU_date <- left_join(maxTU, maxTU_date, by = "max_TU_ms_pyr")

maxTU_date <- separate(maxTU_date, "Site", into = c("stream", "position"), sep = "_",remove = FALSE)

maxTU_date$day <- yday(maxTU_date$Date)

maxTU_date$position <- gsub("vine","agriculture", maxTU_date$position)
maxTU_date$position <- factor(maxTU_date$position, levels = c("forest", "agriculture"))
```
Plot
```{r, message =FALSE, warning= FALSE}
TU_plot_max <- ggplot(maxTU_date, aes(x=day, y=max_TU_ms_pyr)) + 
  geom_point(aes(col = position)) + 
  scale_color_manual(values=c("darkgreen", "blue")) +
   theme_classic() +
  theme(legend.title = element_blank(), legend.position="bottom") +
  xlab("") +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") + 
  labs(y=expression(maximum ~ TU), x=expression(day~of~the~year)) +
  annotate(geom = "text", x = 120, y = 1, label = "spring") +
  annotate(geom = "text", x = 175, y = 1, label = "summer") +
  annotate(geom = "text", x = 225, y = 1, label = "autumn")


#jpeg(filename="plot_max_TU.jpg", width=7.5, height=7.5, units="in", res=100)
TU_plot_max
#dev.off()
```

### Plot sumTU and max TU
Prepare data
```{r, message =FALSE, warning= FALSE}
sumTU_plot <- melt(max_sumTU_date, id=c( "Site", "stream", "position", "season", "Date", "day"))
max_TU_plot <- melt(maxTU_date, id=c("Site", "stream", "position", "season", "Date", "day"))

max_sumTU_plot <- rbind(sumTU_plot, max_TU_plot)

max_sumTU_plot$variable <- gsub("max_sumTU_ms_pyr","maximum sumTU", max_sumTU_plot$variable)

max_sumTU_plot$variable <- gsub("max_TU_ms_pyr","maximum TU", max_sumTU_plot$variable)
```
Plot
```{r, message =FALSE, warning= FALSE}
max_TU_sumTU <- ggplot(max_sumTU_plot, aes(x=day, y=value)) + 
  geom_jitter(aes(col = position, shape = variable, fill = position), size = 5, alpha = 0.5) + 
  scale_color_manual(values=c("darkgreen", "blue")) +
  scale_fill_manual(values = c("darkgreen", "blue")) +
  scale_shape_manual(values = c(21,24)) + 
   theme_classic() +
   theme(legend.title = element_blank(), legend.position="bottom", plot.title = element_text(size=20), legend.text = element_text(size=15), axis.text = element_text(size=15), axis.title = element_text(size=15)) +
  guides(color = guide_legend(override.aes = list(size = 5, shape = c(15,15))), shape = guide_legend(override.aes = list(size=5))) +
  geom_vline(aes(xintercept = 137), linetype = "dashed") +
  geom_vline(aes(xintercept = 211), linetype = "dashed") + 
  labs( y=expression(), x=expression(day~of~the~year)) +
  annotate(geom = "text", x = 120, y = 1, label = "spring", size = 6) +
  annotate(geom = "text", x = 175, y = 1, label = "summer", size = 6) +
  annotate(geom = "text", x = 225, y = 1, label = "autumn", size = 6)


#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/max_TU_sumTU.png", width=7.5, height=7.5, units="in", res=300)
max_TU_sumTU
#dev.off()
```

# Unite habitat_mean, phys_chem_mean, temperature logger and sumTU data
```{r, message=FALSE, warning=FALSE}
env <- left_join(phys_chem_mean, sumTU, by =c("Site", "season"))
env <- left_join(env, habitat_mean, by =c("Site", "season"))
env$Site <- as.factor(env$Site)
```
Put sumTU at sites where no tox was at -7
```{r, message =FALSE, warning= FALSE}
env$max_sumTU_ms_pyr[is.na(env$max_sumTU_ms_pyr)] <- -7
```

# Unite species and environmental data
```{r, message=FALSE, warning=FALSE}
names(biomass_emergence_mean_site)[1] <- c("Site")
biomass_emergence_mean_site$Site <- as.factor(biomass_emergence_mean_site$Site)
data_env <- left_join(biomass_emergence_mean_site,env,by=c("Site", "season"))

names(biomass_emergence_mean_site_order)[1] <- c("Site")
biomass_emergence_mean_site_order$Site <- as.factor(biomass_emergence_mean_site_order$Site)
data_env <- left_join(data_env, biomass_emergence_mean_site_order, by = c("Site", "stream", "position","season"))
```

# Add day of the year for GAM
Get day of the year (convert date into day of year)
```{r, message=FALSE, warning=FALSE}
biomass_emergence_sample$day <- yday(biomass_emergence_sample$time)

biomass_emergence_order_sample$day <- yday(biomass_emergence_order_sample$time)

biomass_emergence_family_sample$day <- yday(biomass_emergence_family_sample$time)
```

# Chose explanatory variables of interest for (G)LMM
## Chose variables
* max_sumTU_ms_pyr
* nutrients: NO3 and PO4
* water temperature
* pools
* conductivity
* other variables not much variability, not of interest or approximated by chosen variables

```{r, message =FALSE, warning= FALSE}
data_env_1 <- select(data_env, c("Site", "stream", "position", "season","biomass_site_mean", "number_site_mean", "biomass_Diptera", "number_Diptera", "biomass_Ephemeroptera", "number_Ephemeroptera", "biomass_Trichoptera", "number_Trichoptera", "biomass_Plecoptera", "number_Plecoptera", "biomass_site_sd", "number_site_sd", "sd_biomass_Diptera", "sd_number_Diptera", "sd_biomass_Ephemeroptera", "sd_number_Ephemeroptera", "sd_biomass_Trichoptera", "sd_number_Trichoptera", "sd_biomass_Plecoptera", "sd_number_Plecoptera","number_EPT", "number_fam", "number_dip", "max_sumTU_ms_pyr", "NO3", "PO4", "water_temp", "pools", "conductivity", "shading", "o2_perc"))

data_env_1$stream <- as.factor(data_env_1$stream)
```

## Plot difference environmental data

* Difference between vine and forest: x = value vine - value forest
* x < 0 higher in forest
* x > 0 higher in agriculture

Prepare data
```{r, message =FALSE, warning= FALSE}
diff <- select(data_env_1, c ("Site", "stream", "position", "season",
                              "max_sumTU_ms_pyr", "NO3", "PO4", "water_temp",
                              "pools", "conductivity", "shading", "o2_perc",
                              "number_EPT", "number_fam", "number_dip"))

diff <- melt(diff, id=c( "Site", "stream", "position", "season"))

diff <- dcast(diff, stream + season + variable ~ position, value.var="value")

diff$difference <- diff$forest - diff$vine

diff <- dcast(diff, stream + season ~ variable, value.var="difference")

diff$season <- factor(diff$season, levels = c("spring", "summer", "autumn"))

diff_mean <- melt(diff, id=c( "stream", "season"))
diff_mean <- ddply(diff_mean,c("variable", "season"),  
                   summarise, mean = round(mean(value), digit = 1), 
                   sd = round(sd(value), digit = 1),  
                   min = round(min(value), digit = 1), 
                   max = round(max(value), digit = 1))
```
### Variables
```{r, message=FALSE, warning=FALSE}
diff_sumTU <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=max_sumTU_ms_pyr), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=max_sumTU_ms_pyr), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=max_sumTU_ms_pyr), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=17), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  labs(title = "Pesticide toxicity (maximum sumTU)", y=expression( )) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_NO3 <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=NO3), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=NO3), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=NO3), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +     
  theme(plot.title = element_text(size=19), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),  axis.title.x = element_blank(), axis.text.x = element_blank()) +
  labs(title = "Nitrate concentration", 
       y=expression("("~mg~ ~mL^-1~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_PO4 <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=PO4), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=PO4), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=PO4), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=19), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_blank(), axis.text.x = element_blank()) +
  labs(title = "Phosphate concentration", y=expression("("~mg~ ~mL^-1~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_water_temp <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=water_temp), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=water_temp), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=water_temp), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +     
  theme(plot.title = element_text(size=19), axis.text.y = element_text(size=15), axis.title.y = element_text(size=15),  axis.title.x = element_blank(), axis.text.x = element_blank()) +
  labs(title = "Water temperature", y=expression("("~"°"~C~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_cond <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=conductivity), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=conductivity), binaxis="y", stackdir="center", dotsize = 1.5, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=conductivity), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=19), axis.text = element_text(size=15), axis.title.y = element_text(size=15),  axis.title.x =element_blank()) +
  labs(title = "Electrical conductivity (EC)", y=expression("("~"µ"~S~ ~cm^-1~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_pool <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=pools), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=pools), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=pools), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=19), axis.text = element_text(size=15), axis.title.y = element_text(size=15),  axis.title.x =element_blank()) +
  labs(title = "Pool habitats", y=expression("("~"%"~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_O2 <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=o2_perc), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=o2_perc), binaxis="y", stackdir="center", dotsize = 1.5, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=o2_perc), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=19), axis.text = element_text(size=15), axis.title.y = element_text(size=15),  axis.title.x =element_blank()) +
  labs(title = "Oxygen saturation", y=expression("("~"%"~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_shade <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=shading), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=shading), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=shading), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +     
  theme(plot.title = element_text(size=19), axis.text = element_text(size=15), axis.title.y = element_text(size=15),  axis.title.x =element_blank()) +
  labs(title = "Shading", y=expression("("~"%"~")")) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

plot_diff <- ggarrange(diff_sumTU, diff_water_temp, 
                          diff_NO3, diff_PO4, diff_cond,
                          diff_shade, diff_O2, diff_pool,   
                  labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)","(h)"),
                  font.label = list(face = "bold"),
                  ncol = 4, nrow = 2, align = "v")

plot_diff <- annotate_figure(plot_diff, top = text_grob(" ", face = "bold", size = 50))

plot_diff <- annotate_figure(plot_diff, fig.lab = ("Differences in land use related drivers between forested and agricultural sites"), fig.lab.pos = "top.left", fig.lab.size = 25, fig.lab.face = "bold")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/diff_plot.png", width=20, height=10, units="in", res=300)
plot_diff
#dev.off()
```

### EPT
```{r, message=FALSE, warning=FALSE}
diff_EPT <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=number_EPT), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=number_EPT), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=number_EPT), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
     theme(plot.title = element_text(size=20), axis.text = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_blank()) +
  labs(title = "Number mayfly, stonefly and\ncaddisfly (EPT) families", y="") +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_EPT
```

### Diptera
```{r, message=FALSE, warning=FALSE}
diff_dip <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=number_dip), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=number_dip), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=number_dip), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
     theme(plot.title = element_text(size=20), axis.text = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_blank()) +
  labs(title = "Number fly families", y=expression(Difference~ between~ forest~ and~ agriculture)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_dip
```

### Families
```{r, message=FALSE, warning=FALSE}
diff_fam <- ggplot() +
  geom_violin(data=diff, aes(x=season, y=number_fam), trim = FALSE) +
   geom_dotplot(data=diff, aes(x=season, y=number_fam), binaxis="y", stackdir="center", dotsize = 2, fill = NA) +
  stat_summary(data=diff, aes(x=season, y=number_fam), fun=mean, geom="point", size=6, color="red", alpha = 0.7) +
  theme_classic() +
     theme(plot.title = element_text(size=20), axis.text = element_text(size=15), axis.title.y = element_text(size=15), axis.title.x = element_blank()) +
  labs(title = "Number all families", y=expression(Difference~ between~ forest~ and~ agriculture)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed")

diff_fam

plot_diff_fam_ept <- ggarrange(diff_fam, diff_EPT, diff_dip,   
                  labels = c("(a)", "(b)", "(c)"),
                  font.label = list(face = "bold"),
                  ncol = 2, nrow = 2, align = "hv")

#png(filename="/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/diff_fam_ept.png", width=10, height=10, units="in", res=300)
plot_diff_fam_ept
#dev.off()
```

# Export range and mean of environmental variables used in statistics
```{r, message =FALSE, warning= FALSE}
range_env_all <- data_env[,c(1:4,11:60)]
str(range_env_all)

range_env_all <- melt(range_env_all, id.vars=c("Site", "stream", "position","season"))
str(range_env_all)

range_env_all <- ddply(range_env_all, c("position","variable"), summarise, mean = round(mean(value, na.rm = TRUE), digit = 1), min = round(min(value, na.rm = TRUE), digit = 1), max = round(max(value, na.rm = TRUE), digit = 1)) # no agriculture and fallow in forest so no mean, max and min available -> set manually to 0 in document

range_env_all <- unite(range_env_all, "range_1", "min", "max", remove = TRUE, sep = "-")
range_env_all$a <- "("
range_env_all <- unite(range_env_all, "range_2", "a", "range_1",remove = TRUE, sep = "")
range_env_all$a <- ")"
range_env_all <- unite(range_env_all, "range", "range_2", "a", remove = TRUE, sep = "")
range_env_all <- unite(range_env_all, "mean_range", "mean", "range", remove = TRUE, sep = " ")

unit_habitat <- select(habitat, c("Unit", "Variable"))
unit_habitat <- distinct(unit_habitat)

unit_phys_chem <- select(phys_chem, c("Unit", "Variable"))
unit_phys_chem <- distinct(unit_phys_chem)

unit_habitat$Unit[unit_habitat$Variable == "Banks"] <- "1 – 6 (no – many)"
unit_habitat$Unit[unit_habitat$Variable == "Flooding of shore"] <- "1 – 2 (yes, no)"
unit_habitat$Unit[unit_habitat$Variable == "Islands/Banks"] <- "1 – 4 (no – many)"
unit_habitat$Unit[unit_habitat$Variable == "curvature"] <- "1 – 7 (meandering – linear)"

Variable <- c("max_sumTU_ms_pyr", "water_temp", "pools", "riffles", "shading")
Variable <- as.data.frame(Variable)
Unit <- c("Maximum of logarithmic sum of toxic unit for the most sensitive freshwater invertebrate species", "°C", "%", "%", "%")
Unit <- as.data.frame(Unit)
tox_unit_var <- cbind(Variable, Unit)

unit <- rbind(unit_habitat, unit_phys_chem)
unit <- rbind(unit, tox_unit_var)

names(unit)[2] <- c("variable")

range_env_all <- left_join(range_env_all, unit, by = "variable")

unique(range_env_all$variable)

range_env_all$variable <- gsub("land ", "Land ", range_env_all$variable)
range_env_all$variable <- gsub("height ", "Height ", range_env_all$variable)
range_env_all$variable <- gsub("distance ", "Distance ", range_env_all$variable)

range_env_all$variable <- gsub("shore ", "Shore ", range_env_all$variable)
range_env_all$variable <- gsub("shading", "Shading", range_env_all$variable)
range_env_all$variable <- gsub("air temperature", "Air temperature (1)", range_env_all$variable)
range_env_all$variable <- gsub("Cl", "Chloride (2)", range_env_all$variable)
range_env_all$variable <- gsub("conductivity", "Electrical conductivity (1)", range_env_all$variable)
range_env_all$variable <- gsub("Cu", "Copper (2)", range_env_all$variable)
range_env_all$variable <- gsub("NH4", "Ammonium (2)", range_env_all$variable)
range_env_all$variable <- gsub("NO2", "Nitrite (2)", range_env_all$variable)
range_env_all$variable <- gsub("NO3", "Nitrate (2)", range_env_all$variable)
range_env_all$variable <- gsub("o2_mgL", "Oxygen (1)", range_env_all$variable)
range_env_all$variable <- gsub("o2_perc", "Oxygen saturation (1)", range_env_all$variable)
range_env_all$variable <- gsub("PO4", "Phosphate (2)", range_env_all$variable)
range_env_all$variable <- gsub("SO4", "Sulfate (2)", range_env_all$variable)
range_env_all$variable <- gsub("water_temp", "Water temperature (1)", range_env_all$variable)
range_env_all$variable <- gsub("max_sumTU_ms_pyr", "Pesticide toxicity", range_env_all$variable)
range_env_all$variable <- gsub("curvature", "Curvature", range_env_all$variable)
range_env_all$variable <- gsub("depth" , "Depth", range_env_all$variable)
range_env_all$variable <- gsub("riffles", "Riffles", range_env_all$variable)
range_env_all$variable <- gsub("pools", "Pools", range_env_all$variable)
range_env_all$variable <- gsub("max_width", "Maximum width", range_env_all$variable)
range_env_all$variable <- gsub("min_width", "Minimum width", range_env_all$variable)
range_env_all$variable <- gsub("Flow", "Flow (3)", range_env_all$variable)
range_env_all$variable <- gsub("width", "Width", range_env_all$variable)   

range_env_all <- dcast(range_env_all, variable + Unit ~ position, value.var="mean_range")

range_env_glmm <- filter(range_env_all, variable %in% c("Pesticide toxicity", "Nitrate (2)", "Phosphate (2)", "Water temperature (1)", "Pools", "Electrical conductivity (1)", "Shading", "Oxygen saturation (1)"))

names(range_env_all)[1] <- c("Land use related driver")
names(range_env_all)[3] <- c("Forest: mean and range")
names(range_env_all)[4] <- c("Agriculture: mean and range")

names(range_env_glmm)[1] <- c("Land use related driver")
names(range_env_glmm)[3] <- c("Forest: mean and range")
names(range_env_glmm)[4] <- c("Agriculture: mean and range")

#write.csv(range_env_all, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/range_env_all.csv", row.names = FALSE)
#write.csv(range_env_glmm, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/range_env_glmm.csv", row.names = FALSE)
```

# Save data for statistics
## HGAM
```{r, message =FALSE, warning= FALSE}
#write.csv(biomass_emergence_sample, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_emergence_sample.csv", row.names = FALSE)

#write.csv(biomass_emergence_order_sample, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_emergence_order_sample.csv", row.names = FALSE)

#write.csv(biomass_emergence_family_sample, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/biomass_emergence_family_sample.csv", row.names = FALSE)
```
## (G)LMM
```{r, message =FALSE, warning= FALSE}
#write.csv(data_env_1, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/data_env_1.csv", row.names = FALSE)
```
## Paired t-test
```{r, message =FALSE, warning= FALSE}
#write.csv(trait_data, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/trait_data.csv", row.names = FALSE)
#write.csv(trait_data_diff, file = "/Users/katharinafrisch/Nextcloud/Uni/Paper/Biomass Paper/GCB_submission/3_accepted/ohler_biomass/data_preparation/trait_data_diff.csv", row.names = FALSE)
```